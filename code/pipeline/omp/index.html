
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../images/logo.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>OMP - coppafish</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coppafish.pipeline.omp.call_spots_omp" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="coppafish" class="md-header__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            coppafish
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OMP
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../config_setup/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../pipeline/overview/" class="md-tabs__link">
        Pipeline
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../setup/notebook/" class="md-tabs__link md-tabs__link--active">
        Code
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="coppafish" class="md-nav__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    coppafish
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config_setup/" class="md-nav__link">
        Setting up the Config File
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../run_code/" class="md-nav__link">
        Running the code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../view_results/" class="md-nav__link">
        Viewing the results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config/" class="md-nav__link">
        Config Default Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook_comments/" class="md-nav__link">
        Notebook Comments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/extract/" class="md-nav__link">
        Extract and Filter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/tile_details/" class="md-nav__link">
        Tile Detail
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/file_names/" class="md-nav__link">
        File Names
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Extract
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extract" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Extract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/deconvolution/" class="md-nav__link">
        Deconvolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/fstack/" class="md-nav__link">
        Fstack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/scale/" class="md-nav__link">
        Scale
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Find Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Find Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Find Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/check_spots/" class="md-nav__link">
        Check Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/detect/" class="md-nav__link">
        Detect
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Stitch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Stitch" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Stitch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/shift/" class="md-nav__link">
        Shift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/starting_shifts/" class="md-nav__link">
        Starting Shifts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/tile_origin/" class="md-nav__link">
        Tile Origin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/check_shifts/" class="md-nav__link">
        Check Shifts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Register
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Register" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Register
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/check_transforms/" class="md-nav__link">
        Check Transforms
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Spot Colors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Spot Colors" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Spot Colors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spot_colors/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_7">
          Call Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Call Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          Call Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/background/" class="md-nav__link">
        Background
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/bleed_matrix/" class="md-nav__link">
        Bleed Matrix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/dot_product/" class="md-nav__link">
        Dot Product
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/qual_check/" class="md-nav__link">
        Quality Check
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_8" type="checkbox" id="__nav_4_8" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_8">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OMP" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          OMP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/coefs/" class="md-nav__link">
        Coefficients
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/spots/" class="md-nav__link">
        Spots
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_9" type="checkbox" id="__nav_4_9" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_9">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_9">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../run/" class="md-nav__link">
        Run
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../basic_info/" class="md-nav__link">
        Basic Info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extract_run/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        OMP
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coppafish.pipeline.omp.call_spots_omp" class="md-nav__link">
    call_spots_omp()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_10" type="checkbox" id="__nav_4_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_10">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_10">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/pciseq/" class="md-nav__link">
        pciSeq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/matlab/" class="md-nav__link">
        Matlab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/morphology/" class="md-nav__link">
        Morphology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/nd2/" class="md-nav__link">
        nd2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/npy/" class="md-nav__link">
        npy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/strel/" class="md-nav__link">
        Strel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_11" type="checkbox" id="__nav_4_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_11">
          Plot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_11">
          <span class="md-nav__icon md-icon"></span>
          Plot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/viewer/" class="md-nav__link">
        Viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/raw/" class="md-nav__link">
        Raw
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/extract/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/call_spots/" class="md-nav__link">
        Call Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_12" type="checkbox" id="__nav_4_12" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_12">
          Separate Round Registration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Separate Round Registration" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_12">
          <span class="md-nav__icon md-icon"></span>
          Separate Round Registration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sep_round_reg/" class="md-nav__link">
        Sep round reg
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coppafish.pipeline.omp.call_spots_omp" class="md-nav__link">
    call_spots_omp()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/jduffield65/coppafish/edit/master/docs/code/pipeline/omp.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>OMP</h1>

<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="coppafish.pipeline.omp.call_spots_omp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">call_spots_omp</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">nbp_file</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="p">,</span> <span class="n">nbp_call_spots</span><span class="p">,</span> <span class="n">tile_origin</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">shape_tile</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This runs orthogonal matching pursuit (omp) on every pixel to determine a coefficient for each gene at each pixel.</p>
<p>From these gene coefficient images, a local maxima search is performed to find the position of spots for each gene.
Various properties of the spots are then saved to determine the likelihood that the gene assignment is legitimate.</p>
<p>See <code>'omp'</code> section of <code>notebook_comments.json</code> file for description of the variables in the omp page.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>Dictionary obtained from <code>'omp'</code> section of config file.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nbp_file</code></td>
          <td>
                <code><span title="coppafish.setup.notebook.NotebookPage">NotebookPage</span></code>
          </td>
          <td><p><code>file_names</code> notebook page</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nbp_basic</code></td>
          <td>
                <code><span title="coppafish.setup.notebook.NotebookPage">NotebookPage</span></code>
          </td>
          <td><p><code>basic_info</code> notebook page</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nbp_call_spots</code></td>
          <td>
                <code><span title="coppafish.setup.notebook.NotebookPage">NotebookPage</span></code>
          </td>
          <td></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_origin</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_tiles x 3]</code>.
<code>tile_origin[t,:]</code> is the bottom left yxz coordinate of tile <code>t</code>.
yx coordinates in <code>yx_pixels</code> and z coordinate in <code>z_pixels</code>.
This is saved in the <code>stitch</code> notebook page i.e. <code>nb.stitch.tile_origin</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>transform</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_tiles x n_rounds x n_channels x 4 x 3]</code>.
<code>transform[t, r, c]</code> is the affine transform to get from tile <code>t</code>, <code>ref_round</code>, <code>ref_channel</code> to
tile <code>t</code>, round <code>r</code>, channel <code>c</code>.
This is saved in the register notebook page i.e. <code>nb.register.transform</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>shape_tile</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>Tile to use to compute the expected shape of a spot in the gene coefficient images.
Should be the tile, for which the most spots where found in the <code>call_reference_spots</code> step.
If <code>None</code>, will be set to the centre tile.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="coppafish.setup.notebook.NotebookPage">NotebookPage</span></code>
          </td>
          <td><p><code>NotebookPage[omp]</code> - Page contains gene assignments and info for spots using omp.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/pipeline/omp.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">call_spots_omp</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">nbp_file</span><span class="p">:</span> <span class="n">NotebookPage</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="p">:</span> <span class="n">NotebookPage</span><span class="p">,</span>
                   <span class="n">nbp_call_spots</span><span class="p">:</span> <span class="n">NotebookPage</span><span class="p">,</span> <span class="n">tile_origin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                   <span class="n">transform</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape_tile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NotebookPage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This runs orthogonal matching pursuit (omp) on every pixel to determine a coefficient for each gene at each pixel.</span>

<span class="sd">    From these gene coefficient images, a local maxima search is performed to find the position of spots for each gene.</span>
<span class="sd">    Various properties of the spots are then saved to determine the likelihood that the gene assignment is legitimate.</span>

<span class="sd">    See `&#39;omp&#39;` section of `notebook_comments.json` file for description of the variables in the omp page.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Dictionary obtained from `&#39;omp&#39;` section of config file.</span>
<span class="sd">        nbp_file: `file_names` notebook page</span>
<span class="sd">        nbp_basic: `basic_info` notebook page</span>
<span class="sd">        nbp_call_spots:</span>
<span class="sd">        tile_origin: `float [n_tiles x 3]`.</span>
<span class="sd">            `tile_origin[t,:]` is the bottom left yxz coordinate of tile `t`.</span>
<span class="sd">            yx coordinates in `yx_pixels` and z coordinate in `z_pixels`.</span>
<span class="sd">            This is saved in the `stitch` notebook page i.e. `nb.stitch.tile_origin`.</span>
<span class="sd">        transform: `float [n_tiles x n_rounds x n_channels x 4 x 3]`.</span>
<span class="sd">            `transform[t, r, c]` is the affine transform to get from tile `t`, `ref_round`, `ref_channel` to</span>
<span class="sd">            tile `t`, round `r`, channel `c`.</span>
<span class="sd">            This is saved in the register notebook page i.e. `nb.register.transform`.</span>
<span class="sd">        shape_tile: Tile to use to compute the expected shape of a spot in the gene coefficient images.</span>
<span class="sd">            Should be the tile, for which the most spots where found in the `call_reference_spots` step.</span>
<span class="sd">            If `None`, will be set to the centre tile.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `NotebookPage[omp]` - Page contains gene assignments and info for spots using omp.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nbp</span> <span class="o">=</span> <span class="n">NotebookPage</span><span class="p">(</span><span class="s2">&quot;omp&quot;</span><span class="p">)</span>

    <span class="c1"># use bled_codes with gene efficiency incorporated and only use_rounds/channels</span>
    <span class="n">rc_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">nbp_call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">rc_ind</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">check_color_nan</span><span class="p">(</span><span class="n">bled_codes</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="p">)</span>
    <span class="n">norm_bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bled_codes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm_bled_codes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nbp_call_spots.bled_codes_ge don&#39;t all have an L2 norm of 1 over &quot;</span>
                         <span class="s2">&quot;use_rounds and use_channels.&quot;</span><span class="p">)</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bled_codes</span><span class="p">)</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
    <span class="n">color_norm_factor</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nbp_call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">rc_ind</span><span class="p">])</span>
    <span class="n">n_genes</span><span class="p">,</span> <span class="n">n_rounds_use</span><span class="p">,</span> <span class="n">n_channels_use</span> <span class="o">=</span> <span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dp_norm_shift</span> <span class="o">=</span> <span class="n">nbp_call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_rounds_use</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">is_3d</span><span class="p">:</span>
        <span class="n">detect_radius_z</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;radius_z&#39;</span><span class="p">]</span>
        <span class="n">n_z</span> <span class="o">=</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">nz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">detect_radius_z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">n_z</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_z</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">use_z_oob</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">n_z</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_z_oob</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">OutOfBoundsError</span><span class="p">(</span><span class="s2">&quot;use_z&quot;</span><span class="p">,</span> <span class="n">use_z_oob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># use consecutive values if only 2 given.</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">use_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_z&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_z</span><span class="p">)</span>

    <span class="c1"># determine initial_intensity_thresh from average intensity over all pixels on central z-plane.</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">initial_intensity_thresh</span> <span class="o">=</span> <span class="n">omp</span><span class="o">.</span><span class="n">get_initial_intensity_thresh</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">nbp_call_spots</span><span class="p">)</span>

    <span class="n">use_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_shape</span><span class="p">):</span>
        <span class="c1"># Set tile order so do shape_tile first to compute spot_shape from it.</span>
        <span class="k">if</span> <span class="n">shape_tile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape_tile</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">central_tile</span><span class="p">(</span><span class="n">nbp_basic</span><span class="o">.</span><span class="n">tilepos_yx</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shape_tile</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape_tile, </span><span class="si">{</span><span class="n">shape_tile</span><span class="si">}</span><span class="s2"> is not in nbp_basic.use_tiles, </span><span class="si">{</span><span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shape_tile_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="p">)</span> <span class="o">==</span> <span class="n">shape_tile</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">use_tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">use_tiles</span><span class="p">[</span><span class="n">shape_tile_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_tiles</span><span class="p">[</span><span class="n">shape_tile_ind</span><span class="p">],</span> <span class="n">use_tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spot_shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nbp</span><span class="o">.</span><span class="n">shape_tile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nbp</span><span class="o">.</span><span class="n">shape_spot_local_yxz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nbp</span><span class="o">.</span><span class="n">shape_spot_gene_no</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nbp</span><span class="o">.</span><span class="n">spot_shape_float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># -1 because saved as uint16 so convert 0, 1, 2 to -1, 0, 1.</span>
        <span class="n">spot_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_shape</span><span class="p">)</span>  <span class="c1"># Put z to last index</span>
        <span class="k">if</span> <span class="n">spot_shape</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">spot_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">spot_shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Put z to last index</span>

    <span class="c1"># Deal with case where algorithm has been run for some tiles and data saved</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spot_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;OMP information already exists for some tiles but spot_shape tiff file does not:</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_shape</span><span class="si">}</span><span class="se">\n</span><span class="s1">Either add spot_shape tiff or delete the files:</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">spot_coefs</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">load_npz</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">)</span>
        <span class="n">spot_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spot_coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">spot_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># Case where bugged out after saving spot_coefs but before saving spot_info, delete all excess spot_coefs.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Have spot_coefs for </span><span class="si">{</span><span class="n">spot_coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> spots but only spot_info for </span><span class="si">{</span><span class="n">spot_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot; spots.</span><span class="se">\n</span><span class="s2">So deleting the excess spot_coefs and re-saving to </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">spot_coefs</span> <span class="o">=</span> <span class="n">spot_coefs</span><span class="p">[:</span><span class="n">spot_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">sparse</span><span class="o">.</span><span class="n">save_npz</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">,</span> <span class="n">spot_coefs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">spot_coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">spot_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># If more spots in info than coefs then likely because duplicates removed from coefs but not spot_info.</span>
            <span class="n">not_duplicate</span> <span class="o">=</span> <span class="n">get_non_duplicate</span><span class="p">(</span><span class="n">tile_origin</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">tile_centre</span><span class="p">,</span>
                                              <span class="n">spot_info</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">spot_info</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">not_duplicate</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">spot_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There were less spots in</span><span class="se">\n</span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="si">}</span><span class="se">\n</span><span class="s1">than</span><span class="se">\n</span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="si">}</span><span class="s1"> &#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;because duplicates were deleted for spot_coefs but not for spot_info.</span><span class="se">\n</span><span class="s1">&#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;Now, spot_info duplicates have also been deleted.&#39;</span><span class="p">)</span>
                <span class="n">spot_info</span> <span class="o">=</span> <span class="n">spot_info</span><span class="p">[</span><span class="n">not_duplicate</span><span class="p">]</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">,</span> <span class="n">spot_info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Have spot_info for </span><span class="si">{</span><span class="n">spot_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> spots but only spot_coefs for &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spot_coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">Need to delete both </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="si">}</span><span class="s2"> and &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="si">}</span><span class="s2"> to get past this error.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev_found_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spot_info</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">use_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">use_tiles</span><span class="p">,</span> <span class="n">prev_found_tiles</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Already have OMP results for tiles </span><span class="si">{</span><span class="n">prev_found_tiles</span><span class="si">}</span><span class="s1"> so now just running on tiles &#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">use_tiles</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">spot_coefs</span><span class="p">,</span> <span class="n">spot_info</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">):</span>
        <span class="c1"># If only have information only file but not the other, need to delete all files and start again.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The file </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="si">}</span><span class="s1"> exists but the file </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="si">}</span><span class="s1"> does not.</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;Delete or re-name the file </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="si">}</span><span class="s1"> to run omp part from scratch.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The file </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="si">}</span><span class="s1"> exists but the file </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="si">}</span><span class="s1"> does not.</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;Delete or re-name the file </span><span class="si">{</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="si">}</span><span class="s1"> to run omp part from scratch.&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Finding OMP coefficients for all pixels on tiles </span><span class="si">{</span><span class="n">use_tiles</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
    <span class="n">initial_pos_neighbour_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;initial_pos_neighbour_thresh&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">use_tiles</span><span class="p">:</span>
        <span class="n">pixel_yxz_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">pixel_coefs_t</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_genes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">use_z</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tile </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_tiles</span> <span class="o">==</span> <span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">use_tiles</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot; Z-plane </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_z</span> <span class="o">==</span> <span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">use_z</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># While iterating through tiles, only save info for rounds/channels using</span>
            <span class="c1"># - add all rounds/channels back in later. This returns colors in use_rounds/channels only and no invalid.</span>
            <span class="n">pixel_colors_tz</span><span class="p">,</span> <span class="n">pixel_yxz_tz</span> <span class="o">=</span> <span class="n">get_spot_colors</span><span class="p">(</span><span class="n">all_pixel_yxz</span><span class="p">(</span><span class="n">nbp_basic</span><span class="o">.</span><span class="n">tile_sz</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">tile_sz</span><span class="p">,</span>
                                                                          <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">transform</span><span class="p">,</span>
                                                            <span class="n">nbp_file</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="p">,</span> <span class="n">return_in_bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pixel_colors_tz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">pixel_colors_tz</span> <span class="o">=</span> <span class="n">pixel_colors_tz</span> <span class="o">/</span> <span class="n">color_norm_factor</span>

            <span class="c1"># Only keep pixels with significant absolute intensity to save memory.</span>
            <span class="c1"># absolute because important to find negative coefficients as well.</span>
            <span class="c1"># pixel_intensity_tz = get_spot_intensity(jnp.abs(pixel_colors_tz))</span>
            <span class="n">pixel_intensity_tz</span> <span class="o">=</span> <span class="n">get_spot_intensity</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pixel_colors_tz</span><span class="p">))</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">pixel_intensity_tz</span> <span class="o">&gt;</span> <span class="n">nbp</span><span class="o">.</span><span class="n">initial_intensity_thresh</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">pixel_colors_tz</span> <span class="o">=</span> <span class="n">pixel_colors_tz</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
            <span class="n">pixel_yxz_tz</span> <span class="o">=</span> <span class="n">pixel_yxz_tz</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">pixel_intensity_tz</span><span class="p">,</span> <span class="n">keep</span>

            <span class="n">pixel_coefs_tz</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span>
                <span class="n">omp</span><span class="o">.</span><span class="n">get_all_coefs</span><span class="p">(</span><span class="n">pixel_colors_tz</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">,</span>
                                  <span class="n">nbp_call_spots</span><span class="o">.</span><span class="n">background_weight_shift</span><span class="p">,</span> <span class="n">dp_norm_shift</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dp_thresh&#39;</span><span class="p">],</span>
                                  <span class="n">config</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_genes&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;weight_coef_fit&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">pixel_colors_tz</span>
            <span class="c1"># Only keep pixels for which at least one gene has non-zero coefficient.</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pixel_coefs_tz</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># nonzero as is sparse matrix.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># TODO: check order of np.asarray and keep, which is quicker - think this is quickest though</span>
            <span class="n">pixel_yxz_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixel_yxz_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pixel_yxz_tz</span><span class="p">[</span><span class="n">keep</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">pixel_yxz_tz</span>
            <span class="n">pixel_coefs_t</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pixel_coefs_t</span><span class="p">,</span> <span class="n">pixel_coefs_tz</span><span class="p">[</span><span class="n">keep</span><span class="p">]))</span>
            <span class="k">del</span> <span class="n">pixel_coefs_tz</span><span class="p">,</span> <span class="n">keep</span>

        <span class="k">if</span> <span class="n">spot_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbp</span><span class="o">.</span><span class="n">shape_tile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">spot_yxz</span><span class="p">,</span> <span class="n">spot_gene_no</span> <span class="o">=</span> <span class="n">omp</span><span class="o">.</span><span class="n">get_spots</span><span class="p">(</span><span class="n">pixel_coefs_t</span><span class="p">,</span> <span class="n">pixel_yxz_t</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;radius_xy&#39;</span><span class="p">],</span> <span class="n">detect_radius_z</span><span class="p">)</span>
            <span class="n">z_scale</span> <span class="o">=</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">pixel_size_z</span> <span class="o">/</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">pixel_size_xy</span>
            <span class="n">spot_shape</span><span class="p">,</span> <span class="n">spots_used</span><span class="p">,</span> <span class="n">spot_shape_float</span> <span class="o">=</span> \
                <span class="n">omp</span><span class="o">.</span><span class="n">spot_neighbourhood</span><span class="p">(</span><span class="n">pixel_coefs_t</span><span class="p">,</span> <span class="n">pixel_yxz_t</span><span class="p">,</span> <span class="n">spot_yxz</span><span class="p">,</span> <span class="n">spot_gene_no</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;shape_max_size&#39;</span><span class="p">],</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;shape_pos_neighbour_thresh&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;shape_isolation_dist&#39;</span><span class="p">],</span> <span class="n">z_scale</span><span class="p">,</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;shape_sign_thresh&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">):</span>
                <span class="c1"># Rase error if computed average spot shape has no negative values</span>
                <span class="n">error_file</span> <span class="o">=</span> <span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_shape</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;_float_ERROR.npy&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spot_shape_float</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># put z axis to front before saving if 3D</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">error_file</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">spot_shape_float</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">error_file</span><span class="p">,</span> <span class="n">spot_shape_float</span><span class="p">)</span>
                <span class="n">shape_neg_values</span> <span class="o">=</span> <span class="n">spot_shape_float</span><span class="p">[</span><span class="n">spot_shape_float</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error when computing nb.omp.spot_shape:</span><span class="se">\n</span><span class="s2">&quot;</span> \
                          <span class="sa">f</span><span class="s2">&quot;Average spot_shape in OMP Coefficient images was found with </span><span class="si">{</span><span class="n">spots_used</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> spots.</span><span class="se">\n</span><span class="s2">&quot;</span> \
                          <span class="sa">f</span><span class="s2">&quot;However, it contains no pixels with a value of -1.</span><span class="se">\n</span><span class="s2">&quot;</span> \
                          <span class="sa">f</span><span class="s2">&quot;nb.omp.spot_shape_float was saved as</span><span class="se">\n</span><span class="si">{</span><span class="n">error_file</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_neg_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;This contains no negative values either, so OMP section needs re-running with &quot;</span> \
                               <span class="s2">&quot;config[&#39;file_names&#39;][&#39;omp_spot_shape&#39;] specified&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_neg_value</span> <span class="o">=</span> <span class="n">round_any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shape_neg_values</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;floor&#39;</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;OMP section needs re-running with</span><span class="se">\n</span><span class="s2">&quot;</span> \
                               <span class="sa">f</span><span class="s2">&quot;config[&#39;omp&#39;][&#39;shape_sign_thresh&#39;] &lt; </span><span class="si">{</span><span class="n">max_neg_value</span><span class="si">}</span><span class="s2"> or &quot;</span> \
                               <span class="sa">f</span><span class="s2">&quot;config[&#39;file_names&#39;][&#39;omp_spot_shape&#39;] specified&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">nbp</span><span class="o">.</span><span class="n">spot_shape_float</span> <span class="o">=</span> <span class="n">spot_shape_float</span>
            <span class="n">nbp</span><span class="o">.</span><span class="n">shape_spot_local_yxz</span> <span class="o">=</span> <span class="n">spot_yxz</span><span class="p">[</span><span class="n">spots_used</span><span class="p">]</span>
            <span class="n">nbp</span><span class="o">.</span><span class="n">shape_spot_gene_no</span> <span class="o">=</span> <span class="n">spot_gene_no</span><span class="p">[</span><span class="n">spots_used</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spot_shape</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># put z axis to front before saving if 3D</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">spot_shape</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_shape</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">)</span>
            <span class="c1"># already found spots so don&#39;t find again.</span>
            <span class="n">spot_yxzg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spot_yxz</span><span class="p">,</span> <span class="n">spot_gene_no</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">spot_yxz</span><span class="p">,</span> <span class="n">spot_gene_no</span><span class="p">,</span> <span class="n">spots_used</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spot_yxzg</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">initial_pos_neighbour_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Only save spots which have 10% of max possible number of positive neighbours</span>
            <span class="n">initial_pos_neighbour_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;initial_pos_neighbour_thresh_param&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spot_shape</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">initial_pos_neighbour_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">initial_pos_neighbour_thresh</span><span class="p">)</span>
            <span class="n">initial_pos_neighbour_thresh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">initial_pos_neighbour_thresh</span><span class="p">,</span>
                                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;initial_pos_neighbour_thresh_min&#39;</span><span class="p">],</span>
                                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;initial_pos_neighbour_thresh_max&#39;</span><span class="p">]))</span>
        <span class="n">spot_info_t</span> <span class="o">=</span> \
            <span class="n">omp</span><span class="o">.</span><span class="n">get_spots</span><span class="p">(</span><span class="n">pixel_coefs_t</span><span class="p">,</span> <span class="n">pixel_yxz_t</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;radius_xy&#39;</span><span class="p">],</span> <span class="n">detect_radius_z</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span>
                          <span class="n">initial_pos_neighbour_thresh</span><span class="p">,</span> <span class="n">spot_yxzg</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">spot_yxzg</span>
        <span class="n">n_spots</span> <span class="o">=</span> <span class="n">spot_info_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spot_info_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">spot_var</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_spots</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span> <span class="k">for</span> <span class="n">spot_var</span> <span class="ow">in</span> <span class="n">spot_info_t</span><span class="p">],</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spot_info_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spot_info_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_spots</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># find index of each spot in pixel array to add colors and coefs</span>
        <span class="n">pixel_index</span> <span class="o">=</span> <span class="n">numpy_indexed</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">pixel_yxz_t</span><span class="p">,</span> <span class="n">spot_info_t</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>

        <span class="c1"># append this tile info to all tile info</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">):</span>
            <span class="c1"># After ran on one tile, need to load in spot_coefs and spot_info, append and then save again.</span>
            <span class="n">spot_coefs</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">load_npz</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">)</span>
            <span class="n">spot_coefs</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">spot_coefs</span><span class="p">,</span> <span class="n">pixel_coefs_t</span><span class="p">[</span><span class="n">pixel_index</span><span class="p">]))</span>
            <span class="k">del</span> <span class="n">pixel_coefs_t</span><span class="p">,</span> <span class="n">pixel_index</span>
            <span class="n">sparse</span><span class="o">.</span><span class="n">save_npz</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">,</span> <span class="n">spot_coefs</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">spot_coefs</span>
            <span class="n">spot_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">)</span>
            <span class="n">spot_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spot_info</span><span class="p">,</span> <span class="n">spot_info_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">spot_info_t</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">,</span> <span class="n">spot_info</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">spot_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 1st tile, need to create files to save to</span>
            <span class="n">sparse</span><span class="o">.</span><span class="n">save_npz</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_coef</span><span class="p">,</span> <span class="n">pixel_coefs_t</span><span class="p">[</span><span class="n">pixel_index</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">pixel_coefs_t</span><span class="p">,</span> <span class="n">pixel_index</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">,</span> <span class="n">spot_info_t</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">spot_info_t</span>

    <span class="n">nbp</span><span class="o">.</span><span class="n">spot_shape</span> <span class="o">=</span> <span class="n">spot_shape</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">initial_pos_neighbour_thresh</span> <span class="o">=</span> <span class="n">initial_pos_neighbour_thresh</span>

    <span class="n">spot_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nbp_file</span><span class="o">.</span><span class="n">omp_spot_info</span><span class="p">)</span>
    <span class="c1"># find duplicate spots as those detected on a tile which is not tile centre they are closest to</span>
    <span class="n">not_duplicate</span> <span class="o">=</span> <span class="n">get_non_duplicate</span><span class="p">(</span><span class="n">tile_origin</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">tile_centre</span><span class="p">,</span>
                                      <span class="n">spot_info</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">spot_info</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">])</span>

    <span class="c1"># Add spot info to notebook page</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">local_yxz</span> <span class="o">=</span> <span class="n">spot_info</span><span class="p">[</span><span class="n">not_duplicate</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">tile</span> <span class="o">=</span> <span class="n">spot_info</span><span class="p">[</span><span class="n">not_duplicate</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

    <span class="c1"># Get colors, background_coef and intensity of final spots.</span>
    <span class="n">n_spots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">not_duplicate</span><span class="p">)</span>
    <span class="n">invalid_value</span> <span class="o">=</span> <span class="o">-</span><span class="n">nbp_basic</span><span class="o">.</span><span class="n">tile_pixel_value_shift</span>
    <span class="c1"># Only read in used colors first for background/intensity calculation.</span>
    <span class="n">nd_spot_colors_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_spots</span><span class="p">,</span> <span class="n">n_rounds_use</span><span class="p">,</span> <span class="n">n_channels_use</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">invalid_value</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_tiles</span><span class="p">:</span>
        <span class="n">in_tile</span> <span class="o">=</span> <span class="n">nbp</span><span class="o">.</span><span class="n">tile</span> <span class="o">==</span> <span class="n">t</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">in_tile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nd_spot_colors_use</span><span class="p">[</span><span class="n">in_tile</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_spot_colors</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nbp</span><span class="o">.</span><span class="n">local_yxz</span><span class="p">[</span><span class="n">in_tile</span><span class="p">]),</span> <span class="n">t</span><span class="p">,</span>
                                                          <span class="n">transform</span><span class="p">,</span> <span class="n">nbp_file</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="p">)</span>

    <span class="n">spot_colors_norm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nd_spot_colors_use</span><span class="p">)</span> <span class="o">/</span> <span class="n">color_norm_factor</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">get_spot_intensity</span><span class="p">(</span><span class="n">spot_colors_norm</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">spot_colors_norm</span>

    <span class="c1"># When saving to notebook, include unused rounds/channels.</span>
    <span class="n">nd_spot_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_spots</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">n_rounds</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">n_channels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">invalid_value</span>
    <span class="n">nd_spot_colors</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spots</span><span class="p">),</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nbp_basic</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nd_spot_colors_use</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">nd_spot_colors</span>
    <span class="k">del</span> <span class="n">nd_spot_colors_use</span>

    <span class="n">nbp</span><span class="o">.</span><span class="n">gene_no</span> <span class="o">=</span> <span class="n">spot_info</span><span class="p">[</span><span class="n">not_duplicate</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">n_neighbours_pos</span> <span class="o">=</span> <span class="n">spot_info</span><span class="p">[</span><span class="n">not_duplicate</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">nbp</span><span class="o">.</span><span class="n">n_neighbours_neg</span> <span class="o">=</span> <span class="n">spot_info</span><span class="p">[</span><span class="n">not_duplicate</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">nbp</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../call_reference_spots/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Call Reference Spots" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Call Reference Spots
            </div>
          </div>
        </a>
      
      
        
        <a href="../../utils/base/" class="md-footer__link md-footer__link--next" aria-label="Next: Base" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Base
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://github.com/jduffield65/coppafish" target="_blank" rel="noopener" title="Github Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.expand", "content.tabs.link", "navigation.sections", "navigation.top"], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>