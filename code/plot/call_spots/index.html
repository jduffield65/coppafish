
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../images/logo.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>Call Spots - coppafish</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bleed-matrix" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="coppafish" class="md-header__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            coppafish
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Call Spots
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../config_setup/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../pipeline/overview/" class="md-tabs__link">
        Pipeline
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../setup/notebook/" class="md-tabs__link md-tabs__link--active">
        Code
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="coppafish" class="md-nav__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    coppafish
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config_setup/" class="md-nav__link">
        Setting up the Config File
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../run_code/" class="md-nav__link">
        Running the code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../view_results/" class="md-nav__link">
        Viewing the results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config/" class="md-nav__link">
        Config Default Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook_comments/" class="md-nav__link">
        Notebook Comments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/extract/" class="md-nav__link">
        Extract and Filter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/tile_details/" class="md-nav__link">
        Tile Detail
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/file_names/" class="md-nav__link">
        File Names
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Extract
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extract" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Extract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/deconvolution/" class="md-nav__link">
        Deconvolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/fstack/" class="md-nav__link">
        Fstack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/scale/" class="md-nav__link">
        Scale
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Find Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Find Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Find Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/check_spots/" class="md-nav__link">
        Check Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/detect/" class="md-nav__link">
        Detect
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Stitch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Stitch" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Stitch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/shift/" class="md-nav__link">
        Shift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/starting_shifts/" class="md-nav__link">
        Starting Shifts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/tile_origin/" class="md-nav__link">
        Tile Origin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/check_shifts/" class="md-nav__link">
        Check Shifts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Register
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Register" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Register
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/check_transforms/" class="md-nav__link">
        Check Transforms
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Spot Colors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Spot Colors" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Spot Colors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spot_colors/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_7">
          Call Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Call Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          Call Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/background/" class="md-nav__link">
        Background
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/bleed_matrix/" class="md-nav__link">
        Bleed Matrix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/dot_product/" class="md-nav__link">
        Dot Product
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/qual_check/" class="md-nav__link">
        Quality Check
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_8" type="checkbox" id="__nav_4_8" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_8">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OMP" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          OMP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/coefs/" class="md-nav__link">
        Coefficients
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/spots/" class="md-nav__link">
        Spots
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_9" type="checkbox" id="__nav_4_9" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_9">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_9">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/run/" class="md-nav__link">
        Run
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/basic_info/" class="md-nav__link">
        Basic Info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/extract_run/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_10" type="checkbox" id="__nav_4_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_10">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_10">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/pciseq/" class="md-nav__link">
        pciSeq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/matlab/" class="md-nav__link">
        Matlab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/morphology/" class="md-nav__link">
        Morphology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/nd2/" class="md-nav__link">
        nd2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/npy/" class="md-nav__link">
        npy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/strel/" class="md-nav__link">
        Strel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_11" type="checkbox" id="__nav_4_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_11">
          Plot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_11">
          <span class="md-nav__icon md-icon"></span>
          Plot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../viewer/" class="md-nav__link">
        Viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../raw/" class="md-nav__link">
        Raw
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extract/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Call Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Call Spots
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bleed-matrix" class="md-nav__link">
    Bleed Matrix
  </a>
  
    <nav class="md-nav" aria-label="Bleed Matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_bleed_matrix" class="md-nav__link">
    view_bleed_matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_bled_codes" class="md-nav__link">
    view_bled_codes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spot-colors" class="md-nav__link">
    Spot Colors
  </a>
  
    <nav class="md-nav" aria-label="Spot Colors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_codes" class="md-nav__link">
    view_codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_spot" class="md-nav__link">
    view_spot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_intensity" class="md-nav__link">
    view_intensity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#colorplotbase" class="md-nav__link">
    ColorPlotBase
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot-product" class="md-nav__link">
    Dot Product
  </a>
  
    <nav class="md-nav" aria-label="Dot Product">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_score" class="md-nav__link">
    view_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#weight" class="md-nav__link">
    Weight
  </a>
  
    <nav class="md-nav" aria-label="Weight">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_weight" class="md-nav__link">
    view_weight
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_background" class="md-nav__link">
    view_background
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gene-counts" class="md-nav__link">
    Gene Counts
  </a>
  
    <nav class="md-nav" aria-label="Gene Counts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gene_counts" class="md-nav__link">
    gene_counts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-calculation" class="md-nav__link">
    Score Calculation
  </a>
  
    <nav class="md-nav" aria-label="Score Calculation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.call_spots.score_calc.background_fitting" class="md-nav__link">
    background_fitting()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.call_spots.score_calc.get_dot_product_score" class="md-nav__link">
    get_dot_product_score()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaled-k-means" class="md-nav__link">
    Scaled K Means
  </a>
  
    <nav class="md-nav" aria-label="Scaled K Means">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.call_spots.scaled_k_means.view_scaled_k_means" class="md-nav__link">
    view_scaled_k_means()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_12" type="checkbox" id="__nav_4_12" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_12">
          Separate Round Registration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Separate Round Registration" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_12">
          <span class="md-nav__icon md-icon"></span>
          Separate Round Registration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sep_round_reg/" class="md-nav__link">
        Sep round reg
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bleed-matrix" class="md-nav__link">
    Bleed Matrix
  </a>
  
    <nav class="md-nav" aria-label="Bleed Matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_bleed_matrix" class="md-nav__link">
    view_bleed_matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_bled_codes" class="md-nav__link">
    view_bled_codes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spot-colors" class="md-nav__link">
    Spot Colors
  </a>
  
    <nav class="md-nav" aria-label="Spot Colors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_codes" class="md-nav__link">
    view_codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_spot" class="md-nav__link">
    view_spot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_intensity" class="md-nav__link">
    view_intensity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#colorplotbase" class="md-nav__link">
    ColorPlotBase
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot-product" class="md-nav__link">
    Dot Product
  </a>
  
    <nav class="md-nav" aria-label="Dot Product">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_score" class="md-nav__link">
    view_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#weight" class="md-nav__link">
    Weight
  </a>
  
    <nav class="md-nav" aria-label="Weight">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_weight" class="md-nav__link">
    view_weight
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_background" class="md-nav__link">
    view_background
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gene-counts" class="md-nav__link">
    Gene Counts
  </a>
  
    <nav class="md-nav" aria-label="Gene Counts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gene_counts" class="md-nav__link">
    gene_counts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-calculation" class="md-nav__link">
    Score Calculation
  </a>
  
    <nav class="md-nav" aria-label="Score Calculation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.call_spots.score_calc.background_fitting" class="md-nav__link">
    background_fitting()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.call_spots.score_calc.get_dot_product_score" class="md-nav__link">
    get_dot_product_score()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaled-k-means" class="md-nav__link">
    Scaled K Means
  </a>
  
    <nav class="md-nav" aria-label="Scaled K Means">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.call_spots.scaled_k_means.view_scaled_k_means" class="md-nav__link">
    view_scaled_k_means()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/jduffield65/coppafish/edit/master/docs/code/plot/call_spots.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Call Spots</h1>

<h2 id="bleed-matrix">Bleed Matrix</h2>
<h3 id="view_bleed_matrix"><code>view_bleed_matrix</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to plot <code>bleed_matrix</code>. If <code>config['call_spots']['bleed_matrix_method']</code> is <code>'single'</code>,
a single <code>bleed_matrix</code> will be plotted. If it is <code>'separate'</code>, one will be shown for each round.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/bleed_matrix.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to plot `bleed_matrix`. If `config[&#39;call_spots&#39;][&#39;bleed_matrix_method&#39;]` is `&#39;single&#39;`,</span>
<span class="sd">    a single `bleed_matrix` will be plotted. If it is `&#39;separate&#39;`, one will be shown for each round.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                        <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span>
    <span class="n">n_use_rounds</span><span class="p">,</span> <span class="n">n_use_channels</span> <span class="o">=</span> <span class="n">color_norm</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">single_bm</span> <span class="o">=</span> <span class="p">(</span><span class="n">color_norm</span> <span class="o">==</span> <span class="n">color_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">single_bm</span><span class="p">:</span>
        <span class="n">bleed_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bleed_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">,</span>
                                                             <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)]]</span>
        <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.095</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">]</span>
        <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bleed_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bleed_matrix</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">,</span>
                                                             <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">n_use_rounds</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">n_use_rounds</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_use_rounds</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># at most 4 rows</span>
            <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_use_rounds</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)),</span> <span class="n">n_cols</span><span class="p">]</span>
        <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.095</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">]</span>
        <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">n_use_dyes</span> <span class="o">=</span> <span class="n">bleed_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># different norm for each round, each has dims n_use_channels x 1 whereas BM dims is n_use_channels x n_dyes</span>
    <span class="c1"># i.e. normalisation just affected by channel not by dye.</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">color_norm</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">)]</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bleed_matrix</span><span class="p">,</span> <span class="n">color_norm</span><span class="p">,</span> <span class="n">subplot_row_columns</span><span class="p">,</span> <span class="n">subplot_adjust</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">,</span>
                     <span class="n">fig_size</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_use_channels</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">dye_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_use_dyes</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_use_dyes</span><span class="p">),</span>
                               <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">dye_names</span><span class="p">)[</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">single_bm</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bleed Matrix&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dyes&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Round </span><span class="si">{</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Bleed Matrices&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Dyes&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">()</span>  <span class="c1"># initialise with method = &#39;norm&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h3 id="view_bled_codes"><code>view_bled_codes</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to plot <code>bleed_matrix</code>. If <code>config['call_spots']['bleed_matrix_method']</code> is <code>'single'</code>,
a single <code>bleed_matrix</code> will be plotted. If it is <code>'separate'</code>, one will be shown for each round.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/bleed_matrix.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to plot `bleed_matrix`. If `config[&#39;call_spots&#39;][&#39;bleed_matrix_method&#39;]` is `&#39;single&#39;`,</span>
<span class="sd">    a single `bleed_matrix` will be plotted. If it is `&#39;separate&#39;`, one will be shown for each round.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                        <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span>
    <span class="n">n_use_rounds</span><span class="p">,</span> <span class="n">n_use_channels</span> <span class="o">=</span> <span class="n">color_norm</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">single_bm</span> <span class="o">=</span> <span class="p">(</span><span class="n">color_norm</span> <span class="o">==</span> <span class="n">color_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">single_bm</span><span class="p">:</span>
        <span class="n">bleed_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bleed_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">,</span>
                                                             <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)]]</span>
        <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.095</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">]</span>
        <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bleed_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bleed_matrix</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">,</span>
                                                             <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">n_use_rounds</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">n_use_rounds</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_use_rounds</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># at most 4 rows</span>
            <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_use_rounds</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)),</span> <span class="n">n_cols</span><span class="p">]</span>
        <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.095</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">]</span>
        <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">n_use_dyes</span> <span class="o">=</span> <span class="n">bleed_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># different norm for each round, each has dims n_use_channels x 1 whereas BM dims is n_use_channels x n_dyes</span>
    <span class="c1"># i.e. normalisation just affected by channel not by dye.</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">color_norm</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">)]</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bleed_matrix</span><span class="p">,</span> <span class="n">color_norm</span><span class="p">,</span> <span class="n">subplot_row_columns</span><span class="p">,</span> <span class="n">subplot_adjust</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">,</span>
                     <span class="n">fig_size</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_use_channels</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">dye_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_use_dyes</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_use_dyes</span><span class="p">),</span>
                               <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">dye_names</span><span class="p">)[</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">single_bm</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bleed Matrix&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dyes&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Round </span><span class="si">{</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Bleed Matrices&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Dyes&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">()</span>  <span class="c1"># initialise with method = &#39;norm&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="spot-colors">Spot Colors</h2>
<h3 id="view_codes"><code>view_codes</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to compare <code>spot_color</code> to <code>bled_code</code> of predicted gene.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;anchor&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/spot_colors.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;anchor&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to compare `spot_color` to `bled_code` of predicted gene.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                        <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
        <span class="n">spot_score</span> <span class="o">=</span> <span class="n">omp_spot_score</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">omp</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp_multiplier&#39;</span><span class="p">],</span> <span class="n">spot_no</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;ref_spots&#39;</span>
        <span class="n">spot_score</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_color</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">spot_no</span><span class="p">][</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">/</span> <span class="n">color_norm</span>
    <span class="c1"># Get spot color after background fitting</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">background_removed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_color_pb</span> <span class="o">=</span> <span class="n">fit_background</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spot_color</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                        <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">background_weight_shift</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">gene_no</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>

    <span class="n">gene_name</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="p">[</span><span class="n">gene_no</span><span class="p">]</span>
    <span class="n">gene_color</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">[</span><span class="n">gene_no</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                             <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">spot_color</span><span class="p">,</span> <span class="n">gene_color</span><span class="p">],</span> <span class="n">color_norm</span><span class="p">,</span> <span class="n">slider_pos</span><span class="o">=</span><span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">],</span>
                     <span class="n">cbar_pos</span><span class="o">=</span><span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spot </span><span class="si">{</span><span class="n">spot_no</span><span class="si">}</span><span class="s1">: match </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">spot_score</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="si">}</span><span class="s1"> &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;to </span><span class="si">{</span><span class="n">gene_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicted code for Gene </span><span class="si">{</span><span class="n">gene_no</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">gene_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1"> (</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_efficiency</span><span class="p">[</span><span class="n">gene_no</span><span class="p">,</span> <span class="n">r</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Round (Gene Efficiency)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">)</span>
    <span class="n">intense_gene_cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gene_color</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">intense_gene_thresh</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intense_gene_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="c1"># can&#39;t add rectangle to multiple axes hence second for loop</span>
            <span class="n">rectangle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">intense_gene_cr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">intense_gene_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;lime&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rectangle</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">background_button_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">background_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">background_button_ax</span><span class="p">,</span> <span class="s1">&#39;Background&#39;</span><span class="p">,</span> <span class="n">hovercolor</span><span class="o">=</span><span class="s1">&#39;0.275&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">background_button</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_button_color</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">background_button</span><span class="o">.</span><span class="n">on_clicked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change_background</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">()</span>  <span class="c1"># initialise with method = &#39;norm&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h3 id="view_spot"><code>view_spot</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to show intensity of each color channel / round in neighbourhood of spot.
Will show a grid of <code>n_use_channels x n_use_rounds</code> subplots.</p>
<div class="admonition warning">
<p class="admonition-title">Requires access to <code>nb.file_names.tile_dir</code></p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;anchor&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>im_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Radius of image to be plotted for each channel/round.</p></td>
          <td>
                <code>8</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/spot_colors.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="n">im_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to show intensity of each color channel / round in neighbourhood of spot.</span>
<span class="sd">    Will show a grid of `n_use_channels x n_use_rounds` subplots.</span>

<span class="sd">    !!! warning &quot;Requires access to `nb.file_names.tile_dir`&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        im_size: Radius of image to be plotted for each channel/round.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                        <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
        <span class="n">spot_score</span> <span class="o">=</span> <span class="n">omp_spot_score</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">omp</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp_multiplier&#39;</span><span class="p">],</span> <span class="n">spot_no</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;ref_spots&#39;</span>
        <span class="n">spot_score</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">gene_no</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">tile</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">spot_yxz</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">local_yxz</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>

    <span class="n">gene_name</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="p">[</span><span class="n">gene_no</span><span class="p">]</span>
    <span class="n">gene_color</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">[</span><span class="n">gene_no</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                             <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">n_use_channels</span><span class="p">,</span> <span class="n">n_use_rounds</span> <span class="o">=</span> <span class="n">color_norm</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">color_norm</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
    <span class="n">spot_yxz_global</span> <span class="o">=</span> <span class="n">spot_yxz</span> <span class="o">+</span> <span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">im_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">im_size</span><span class="p">,</span> <span class="n">im_size</span><span class="p">]</span>  <span class="c1"># Useful for debugging to have different im_size_y, im_size_x.</span>
    <span class="c1"># Subtlety here, may have y-axis flipped, but I think it is correct:</span>
    <span class="c1"># note im_yxz[1] refers to point at max_y, min_x+1, z. So when reshape and set plot_extent, should be correct.</span>
    <span class="c1"># I.e. im = np.zeros(49); im[1] = 1; im = im.reshape(7,7); plt.imshow(im, extent=[-0.5, 6.5, -0.5, 6.5])</span>
    <span class="c1"># will show the value 1 at max_y, min_x+1.</span>
    <span class="n">im_yxz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spot_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spot_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spot_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spot_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">spot_yxz</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">im_diameter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">get_spot_colors</span><span class="p">(</span><span class="n">im_yxz</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">file_names</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="p">)</span>
    <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># put round as the last axis to match color_norm</span>
    <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">spot_colors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_yxz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># reshape</span>
    <span class="n">cr_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot_colors</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_diameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">im_diameter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">color_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spot_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cr_images</span><span class="p">,</span> <span class="n">color_norm</span><span class="p">,</span> <span class="n">subplot_row_columns</span><span class="o">=</span><span class="p">[</span><span class="n">n_use_channels</span><span class="p">,</span> <span class="n">n_use_rounds</span><span class="p">],</span>
                     <span class="n">subplot_adjust</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="c1"># set x, y coordinates to be those of the global coordinate system</span>
    <span class="n">plot_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">im_yxz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="o">+</span><span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">im_yxz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="o">+</span><span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">im_yxz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="o">+</span><span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="n">im_yxz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="o">+</span><span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">):</span>
        <span class="c1"># Add cross-hair</span>
        <span class="k">if</span> <span class="n">gene_color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">intense_gene_thresh</span><span class="p">:</span>
            <span class="n">cross_hair_color</span> <span class="o">=</span> <span class="s1">&#39;lime&#39;</span>  <span class="c1"># different color if expected large intensity</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;lime&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cross_hair_color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">plot_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">plot_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                             <span class="n">cross_hair_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plot_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                             <span class="n">cross_hair_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">plot_extent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Add axis labels to subplots of far left column or bottom row</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_use_rounds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">n_use_rounds</span><span class="p">)]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_images</span> <span class="o">-</span> <span class="n">n_use_rounds</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span> <span class="o">-</span> <span class="n">n_use_rounds</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1"> (</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_efficiency</span><span class="p">[</span><span class="n">gene_no</span><span class="p">,</span> <span class="n">r</span><span class="p">]))</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Round (Gene Efficiency)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spot </span><span class="si">{</span><span class="n">spot_no</span><span class="si">}</span><span class="s1">: match </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">spot_score</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="si">}</span><span class="s1"> &#39;</span>
                 <span class="sa">f</span><span class="s1">&#39;to </span><span class="si">{</span><span class="n">gene_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h3 id="view_intensity"><code>view_intensity</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to show how intensity is computed from <code>spot_color</code>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;anchor&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/spot_colors.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;anchor&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to show how intensity is computed from `spot_color`.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                        <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;ref_spots&#39;</span>
    <span class="n">intensity_saved</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">intensity_thresh</span> <span class="o">=</span> <span class="n">get_intensity_thresh</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
    <span class="n">spot_color</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">spot_no</span><span class="p">][</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">/</span> <span class="n">color_norm</span>
    <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span><span class="n">spot_color</span><span class="p">],</span> <span class="n">color_norm</span><span class="p">,</span> <span class="n">subplot_adjust</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">intensity_saved</span> <span class="o">&gt;</span> <span class="n">intensity_thresh</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
    <span class="n">spot_color_symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\mathbf{\zeta_s}$&quot;</span>
    <span class="n">intensity_symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\chi_s$, (median of $\max_c\zeta_{s_</span><span class="si">{rc}</span><span class="s2">}$ indicated in green)&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spot Color, </span><span class="si">{</span><span class="n">spot_color_symbol</span><span class="si">}</span><span class="s1">, for spot </span><span class="si">{</span><span class="n">spot_no</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;Intensity, </span><span class="si">{</span><span class="n">intensity_symbol</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">intensity_saved</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Round&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">)</span>
    <span class="c1"># Highlight max channel in each round which contributes to intensity</span>
    <span class="n">max_channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">)):</span>
        <span class="c1"># can&#39;t add rectangle to multiple axes hence second for loop</span>
        <span class="n">rectangle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">r</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_channels</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rectangle</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">()</span>  <span class="c1"># initialise with method = &#39;norm&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h3 id="colorplotbase"><code>ColorPlotBase</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>This is the base class for plots with multiple subplots and with a slider to change the color axis and a button
to change the normalisation.
After initialising, the function <code>change_norm()</code> should be run to plot normalised images.
This will change <code>self.method</code> from <code>'raw'</code> to <code>'norm'</code>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>images</code></td>
          <td>
                <code><span title="typing.List">List</span></code>
          </td>
          <td><p><code>float [n_images]</code>
Each image is <code>n_y x n_x (x n_z)</code>. This is the normalised image.
There will be a subplot for each image and if it is 3D, the first z-plane will be set as the
starting data, <code>self.im_data</code> while the full 3d data will be saved as <code>self.im_data_3d</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>norm_factor</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="typing.List">List</span>]]</code>
          </td>
          <td><p><code>float [n_images]</code>
<code>norm_factor[i]</code> is the value to multiply <code>images[i]</code> to give raw image.
<code>norm_factor[i]</code> is either an integer or an array of same dimensions as <code>image[i]</code>.
If a single <code>norm_factor</code> given, assume same for each image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subplot_row_columns</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p><code>[n_rows, n_columns]</code>
The subplots will be arranged into <code>n_rows</code> and <code>n_columns</code>.
If not given, <code>n_columns</code> will be 1.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fig_size</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>]</code>
          </td>
          <td><p><code>[width, height]</code>
Size of figure to plot in inches.
If not given, will be set to <code>(9, 5)</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>subplot_adjust</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p><code>[left, right, bottom, top]</code>
The position of the sides of the subplots in the figure.
I.e., we don't want subplot to overlap with cbar, slider or buttom and this ensures that.
If not given, will be set to <code>[0.07, 0.775, 0.095, 0.94]</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>cbar_pos</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p><code>[left, bottom, width, height]</code>
Position of color axis.
If not given, will be set to <code>[0.9, 0.15, 0.03, 0.8]</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>slider_pos</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p><code>[left, bottom, width, height]</code>
Position of slider that controls color axis.
If not given, will be set to <code>[0.85, 0.15, 0.01, 0.8]</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>button_pos</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p><code>[left, bottom, width, height]</code>
Position of button which triggers change of normalisation.
If not given, will be set to <code>[0.85, 0.02, 0.1, 0.05]</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/spot_colors.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">norm_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">]],</span>
             <span class="n">subplot_row_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">fig_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">subplot_adjust</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">cbar_pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">slider_pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">button_pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the base class for plots with multiple subplots and with a slider to change the color axis and a button</span>
<span class="sd">    to change the normalisation.</span>
<span class="sd">    After initialising, the function `change_norm()` should be run to plot normalised images.</span>
<span class="sd">    This will change `self.method` from `&#39;raw&#39;` to `&#39;norm&#39;`.</span>

<span class="sd">    Args:</span>
<span class="sd">        images: `float [n_images]`</span>
<span class="sd">            Each image is `n_y x n_x (x n_z)`. This is the normalised image.</span>
<span class="sd">            There will be a subplot for each image and if it is 3D, the first z-plane will be set as the</span>
<span class="sd">            starting data, `self.im_data` while the full 3d data will be saved as `self.im_data_3d`.</span>
<span class="sd">        norm_factor: `float [n_images]`</span>
<span class="sd">            `norm_factor[i]` is the value to multiply `images[i]` to give raw image.</span>
<span class="sd">            `norm_factor[i]` is either an integer or an array of same dimensions as `image[i]`.</span>
<span class="sd">            If a single `norm_factor` given, assume same for each image.</span>
<span class="sd">        subplot_row_columns: `[n_rows, n_columns]`</span>
<span class="sd">            The subplots will be arranged into `n_rows` and `n_columns`.</span>
<span class="sd">            If not given, `n_columns` will be 1.</span>
<span class="sd">        fig_size: `[width, height]`</span>
<span class="sd">            Size of figure to plot in inches.</span>
<span class="sd">            If not given, will be set to `(9, 5)`.</span>
<span class="sd">        subplot_adjust: `[left, right, bottom, top]`</span>
<span class="sd">            The position of the sides of the subplots in the figure.</span>
<span class="sd">            I.e., we don&#39;t want subplot to overlap with cbar, slider or buttom and this ensures that.</span>
<span class="sd">            If not given, will be set to `[0.07, 0.775, 0.095, 0.94]`.</span>
<span class="sd">        cbar_pos: `[left, bottom, width, height]`</span>
<span class="sd">            Position of color axis.</span>
<span class="sd">            If not given, will be set to `[0.9, 0.15, 0.03, 0.8]`.</span>
<span class="sd">        slider_pos: `[left, bottom, width, height]`</span>
<span class="sd">            Position of slider that controls color axis.</span>
<span class="sd">            If not given, will be set to `[0.85, 0.15, 0.01, 0.8]`.</span>
<span class="sd">        button_pos: `[left, bottom, width, height]`</span>
<span class="sd">            Position of button which triggers change of normalisation.</span>
<span class="sd">            If not given, will be set to `[0.85, 0.02, 0.1, 0.05]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># When bled code of a gene more than this, that particular round/channel will be highlighted in plots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intense_gene_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subplot_row_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Default positions</span>
    <span class="k">if</span> <span class="n">fig_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subplot_adjust</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.095</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cbar_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cbar_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">slider_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider_pos</span> <span class="o">=</span> <span class="n">slider_pos</span>
    <span class="k">if</span> <span class="n">button_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">button_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">norm_factor</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># allow for different norm for each image</span>
        <span class="k">if</span> <span class="n">norm_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm_factor</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_images</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="o">=</span> <span class="n">norm_factor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>  <span class="c1"># put in order channels, rounds</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;raw&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;norm&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span>
            <span class="n">im_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">im_data</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mf">1e-20</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">im_data</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1e-20</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]])</span>
        <span class="c1"># have equal either side of zero so small negatives don&#39;t look large</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;clims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]]</span>
        <span class="c1"># cmap_norm is so cmap is white at 0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;cmap_norm&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">TwoSlopeNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">],</span>
                                           <span class="n">vcenter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_row_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subplot_row_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">,</span>
                                     <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_images</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">]</span>  <span class="c1"># need it to be a list</span>
    <span class="k">elif</span> <span class="n">subplot_row_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">subplot_row_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># only have 1 ax index</span>
    <span class="n">oob_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">,</span> <span class="n">subplot_row_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">subplot_row_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">oob_axes</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oob_axes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># delete excess subplots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                             <span class="n">top</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_images</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># For 3D data, start by showing just the first plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_data_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_data_3d</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_norm_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_norm_3d</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_data_3d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_norm_3d</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># initialise plots with a zero array</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                                       <span class="n">norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caxis_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">][</span><span class="s1">&#39;cmap_norm&#39;</span><span class="p">])</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">cbar_pos</span><span class="p">)</span>  <span class="c1"># left, bottom, width, height</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">slider_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slider_pos</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color_slider</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_button_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_button_color_press</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_button_color_press</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_button_color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_button_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">button_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_button_ax</span><span class="p">,</span> <span class="s1">&#39;Norm&#39;</span><span class="p">,</span> <span class="n">hovercolor</span><span class="o">=</span><span class="s1">&#39;0.275&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_button</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">current_color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_button</span><span class="o">.</span><span class="n">on_clicked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="dot-product">Dot Product</h2>
<h3 id="view_score"><code>view_score</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>This produces 4 plots on the first row, showing spot_color, residual, variance and weight squared (basically
the normalised inverse variance).</p>
<p>The bottom row shows the contribution from background and genes to the variance.</p>
<p>The iteration as well as the alpha and beta parameters used to compute the weight can be changed through
the text boxes.</p>
<p>If the weight plot is clicked on, the <code>view_weight</code> plot will open for the current iteration.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p><em>Notebook</em> containing at least the <em>call_spots</em> and <em>ref_spots</em> pages.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;omp&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>g</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>Gene to view dot product calculation for.
If left as <code>None</code>, will show the gene with the largest dot product score.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>iter</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Iteration in OMP to view the dot product calculation for i.e. the number of genes
which have already been fitted (<code>iter=0</code> will have only background fit,
<code>iter=1</code> will have background + 1 gene etc.).
The score saved as <code>nb.ref_spots.score</code> can be viewed with <code>iter=0</code>.</p></td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>omp_fit_info</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p>This is a list containing <code>[track_info, bled_codes, dp_thresh]</code>.
It is only ever used to call this function from <code>view_omp_fit</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>check_weight</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>When this is <code>True</code>, we raise an error if weight computed here is different
to that computed with <code>get_track_info</code>.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/dot_product.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="nb">iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">omp_fit_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_weight</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This produces 4 plots on the first row, showing spot_color, residual, variance and weight squared (basically</span>
<span class="sd">    the normalised inverse variance).</span>

<span class="sd">    The bottom row shows the contribution from background and genes to the variance.</span>

<span class="sd">    The iteration as well as the alpha and beta parameters used to compute the weight can be changed through</span>
<span class="sd">    the text boxes.</span>

<span class="sd">    If the weight plot is clicked on, the `view_weight` plot will open for the current iteration.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: *Notebook* containing at least the *call_spots* and *ref_spots* pages.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        g: Gene to view dot product calculation for.</span>
<span class="sd">            If left as `None`, will show the gene with the largest dot product score.</span>
<span class="sd">        iter: Iteration in OMP to view the dot product calculation for i.e. the number of genes</span>
<span class="sd">            which have already been fitted (`iter=0` will have only background fit,</span>
<span class="sd">            `iter=1` will have background + 1 gene etc.).</span>
<span class="sd">            The score saved as `nb.ref_spots.score` can be viewed with `iter=0`.</span>
<span class="sd">        omp_fit_info: This is a list containing `[track_info, bled_codes, dp_thresh]`.</span>
<span class="sd">            It is only ever used to call this function from `view_omp_fit`.</span>
<span class="sd">        check_weight: When this is `True`, we raise an error if weight computed here is different</span>
<span class="sd">            to that computed with `get_track_info`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_no</span> <span class="o">=</span> <span class="n">spot_no</span>
    <span class="k">if</span> <span class="n">omp_fit_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_thresh</span> <span class="o">=</span> <span class="n">get_track_info</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_thresh</span> <span class="o">=</span> <span class="n">omp_fit_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rounds_use</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channels_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># allow to view dot product with background</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;background_codes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get saved values if anchor method</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_saved</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">:</span>
            <span class="c1"># Possibility best gene will be background here, but impossible for saved best gene to be background</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_saved</span> <span class="ow">and</span> <span class="n">check_weight</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best gene saved was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">g_saved</span><span class="si">}</span><span class="s2"> but with parameters used here, it &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Ensure that alpha and beta in &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;config[&#39;call_spots&#39;] have not been changed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;Set check_weight=False to skip this error.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp_val_saved</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
        <span class="n">config_name</span> <span class="o">=</span> <span class="s1">&#39;call_spots&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_saved</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp_val_saved</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">config_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>

    <span class="c1"># Get default dot product params</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dp_norm_shift</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_weight</span> <span class="o">=</span> <span class="n">check_weight</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>  <span class="c1"># first two indices in track is not added gene</span>
    <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="ow">or</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span><span class="si">}</span><span class="s2"> iterations for this pixel but iter=</span><span class="si">{</span><span class="nb">iter</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;setting iter = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">iter</span>
    <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">iter</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;BG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_channels</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_rounds</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span>

    <span class="c1"># Initialize data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dp_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dp_weight_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_data</span><span class="p">()</span>

    <span class="c1"># Initialize plot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_cax_lim</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">ax5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ax7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">,</span> <span class="n">ax7</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">bottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_up_plots</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_titles</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_rectangles</span><span class="p">()</span>

    <span class="c1"># Text boxes to change parameters</span>
    <span class="n">text_box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span> <span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\alpha$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\beta$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;dp_shift, $\lambda_d$&#39;</span><span class="p">]</span>
    <span class="n">text_box_values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_norm_shift</span><span class="p">]</span>
    <span class="n">text_box_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">update_g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_iter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_beta</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">update_dp_norm_shift</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)):</span>
        <span class="n">text_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                     <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TextBox</span><span class="p">(</span><span class="n">text_ax</span><span class="p">,</span> <span class="n">text_box_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">text_box_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                     <span class="n">hovercolor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="c1"># change text box title to be above not to the left of box</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">text_ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># label is a child of the TextBox axis</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">])</span>  <span class="c1"># [x,y] - change here to set the position</span>
        <span class="c1"># centering the text</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">on_submit</span><span class="p">(</span><span class="n">text_box_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Make so if click on weight plot, it opens view_weight</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nb</span> <span class="o">=</span> <span class="n">nb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_weight</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="weight">Weight</h2>
<h3 id="view_weight"><code>view_weight</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>This produces at least 5 plots which show how the weight used in the dot product score was calculated.</p>
<p>The iteration as well as the alpha and beta parameters used to compute the weight can be changed
with the text boxes.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p><em>Notebook</em> containing at least the <em>call_spots</em> and <em>ref_spots</em> pages.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;omp&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>iter</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Iteration in OMP to view the dot product calculation for i.e. the number of genes
which have already been fitted (<code>iter=0</code> will have only background fit,
<code>iter=1</code> will have background + 1 gene etc.).
The score saved as <code>nb.ref_spots.score</code> can be viewed with <code>iter=0</code>.</p></td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>score_info</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p>This is a list containing <code>[track_info, bled_codes, weight_vmax]</code>.
It is only ever used to call this function from <code>view_score</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>check_weight</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>When this is <code>True</code>, we raise an error if weight computed here is different
to that computed with <code>get_track_info</code>.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/weight.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span>
             <span class="nb">iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">score_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_weight</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This produces at least 5 plots which show how the weight used in the dot product score was calculated.</span>

<span class="sd">    The iteration as well as the alpha and beta parameters used to compute the weight can be changed</span>
<span class="sd">    with the text boxes.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: *Notebook* containing at least the *call_spots* and *ref_spots* pages.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        iter: Iteration in OMP to view the dot product calculation for i.e. the number of genes</span>
<span class="sd">            which have already been fitted (`iter=0` will have only background fit,</span>
<span class="sd">            `iter=1` will have background + 1 gene etc.).</span>
<span class="sd">            The score saved as `nb.ref_spots.score` can be viewed with `iter=0`.</span>
<span class="sd">        score_info: This is a list containing `[track_info, bled_codes, weight_vmax]`.</span>
<span class="sd">            It is only ever used to call this function from `view_score`.</span>
<span class="sd">        check_weight: When this is `True`, we raise an error if weight computed here is different</span>
<span class="sd">            to that computed with `get_track_info`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_no</span> <span class="o">=</span> <span class="n">spot_no</span>
    <span class="k">if</span> <span class="n">score_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span> <span class="o">=</span> <span class="n">get_track_info</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">,</span> <span class="n">method</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_vmax</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vmax</span> <span class="o">=</span> <span class="n">score_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rounds_use</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channels_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># allow to view dot product with background</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;background_codes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">config_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_name</span> <span class="o">=</span> <span class="s1">&#39;call_spots&#39;</span>
    <span class="c1"># Get default params</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_weight</span> <span class="o">=</span> <span class="n">check_weight</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>  <span class="c1"># first two indices in track is not added gene</span>
    <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="ow">or</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span><span class="si">}</span><span class="s2"> iterations for this pixel but iter=</span><span class="si">{</span><span class="nb">iter</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;setting iter = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">iter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;BG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_channels</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_rounds</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span>

    <span class="c1"># Initialize data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots_top_row</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_data</span><span class="p">()</span>

    <span class="c1"># Initialize plots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_cax_lim</span><span class="p">()</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">n_plots_top_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots_top_row</span><span class="p">:</span>
            <span class="c1"># So goes to next row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots_top_row</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="c1"># Y and X axis are the same for all plots hence share</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">bottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">variance_cbar</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_up_plots</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_titles</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_rectangles</span><span class="p">()</span>

    <span class="c1"># Text boxes to change parameters</span>
    <span class="n">text_box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\alpha$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\beta$&#39;</span><span class="p">]</span>
    <span class="n">text_box_values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">]</span>
    <span class="n">text_box_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">update_iter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_beta</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)):</span>
        <span class="n">text_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                     <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TextBox</span><span class="p">(</span><span class="n">text_ax</span><span class="p">,</span> <span class="n">text_box_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">text_box_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                     <span class="n">hovercolor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="c1"># change text box title to be above not to the left of box</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">text_ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># label is a child of the TextBox axis</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">])</span>  <span class="c1"># [x,y] - change here to set the position</span>
        <span class="c1"># centering the text</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">on_submit</span><span class="p">(</span><span class="n">text_box_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nb</span> <span class="o">=</span> <span class="n">nb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_background</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="background">Background</h2>
<h3 id="view_background"><code>view_background</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>This shows how the background coefficients were calculated.</p>
<p>The weighted dot product is equal to weight multiplied by dot product.
Coefficient for background gene c is the sum over all rounds of weighted dot product in channel c.</p>
<p>Also shows residual after removing background.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p><em>Notebook</em> containing at least the <em>call_spots</em> and <em>ref_spots</em> pages.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;omp&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>check</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>When this is <code>True</code>, we raise an error if background coefs computed here is different
to that computed with <code>get_track_info</code>.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>track_info</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
          </td>
          <td><p>To use when calling from <code>view_weight</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/background.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span> <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">track_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This shows how the background coefficients were calculated.</span>

<span class="sd">    The weighted dot product is equal to weight multiplied by dot product.</span>
<span class="sd">    Coefficient for background gene c is the sum over all rounds of weighted dot product in channel c.</span>

<span class="sd">    Also shows residual after removing background.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: *Notebook* containing at least the *call_spots* and *ref_spots* pages.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        check: When this is `True`, we raise an error if background coefs computed here is different</span>
<span class="sd">            to that computed with `get_track_info`.</span>
<span class="sd">        track_info: To use when calling from `view_weight`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_no</span> <span class="o">=</span> <span class="n">spot_no</span>
    <span class="k">if</span> <span class="n">track_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span> <span class="o">=</span> <span class="n">get_track_info</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">,</span> <span class="n">method</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_vmax</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_vmax</span> <span class="o">=</span> <span class="n">track_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_rounds_use</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channels_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_color</span><span class="o">.</span><span class="n">shape</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_genes_all</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channels_use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_channels</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_rounds</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">background_weight_shift</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">background_weight_shift</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check</span> <span class="o">=</span> <span class="n">check</span>

    <span class="c1"># Initialize data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_data</span><span class="p">()</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># Initialize plots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight_dp_max_initial</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_cax_lim</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">ax6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ax7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="n">ax8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ax9</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">,</span> <span class="n">ax7</span><span class="p">,</span> <span class="n">ax8</span><span class="p">,</span> <span class="n">ax9</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># Coef plots have different x-axis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_plot_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_plot_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_plot_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="c1"># All other plots have same axis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_plot_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_plot_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">bottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_up_plots</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_titles</span><span class="p">()</span>

    <span class="n">weight_plot_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="n">box_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">weight_plot_pos</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">weight_plot_pos</span><span class="o">.</span><span class="n">x1</span><span class="p">])</span>
    <span class="n">box_y</span> <span class="o">=</span> <span class="n">weight_plot_pos</span><span class="o">.</span><span class="n">y0</span>
    <span class="n">text_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">box_x</span><span class="p">,</span> <span class="n">box_y</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_box</span> <span class="o">=</span> <span class="n">TextBox</span><span class="p">(</span><span class="n">text_ax</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;background_shift, $\lambda_b$&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_weight_shift</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                     <span class="n">hovercolor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_box</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">text_ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># label is a child of the TextBox axis</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">])</span>  <span class="c1"># [x,y] - change here to set the position</span>
    <span class="c1"># centering the text</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_box</span><span class="o">.</span><span class="n">on_submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_background_weight_shift</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="gene-counts">Gene Counts</h2>
<h3 id="gene_counts"><code>gene_counts</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>This shows the number of reference spots assigned to each gene which pass the quality thresholding based on
the parameters <code>score_thresh</code> and <code>intensity_thresh</code>.</p>
<p>If <code>nb</code> has the <em>OMP</em> page, then the number of omp spots will also be shown, where the quality thresholding is
based on <code>score_omp_thresh</code>, <code>score_omp_multiplier</code> and <code>intensity_thresh</code>.</p>
<p>There will also be a second reference spots histogram, the difference with this is that the spots
were allowed to be assigned to some fake genes with <code>bled_codes</code> specified through <code>fake_bled_codes</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>fake_bled_codes</code> have dimension <code>n_fake x  nbp_basic.n_rounds x nbp_basic.n_channels</code> not
<code>n_fake x len(nbp_basic.use_rounds) x len(nbp_basic.use_channels)</code>.</p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p><em>Notebook</em> containing at least <code>call_spots</code> page.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>fake_bled_codes</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p><code>float [n_fake_genes x n_rounds x n_channels]</code>.
colors of fake genes to find dot product with
Will find new gene assignment of anchor spots to new set of <code>bled_codes</code> which include these in
addition to <code>bled_codes_ge</code>.
By default, will have a fake gene for each round and channel such that it is <span class="arithmatex">\(1\)</span> in round r,
channel <span class="arithmatex">\(c\)</span> and 0 everywhere else.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fake_gene_names</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[str]]</code>
          </td>
          <td><p><code>str [n_fake_genes]</code>.
Can give name of each fake gene. If <code>None</code>, fake gene <span class="arithmatex">\(i\)</span> will be called FAKE:<span class="arithmatex">\(i\)</span>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>score_thresh</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Threshold for score for ref_spots. Can be changed with text box.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>intensity_thresh</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Threshold for intensity. Can be changed with text box.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>score_omp_thresh</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Threshold for score for omp_spots. Can be changed with text box.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>score_omp_multiplier</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Can specify the value of score_omp_multiplier to use to compute omp score.
If <code>None</code>, will use value in config file. Can be changed with text box.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/gene_counts.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">fake_bled_codes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">fake_gene_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">score_thresh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">intensity_thresh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">score_omp_thresh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">score_omp_multiplier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This shows the number of reference spots assigned to each gene which pass the quality thresholding based on</span>
<span class="sd">    the parameters `score_thresh` and `intensity_thresh`.</span>

<span class="sd">    If `nb` has the *OMP* page, then the number of omp spots will also be shown, where the quality thresholding is</span>
<span class="sd">    based on `score_omp_thresh`, `score_omp_multiplier` and `intensity_thresh`.</span>

<span class="sd">    There will also be a second reference spots histogram, the difference with this is that the spots</span>
<span class="sd">    were allowed to be assigned to some fake genes with `bled_codes` specified through `fake_bled_codes`.</span>

<span class="sd">    !!! note</span>
<span class="sd">        `fake_bled_codes` have dimension `n_fake x  nbp_basic.n_rounds x nbp_basic.n_channels` not</span>
<span class="sd">        `n_fake x len(nbp_basic.use_rounds) x len(nbp_basic.use_channels)`.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: *Notebook* containing at least `call_spots` page.</span>
<span class="sd">        fake_bled_codes: `float [n_fake_genes x n_rounds x n_channels]`.</span>
<span class="sd">            colors of fake genes to find dot product with</span>
<span class="sd">            Will find new gene assignment of anchor spots to new set of `bled_codes` which include these in</span>
<span class="sd">            addition to `bled_codes_ge`.</span>
<span class="sd">            By default, will have a fake gene for each round and channel such that it is $1$ in round r,</span>
<span class="sd">            channel $c$ and 0 everywhere else.</span>
<span class="sd">        fake_gene_names: `str [n_fake_genes]`.</span>
<span class="sd">            Can give name of each fake gene. If `None`, fake gene $i$ will be called FAKE:$i$.</span>
<span class="sd">        score_thresh: Threshold for score for ref_spots. Can be changed with text box.</span>
<span class="sd">        intensity_thresh: Threshold for intensity. Can be changed with text box.</span>
<span class="sd">        score_omp_thresh: Threshold for score for omp_spots. Can be changed with text box.</span>
<span class="sd">        score_omp_multiplier: Can specify the value of score_omp_multiplier to use to compute omp score.</span>
<span class="sd">            If `None`, will use value in config file. Can be changed with text box.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add fake genes</span>
    <span class="k">if</span> <span class="n">fake_bled_codes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default have binary fake gene for each used round and channel</span>
        <span class="n">n_fake</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
        <span class="n">fake_bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_fake</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">n_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">n_channels</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Cluster fake genes by channel because more likely to be a faulty channel</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">:</span>
                <span class="n">fake_bled_codes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">fake_gene_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;r</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">c</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">]</span>
    <span class="n">n_fake</span> <span class="o">=</span> <span class="n">fake_bled_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fake_gene_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fake_gene_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;FAKE:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fake</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">fake_gene_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span> <span class="o">-</span> <span class="n">n_fake</span>

    <span class="c1"># Do new gene assignment for anchor spots when fake genes are included</span>
    <span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">background_var</span> <span class="o">=</span> <span class="n">background_fitting</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="s1">&#39;anchor&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># Fit background before dot product score</span>
    <span class="n">grc_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">),</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="c1"># Bled codes saved to Notebook should already have L2 norm = 1 over used_channels and rounds</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">,</span> <span class="n">fake_bled_codes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">bled_codes</span><span class="p">[</span><span class="n">grc_ind</span><span class="p">]</span>
    <span class="c1"># Ensure L2 norm of 1 for each gene</span>
    <span class="n">norm_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bled_codes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">norm_factor</span><span class="p">[</span><span class="n">norm_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># For genes with no dye in use_dye, this avoids blow up on next line</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">bled_codes</span> <span class="o">/</span> <span class="n">norm_factor</span>
    <span class="n">score</span><span class="p">,</span> <span class="n">gene_no</span> <span class="o">=</span> <span class="n">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span><span class="p">,</span>
                                           <span class="n">background_var</span><span class="p">)</span>

    <span class="c1"># Add quality thresholding info and gene assigned to for method with no fake genes and method with fake genes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">),</span> <span class="n">score</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span> <span class="n">gene_no</span><span class="p">]</span>

    <span class="c1"># Add current thresholds</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_efficiency_intensity_thresh</span>
    <span class="k">if</span> <span class="n">score_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">score_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_ref&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">intensity_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">intensity_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score_thresh</span> <span class="o">=</span> <span class="p">[</span><span class="n">score_thresh</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intensity_thresh</span> <span class="o">=</span> <span class="n">intensity_thresh</span>

    <span class="c1"># Add omp gene assignment if have page</span>
    <span class="k">if</span> <span class="n">nb</span><span class="o">.</span><span class="n">has_page</span><span class="p">(</span><span class="s1">&#39;omp&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">score_omp_multiplier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_omp_multiplier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp_multiplier&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span> <span class="o">=</span> <span class="n">score_omp_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">omp</span>
        <span class="k">if</span> <span class="n">score_omp_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_omp_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_thresh</span> <span class="o">+=</span> <span class="p">[</span><span class="n">score_omp_thresh</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="p">[</span><span class="n">omp_spot_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span><span class="o">.</span><span class="n">gene_no</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_use</span><span class="p">()</span>

    <span class="c1"># Initialise plot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">bottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Number of Spots&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Gene&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Spots assigned to each Gene&quot;</span><span class="p">)</span>

    <span class="c1"># record min and max for textbox input</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Min score of score[1] cannot be less than this</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Max score of score[0] cannot be more than this</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intensity_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intensity_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span>
    <span class="n">default_colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_left</span>
    <span class="n">default_colors</span> <span class="o">=</span> <span class="n">default_colors</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">default_colors</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># default 3 is better than default 2 for omp plot</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">use</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_genes_real</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Add text box to change score multiplier</span>
    <span class="n">text_box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;Score, $\Delta_s$&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Threshold&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Intensity, $\chi_s$&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Threshold&#39;</span><span class="p">]</span>
    <span class="n">text_box_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity_thresh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
    <span class="n">text_box_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">update_score_thresh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_intensity_thresh</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp</span><span class="p">:</span>
        <span class="n">text_box_labels</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;OMP Score, $\gamma_s$&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;Score</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Multiplier, $\rho$&#39;</span><span class="p">]</span>
        <span class="n">text_box_values</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_thresh</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">text_box_funcs</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">update_score_omp_thresh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_score_multiplier</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)):</span>
        <span class="n">text_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TextBox</span><span class="p">(</span><span class="n">text_ax</span><span class="p">,</span> <span class="n">text_box_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">text_box_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                     <span class="n">hovercolor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">text_ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># label is a child of the TextBox axis</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.75</span><span class="p">])</span>
        <span class="c1"># centering the text</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">on_submit</span><span class="p">(</span><span class="n">text_box_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Add buttons to add/remove score_dp histograms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttons_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Ref Spots&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Ref Spots - Fake Genes&quot;</span><span class="p">]</span>
    <span class="n">label_checked</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;OMP Spots&quot;</span><span class="p">]</span>
        <span class="n">label_checked</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span> <span class="o">=</span> <span class="n">CheckButtons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buttons_ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span><span class="p">,</span> <span class="n">label_checked</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">default_colors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">rectangles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">on_clicked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_plots</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="score-calculation">Score Calculation</h2>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="coppafish.plot.call_spots.score_calc.background_fitting" class="doc doc-heading">
<code class="highlight language-python"><span class="n">background_fitting</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Computes background using parameters in config file. Then removes this from the <code>spot_colors</code>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing call_spots page</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>'omp' or 'anchor', indicating which <code>spot_colors</code> to use.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>spot_colors</code> - <code>float [n_spots x n_rounds_use x n_channels_use]</code>.
<code>spot_color</code> after normalised by <code>color_norm_factor</code> but before background fit.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>spot_colors_pb</code> - <code>float [n_spots x n_rounds_use x n_channels_use]</code>.
<code>spot_color</code> after background removed.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>background_var</code> - <code>float [n_spots x n_rounds_use x n_channels_use]</code>.
inverse of the weighting used for dot product score calculation.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/score_calc.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">background_fitting</span><span class="p">(</span><span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes background using parameters in config file. Then removes this from the `spot_colors`.</span>
<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing call_spots page</span>
<span class="sd">        method: &#39;omp&#39; or &#39;anchor&#39;, indicating which `spot_colors` to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `spot_colors` - `float [n_spots x n_rounds_use x n_channels_use]`.</span>
<span class="sd">            `spot_color` after normalised by `color_norm_factor` but before background fit.</span>
<span class="sd">        `spot_colors_pb` - `float [n_spots x n_rounds_use x n_channels_use]`.</span>
<span class="sd">            `spot_color` after background removed.</span>
<span class="sd">        `background_var` - `float [n_spots x n_rounds_use x n_channels_use]`.</span>
<span class="sd">            inverse of the weighting used for dot product score calculation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rc_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">omp</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">rc_ind</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;omp&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">rc_ind</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;call_spots&#39;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
    <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">spot_colors</span> <span class="o">/</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">rc_ind</span><span class="p">]</span>
    <span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">background_coef</span><span class="p">,</span> <span class="n">background_codes</span> <span class="o">=</span> \
        <span class="n">fit_background</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">background_weight_shift</span><span class="p">)</span>
    <span class="n">background_codes</span> <span class="o">=</span> <span class="n">background_codes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">background_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">background_var</span> <span class="o">=</span> <span class="n">background_coef</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">@</span> <span class="n">background_codes</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">spot_colors</span><span class="p">,</span> <span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">background_var</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="coppafish.plot.call_spots.score_calc.get_dot_product_score" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="n">spot_gene_no</span><span class="p">,</span> <span class="n">dp_norm_shift</span><span class="p">,</span> <span class="n">background_var</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Finds dot product score for each <code>spot_color</code> given to the gene indicated by <code>spot_gene_no</code>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>spot_colors</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_spots x n_rounds_use x n_channels_use]</code>.
colors of spots to find score of.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>bled_codes</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_genes x n_rounds_use x n_channels_use]</code>.
colors of genes to find dot product with.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_gene_no</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p><code>int [n_spots]</code>.
Gene that each spot was assigned to. If None, will set <code>spot_gene_no[s]</code> to gene for which
score was largest.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dp_norm_shift</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Normalisation constant for single round used for dot product calculation.
I.e. <code>nb.call_spots.dp_norm_shift</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>background_var</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p><code>float [n_spots x n_rounds_use x n_channels_use]</code>.
inverse of the weighting used for dot product score calculation.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>spot_score</code> - <code>float [n_spots]</code>.
Dot product score for each spot.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>spot_gene_no</code> - will be same as input if given, otherwise will be the best gene assigned.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/score_calc.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">spot_gene_no</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                          <span class="n">dp_norm_shift</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">background_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds dot product score for each `spot_color` given to the gene indicated by `spot_gene_no`.</span>

<span class="sd">    Args:</span>
<span class="sd">        spot_colors: `float [n_spots x n_rounds_use x n_channels_use]`.</span>
<span class="sd">            colors of spots to find score of.</span>
<span class="sd">        bled_codes: `float [n_genes x n_rounds_use x n_channels_use]`.</span>
<span class="sd">            colors of genes to find dot product with.</span>
<span class="sd">        spot_gene_no: `int [n_spots]`.</span>
<span class="sd">            Gene that each spot was assigned to. If None, will set `spot_gene_no[s]` to gene for which</span>
<span class="sd">            score was largest.</span>
<span class="sd">        dp_norm_shift: Normalisation constant for single round used for dot product calculation.</span>
<span class="sd">            I.e. `nb.call_spots.dp_norm_shift`.</span>
<span class="sd">        background_var: `float [n_spots x n_rounds_use x n_channels_use]`.</span>
<span class="sd">            inverse of the weighting used for dot product score calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `spot_score` - `float [n_spots]`.</span>
<span class="sd">            Dot product score for each spot.</span>
<span class="sd">        `spot_gene_no` - will be same as input if given, otherwise will be the best gene assigned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_spots</span><span class="p">,</span> <span class="n">n_rounds_use</span> <span class="o">=</span> <span class="n">spot_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">n_genes</span> <span class="o">=</span> <span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dp_norm_shift</span> <span class="o">=</span> <span class="n">dp_norm_shift</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_rounds_use</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">background_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">background_var</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dot_product_score</span><span class="p">(</span><span class="n">spot_colors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_spots</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                          <span class="n">bled_codes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_genes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dp_norm_shift</span><span class="p">,</span> <span class="n">weight</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">spot_gene_no</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spot_gene_no</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">spot_score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spots</span><span class="p">),</span> <span class="n">spot_gene_no</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spot_score</span><span class="p">,</span> <span class="n">spot_gene_no</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="scaled-k-means">Scaled K Means</h2>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="coppafish.plot.call_spots.scaled_k_means.view_scaled_k_means" class="doc doc-heading">
<code class="highlight language-python"><span class="n">view_scaled_k_means</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Plot to show how <code>scaled_k_means</code> was used to compute the bleed matrix.
There will be upto 3 columns, each with 2 plots.</p>
<p>The vector for dye <span class="arithmatex">\(d\)</span> in the <code>bleed_matrix</code> is computed from all the spot round vectors
whose dot product to the dye <span class="arithmatex">\(d\)</span> vector was the highest.
The boxplots in the first row show these dot product values for each dye.</p>
<p>The second row then shows the bleed matrix at each stage of the computation.</p>
<p>The first column shows the initial bleed matrix. The second column shows the bleed matrix after running
<code>scaled_k_means</code> once with a score threshold of 0. The third column shows the final <code>bleed_matrix</code> after running
<code>scaled_k_means</code> a second time with <code>score_thresh</code> for dye <span class="arithmatex">\(d\)</span> set to the median of the scores assigned to
dye <span class="arithmatex">\(d\)</span> in the first run. Third column only present if <code>config['call_spots']['bleed_matrix_anneal']==True</code>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>r</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Round of bleed matrix to view. Only relevant if <code>config['call_spots']['bleed_matrix_method'] = 'separate'</code>.</p></td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>check</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, will raise error if <code>bleed_matrix</code> computed here is different to that saved in notebook</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/call_spots/scaled_k_means.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">view_scaled_k_means</span><span class="p">(</span><span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot to show how `scaled_k_means` was used to compute the bleed matrix.</span>
<span class="sd">    There will be upto 3 columns, each with 2 plots.</span>

<span class="sd">    The vector for dye $d$ in the `bleed_matrix` is computed from all the spot round vectors</span>
<span class="sd">    whose dot product to the dye $d$ vector was the highest.</span>
<span class="sd">    The boxplots in the first row show these dot product values for each dye.</span>

<span class="sd">    The second row then shows the bleed matrix at each stage of the computation.</span>

<span class="sd">    The first column shows the initial bleed matrix. The second column shows the bleed matrix after running</span>
<span class="sd">    `scaled_k_means` once with a score threshold of 0. The third column shows the final `bleed_matrix` after running</span>
<span class="sd">    `scaled_k_means` a second time with `score_thresh` for dye $d$ set to the median of the scores assigned to</span>
<span class="sd">    dye $d$ in the first run. Third column only present if `config[&#39;call_spots&#39;][&#39;bleed_matrix_anneal&#39;]==True`.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        r: Round of bleed matrix to view. Only relevant if `config[&#39;call_spots&#39;][&#39;bleed_matrix_method&#39;] = &#39;separate&#39;`.</span>
<span class="sd">        check: If True, will raise error if `bleed_matrix` computed here is different to that saved in notebook</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fit background to spot_colors as is done in call_reference_spots before bleed_matrix calc</span>
    <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">background_fitting</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Get bleed matrix and plotting info</span>
    <span class="n">rcd_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)</span>
    <span class="n">initial_bleed_matrix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">initial_bleed_matrix</span><span class="p">[</span><span class="n">rcd_ind</span><span class="p">]</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;call_spots&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bleed_matrix_method&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;separate&#39;</span><span class="p">:</span>
        <span class="n">r_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">)</span> <span class="o">==</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">title_start</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bleed matrix for round </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">title_start</span> <span class="o">=</span> <span class="s2">&quot;Bleed matrix &quot;</span>
    <span class="n">debug_info</span> <span class="o">=</span> <span class="n">get_bleed_matrix</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">isolated</span><span class="p">],</span> <span class="n">initial_bleed_matrix</span><span class="p">,</span>
                                  <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bleed_matrix_method&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bleed_matrix_score_thresh&#39;</span><span class="p">],</span>
                                  <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bleed_matrix_min_cluster_size&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bleed_matrix_n_iter&#39;</span><span class="p">],</span>
                                  <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bleed_matrix_anneal&#39;</span><span class="p">],</span> <span class="n">r_ind</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bleed_matrix</span><span class="p">[</span><span class="n">rcd_ind</span><span class="p">][</span><span class="n">r_ind</span><span class="p">]</span><span class="o">-</span><span class="n">debug_info</span><span class="p">[</span><span class="s1">&#39;bleed_matrix&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bleed Matrix saved to Notebook is different from that computed here &quot;</span>
                             <span class="s2">&quot;with get_bleed_matrix.</span><span class="se">\n</span><span class="s2">Make sure that the background and bleed_matrix&quot;</span>
                             <span class="s2">&quot;parameters in the config file have not changed.&quot;</span><span class="p">)</span>

    <span class="c1"># Make it so all bleed matrices have same L2 norm as final one</span>
    <span class="n">bm_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">debug_info</span><span class="p">[</span><span class="s1">&#39;bleed_matrix&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bleed_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">bm</span> <span class="o">*</span> <span class="n">bm_norm</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bm</span><span class="p">)</span> <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="n">debug_info</span><span class="p">[</span><span class="s1">&#39;bleed_matrix&#39;</span><span class="p">]]</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bleed_matrix</span><span class="p">)</span>

    <span class="c1"># Set up plot</span>
    <span class="n">n_plots</span><span class="p">,</span> <span class="n">n_use_channels</span><span class="p">,</span> <span class="n">n_use_dyes</span> <span class="o">=</span> <span class="n">debug_info</span><span class="p">[</span><span class="s1">&#39;bleed_matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="n">top</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Initial Bleed Matrix&#39;</span><span class="p">,</span> <span class="s1">&#39;Bleed Matrix after Scaled K Means 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Bleed Matrix after Scaled K Means 2&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bleed_matrix_anneal&#39;</span><span class="p">]:</span>
        <span class="n">titles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bleed Matrix after Scaled K Means&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plots</span><span class="p">):</span>
        <span class="n">box_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">debug_info</span><span class="p">[</span><span class="s1">&#39;cluster_score&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">debug_info</span><span class="p">[</span><span class="s1">&#39;cluster_ind&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_dyes</span><span class="p">)]</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">box_data</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_dyes</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">box_data</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="mi">25</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{:.1e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">box_data</span><span class="p">[</span><span class="n">d</span><span class="p">])),</span>
                          <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bleed_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_use_dyes</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_use_channels</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span>
                                 <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">dye_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_use_dyes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.15</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_use_dyes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">dye_names</span><span class="p">)[</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_dyes</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_use_channels</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dot Product to Best Dye Vector&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Dye&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">mid_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="mf">0.005</span><span class="p">,</span> <span class="n">mid_point</span> <span class="o">-</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.04</span><span class="p">])</span>  <span class="c1"># left, bottom, width, height</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title_start</span><span class="si">}</span><span class="s1">at </span><span class="si">{</span><span class="n">n_plots</span><span class="si">}</span><span class="s1"> different stages</span><span class="se">\n</span><span class="s1"> Box plots showing the dot product of spot round &#39;</span>
                 <span class="sa">f</span><span class="s1">&#39;vectors with the dye vector they best matched to in the bleed matrix&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bleed Matrix where each dye column was computed from all vectors assigned to that dye &#39;</span>
                       <span class="s1">&#39;in the boxplot above&#39;</span><span class="p">,</span>
                       <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../register/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Register" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Register
            </div>
          </div>
        </a>
      
      
        
        <a href="../omp/" class="md-footer__link md-footer__link--next" aria-label="Next: OMP" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              OMP
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://github.com/jduffield65/coppafish" target="_blank" rel="noopener" title="Github Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.expand", "content.tabs.link", "navigation.sections", "navigation.top"], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>