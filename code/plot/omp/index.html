
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../images/logo.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>OMP - coppafish</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coefficients" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="coppafish" class="md-header__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            coppafish
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OMP
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../config_setup/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../pipeline/overview/" class="md-tabs__link">
        Pipeline
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../setup/notebook/" class="md-tabs__link md-tabs__link--active">
        Code
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="coppafish" class="md-nav__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    coppafish
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config_setup/" class="md-nav__link">
        Setting up the Config File
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../run_code/" class="md-nav__link">
        Running the code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../view_results/" class="md-nav__link">
        Viewing the results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config/" class="md-nav__link">
        Config Default Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook_comments/" class="md-nav__link">
        Notebook Comments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/extract/" class="md-nav__link">
        Extract and Filter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/tile_details/" class="md-nav__link">
        Tile Detail
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/file_names/" class="md-nav__link">
        File Names
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Extract
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extract" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Extract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/deconvolution/" class="md-nav__link">
        Deconvolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/fstack/" class="md-nav__link">
        Fstack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/scale/" class="md-nav__link">
        Scale
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Find Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Find Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Find Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/check_spots/" class="md-nav__link">
        Check Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/detect/" class="md-nav__link">
        Detect
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Stitch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Stitch" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Stitch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/shift/" class="md-nav__link">
        Shift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/starting_shifts/" class="md-nav__link">
        Starting Shifts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/tile_origin/" class="md-nav__link">
        Tile Origin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stitch/check_shifts/" class="md-nav__link">
        Check Shifts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Register
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Register" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Register
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/check_transforms/" class="md-nav__link">
        Check Transforms
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Spot Colors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Spot Colors" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Spot Colors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spot_colors/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_7">
          Call Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Call Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          Call Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/background/" class="md-nav__link">
        Background
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/bleed_matrix/" class="md-nav__link">
        Bleed Matrix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/dot_product/" class="md-nav__link">
        Dot Product
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/qual_check/" class="md-nav__link">
        Quality Check
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_8" type="checkbox" id="__nav_4_8" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_8">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OMP" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          OMP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/coefs/" class="md-nav__link">
        Coefficients
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/spots/" class="md-nav__link">
        Spots
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_9" type="checkbox" id="__nav_4_9" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_9">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_9">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/run/" class="md-nav__link">
        Run
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/basic_info/" class="md-nav__link">
        Basic Info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/extract_run/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_10" type="checkbox" id="__nav_4_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_10">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_10">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/pciseq/" class="md-nav__link">
        pciSeq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/matlab/" class="md-nav__link">
        Matlab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/morphology/" class="md-nav__link">
        Morphology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/nd2/" class="md-nav__link">
        nd2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/npy/" class="md-nav__link">
        npy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/strel/" class="md-nav__link">
        Strel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_11" type="checkbox" id="__nav_4_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_11">
          Plot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_11">
          <span class="md-nav__icon md-icon"></span>
          Plot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../viewer/" class="md-nav__link">
        Viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../raw/" class="md-nav__link">
        Raw
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extract/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../call_spots/" class="md-nav__link">
        Call Spots
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        OMP
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coefficients" class="md-nav__link">
    Coefficients
  </a>
  
    <nav class="md-nav" aria-label="Coefficients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_omp" class="md-nav__link">
    view_omp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_omp_fit" class="md-nav__link">
    view_omp_fit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_coef_images" class="md-nav__link">
    get_coef_images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-shape" class="md-nav__link">
    Score Shape
  </a>
  
    <nav class="md-nav" aria-label="Score Shape">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_omp_score" class="md-nav__link">
    view_omp_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-histogram" class="md-nav__link">
    Score Histogram
  </a>
  
    <nav class="md-nav" aria-label="Score Histogram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#histogram_score" class="md-nav__link">
    histogram_score
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#histogram_2d_score" class="md-nav__link">
    histogram_2d_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#track-fit" class="md-nav__link">
    Track Fit
  </a>
  
    <nav class="md-nav" aria-label="Track Fit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.omp.track_fit.get_track_info" class="md-nav__link">
    get_track_info()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_12" type="checkbox" id="__nav_4_12" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_12">
          Separate Round Registration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Separate Round Registration" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_12">
          <span class="md-nav__icon md-icon"></span>
          Separate Round Registration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sep_round_reg/" class="md-nav__link">
        Sep round reg
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coefficients" class="md-nav__link">
    Coefficients
  </a>
  
    <nav class="md-nav" aria-label="Coefficients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_omp" class="md-nav__link">
    view_omp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_omp_fit" class="md-nav__link">
    view_omp_fit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_coef_images" class="md-nav__link">
    get_coef_images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-shape" class="md-nav__link">
    Score Shape
  </a>
  
    <nav class="md-nav" aria-label="Score Shape">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_omp_score" class="md-nav__link">
    view_omp_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-histogram" class="md-nav__link">
    Score Histogram
  </a>
  
    <nav class="md-nav" aria-label="Score Histogram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#histogram_score" class="md-nav__link">
    histogram_score
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#histogram_2d_score" class="md-nav__link">
    histogram_2d_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#track-fit" class="md-nav__link">
    Track Fit
  </a>
  
    <nav class="md-nav" aria-label="Track Fit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coppafish.plot.omp.track_fit.get_track_info" class="md-nav__link">
    get_track_info()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/jduffield65/coppafish/edit/master/docs/code/plot/omp.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>OMP</h1>

<h2 id="coefficients">Coefficients</h2>
<h3 id="view_omp"><code>view_omp</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to show omp coefficients of all genes in neighbourhood of spot.
Only genes for which a significant number of pixels are non-zero will be plotted.</p>
<div class="admonition warning">
<p class="admonition-title">Requires access to <code>nb.file_names.tile_dir</code></p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;omp&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>im_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Radius of image to be plotted for each gene.</p></td>
          <td>
                <code>8</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/omp/coefs.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span> <span class="n">im_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to show omp coefficients of all genes in neighbourhood of spot.</span>
<span class="sd">    Only genes for which a significant number of pixels are non-zero will be plotted.</span>

<span class="sd">    !!! warning &quot;Requires access to `nb.file_names.tile_dir`&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        im_size: Radius of image to be plotted for each gene.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coef_images</span><span class="p">,</span> <span class="n">min_global_yxz</span><span class="p">,</span> <span class="n">max_global_yxz</span> <span class="o">=</span> <span class="n">get_coef_images</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="p">[</span><span class="n">im_size</span><span class="p">,</span> <span class="n">im_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
        <span class="n">spot_score</span> <span class="o">=</span> <span class="n">omp_spot_score</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">omp</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp_multiplier&#39;</span><span class="p">],</span> <span class="n">spot_no</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;ref_spots&#39;</span>
        <span class="n">spot_score</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">gene_no</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">tile</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">spot_yxz</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">local_yxz</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">gene_name</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="p">[</span><span class="n">gene_no</span><span class="p">]</span>
    <span class="n">all_gene_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;BG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)]</span>
    <span class="n">spot_yxz_global</span> <span class="o">=</span> <span class="n">spot_yxz</span> <span class="o">+</span> <span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">n_genes</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">n_nonzero_pixels_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">im_size</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>  <span class="c1"># If 5 pixels non-zero, plot that gene</span>
    <span class="n">plot_genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coef_images</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">n_nonzero_pixels_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coef_images</span> <span class="o">=</span> <span class="n">coef_images</span><span class="p">[</span><span class="n">plot_genes</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">n_plot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_genes</span><span class="p">)</span>
    <span class="c1"># at most n_max_rows rows</span>
    <span class="k">if</span> <span class="n">n_plot</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">n_max_rows</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_max_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_plot</span><span class="p">)))</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_plot</span> <span class="o">/</span> <span class="n">n_max_rows</span><span class="p">))</span>
    <span class="n">subplot_row_columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_plot</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)),</span> <span class="n">n_cols</span><span class="p">]</span>
    <span class="n">fig_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">([</span><span class="n">n_cols</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="n">subplot_row_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coef_images</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">subplot_row_columns</span><span class="p">,</span> <span class="n">subplot_adjust</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="n">fig_size</span><span class="p">,</span>
                     <span class="n">cbar_pos</span><span class="o">=</span><span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">],</span> <span class="n">slider_pos</span><span class="o">=</span><span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">])</span>
    <span class="c1"># set x, y coordinates to be those of the global coordinate system</span>
    <span class="n">plot_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">min_global_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_global_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">min_global_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_global_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">):</span>
        <span class="c1"># Add cross-hair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">plot_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">plot_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                             <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plot_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spot_yxz_global</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                             <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">plot_extent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Add title</span>
        <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plot_genes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">all_gene_names</span><span class="p">[</span><span class="n">plot_genes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">plot_genes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">n_genes</span><span class="p">:</span>
            <span class="n">text_color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># If background, make grey</span>
            <span class="n">title_text</span> <span class="o">=</span> <span class="n">all_gene_names</span><span class="p">[</span><span class="n">plot_genes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">plot_genes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">gene_no</span><span class="p">:</span>
            <span class="n">text_color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text_color</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>  <span class="c1"># TODO: maybe make color same as used in plot for each gene</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">text_color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.32</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;OMP gene coefficients for spot </span><span class="si">{</span><span class="n">spot_no</span><span class="si">}</span><span class="s1"> (match&#39;</span>
                 <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">spot_score</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">gene_name</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                 <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h3 id="view_omp_fit"><code>view_omp_fit</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to run omp on a single pixel and see which genes fitted at which iteration.
Right-clicking on a particular bled code will cause <em>coppafish.plot.call_spots.dot_product.view_score</em>
to run, indicating how the dot product calculation for that iteration was performed.</p>
<p>Left-clicking on background image will cause coppafish.plot.call_spots.background.view_background to run,
indicating how the dot product calculation for performed.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;omp&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>dp_thresh</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>If None, will use value in omp section of config file.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>max_genes</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>If None, will use value in omp section of config file.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/omp/coefs.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span> <span class="n">dp_thresh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">max_genes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to run omp on a single pixel and see which genes fitted at which iteration.</span>
<span class="sd">    Right-clicking on a particular bled code will cause *coppafish.plot.call_spots.dot_product.view_score*</span>
<span class="sd">    to run, indicating how the dot product calculation for that iteration was performed.</span>

<span class="sd">    Left-clicking on background image will cause coppafish.plot.call_spots.background.view_background to run,</span>
<span class="sd">    indicating how the dot product calculation for performed.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        dp_thresh: If None, will use value in omp section of config file.</span>
<span class="sd">        max_genes: If None, will use value in omp section of config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">track_info</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="n">dp_thresh</span> <span class="o">=</span> <span class="n">get_track_info</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">dp_thresh</span><span class="p">,</span> <span class="n">max_genes</span><span class="p">)</span>
    <span class="c1"># Add info so can call view_dot_product</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nb</span> <span class="o">=</span> <span class="n">nb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span> <span class="o">=</span> <span class="n">track_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bled_codes</span> <span class="o">=</span> <span class="n">bled_codes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dp_thresh</span> <span class="o">=</span> <span class="n">dp_thresh</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_no</span> <span class="o">=</span> <span class="n">spot_no</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fitting_method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="n">n_genes</span><span class="p">,</span> <span class="n">n_use_rounds</span><span class="p">,</span> <span class="n">n_use_channels</span> <span class="o">=</span> <span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">n_residual_images</span> <span class="o">=</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">residual_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_residual_images</span><span class="p">)]</span>
    <span class="n">background_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_use_rounds</span><span class="p">,</span> <span class="n">n_use_channels</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_use_channels</span><span class="p">):</span>
        <span class="n">background_image</span> <span class="o">+=</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;background_codes&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;background_coefs&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
    <span class="n">background_image</span> <span class="o">=</span> <span class="n">background_image</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># allow for possibly adding background vector</span>
    <span class="c1"># TODO: Think may get index error if best gene ever was background_vector.</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bled_codes</span><span class="p">,</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;background_codes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">all_gene_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;BG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">]</span>
    <span class="n">gene_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">bled_codes</span><span class="p">[</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span>
                   <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_residual_images</span><span class="p">)]</span>
    <span class="n">all_images</span> <span class="o">=</span> <span class="n">residual_images</span> <span class="o">+</span> <span class="p">[</span><span class="n">background_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">gene_images</span>

    <span class="c1"># Plot all images</span>
    <span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">all_images</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_residual_images</span><span class="p">],</span> <span class="n">subplot_adjust</span><span class="o">=</span><span class="n">subplot_adjust</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

    <span class="c1"># label axis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">labels</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Round&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Color Channel&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Residual at each iteration of OMP for Spot </span><span class="si">{</span><span class="n">spot_no</span><span class="si">}</span><span class="s1">. &#39;</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;$\Delta_</span><span class="si">{thresh}</span><span class="s1">$ = &#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dp_thresh</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add titles for each subplot</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Initial&#39;</span><span class="p">,</span> <span class="s1">&#39;Post Background&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="n">titles</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Post &#39;</span> <span class="o">+</span> <span class="n">all_gene_names</span><span class="p">[</span><span class="n">g</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_residual_images</span><span class="p">):</span>
        <span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Res = </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">residual_images</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="n">titles</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Background&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_residual_images</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="n">titles</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">all_gene_names</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">titles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">titles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;$\Delta_{s&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;}$ = &#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;dot_product&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Make title red if dot product fell below dp_thresh or if best gene background</span>
    <span class="n">is_fail_thresh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_images</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_residual_images</span><span class="p">)):</span>
            <span class="c1"># failed if bad dot product, gene added is background or gene added has previously been added</span>
            <span class="n">is_fail_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;dot_product&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">dp_thresh</span> <span class="ow">or</span> \
                             <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">n_genes</span> <span class="ow">or</span> \
                             <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">is_fail_thresh</span><span class="p">:</span>
                <span class="n">text_color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text_color</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_images</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">is_fail_thresh</span><span class="p">:</span>
            <span class="n">text_color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text_color</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">text_color</span><span class="p">)</span>

    <span class="c1"># Add rectangles where added gene is intense</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_images</span><span class="p">)):</span>
        <span class="n">gene_coef</span> <span class="o">=</span> <span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">][</span><span class="n">track_info</span><span class="p">[</span><span class="s1">&#39;gene_added&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">intense_gene_cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gene_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">gene_coef</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">intense_gene_thresh</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intense_gene_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">n_residual_images</span><span class="p">]:</span>
                <span class="c1"># can&#39;t add rectangle to multiple axes hence second for loop</span>
                <span class="n">rectangle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">intense_gene_cr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">intense_gene_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rectangle</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">change_norm</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_calc</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">track_info</span> <span class="o">=</span> <span class="n">track_info</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h3 id="get_coef_images"><code>get_coef_images</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Gets image of <span class="arithmatex">\(yxz\)</span> dimension <code>(2*im_size[0]+1) x (2*im_size[1]+1) x (2*im_size[2]+1)</code> of the coefficients
fitted by omp for each gene.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p><em>Notebook</em> containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to get gene coefficient images for.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>im_size</code></td>
          <td>
                <code><span title="typing.List">List</span>[int]</code>
          </td>
          <td><p><span class="arithmatex">\(yxz\)</span> radius of image to get for each gene.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>coef_images</code> - <code>float16 [n_genes x (2*im_size[0]+1) x (2*im_size[1]+1) x (2*im_size[2]+1)]</code>.
Image for each gene, axis order is <span class="arithmatex">\(gyxz\)</span>.
<code>coef_images[g, 0, 0, 0]</code> refers to coefficient of gene g at <code>global_yxz = min_global_yxz</code>.
<code>coef_images[g, -1, -1, -1]</code> refers to coefficient of gene g at <code>global_yxz = max_global_yxz</code>.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[float]</code>
          </td>
          <td><p><code>min_global_yxz</code> - <code>float [3]</code>. Min <span class="arithmatex">\(yxz\)</span> coordinates of image in global coordinates.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[float]</code>
          </td>
          <td><p><code>max_global_yxz</code> - <code>float [3]</code>. Max <span class="arithmatex">\(yxz\)</span> coordinates of image in global coordinates.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/omp/coefs.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coef_images</span><span class="p">(</span><span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">im_size</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                                                                                          <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets image of $yxz$ dimension `(2*im_size[0]+1) x (2*im_size[1]+1) x (2*im_size[2]+1)` of the coefficients</span>
<span class="sd">    fitted by omp for each gene.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: *Notebook* containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to get gene coefficient images for.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        im_size: $yxz$ radius of image to get for each gene.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `coef_images` - `float16 [n_genes x (2*im_size[0]+1) x (2*im_size[1]+1) x (2*im_size[2]+1)]`.</span>
<span class="sd">            Image for each gene, axis order is $gyxz$.</span>
<span class="sd">            `coef_images[g, 0, 0, 0]` refers to coefficient of gene g at `global_yxz = min_global_yxz`.</span>
<span class="sd">            `coef_images[g, -1, -1, -1]` refers to coefficient of gene g at `global_yxz = max_global_yxz`.</span>
<span class="sd">        `min_global_yxz` - `float [3]`. Min $yxz$ coordinates of image in global coordinates.</span>
<span class="sd">        `max_global_yxz` - `float [3]`. Max $yxz$ coordinates of image in global coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                        <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;ref_spots&#39;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">tile</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="n">spot_yxz</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">local_yxz</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>

    <span class="c1"># Subtlety here, may have y-axis flipped, but I think it is correct:</span>
    <span class="c1"># note im_yxz[1] refers to point at max_y, min_x+1, z. So when reshape and set plot_extent, should be correct.</span>
    <span class="c1"># I.e. im = np.zeros(49); im[1] = 1; im = im.reshape(7,7); plt.imshow(im, extent=[-0.5, 6.5, -0.5, 6.5])</span>
    <span class="c1"># will show the value 1 at max_y, min_x+1.</span>
    <span class="n">im_yxz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spot_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spot_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spot_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spot_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">spot_yxz</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">im_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">im_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">im_yxz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">im_yxz</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">z</span><span class="p">])</span>
    <span class="n">im_diameter_yx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">spot_colors</span> <span class="o">=</span> <span class="n">get_spot_colors</span><span class="p">(</span><span class="n">im_yxz</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">file_names</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="p">)</span> <span class="o">/</span> <span class="n">color_norm</span>

    <span class="c1"># Only look at pixels with high enough intensity - same as in full pipeline</span>
    <span class="n">spot_intensity</span> <span class="o">=</span> <span class="n">get_spot_intensity</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">))</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;omp&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nb</span><span class="o">.</span><span class="n">has_page</span><span class="p">(</span><span class="s1">&#39;omp&#39;</span><span class="p">):</span>
        <span class="n">initial_intensity_thresh</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">omp</span><span class="o">.</span><span class="n">initial_intensity_thresh</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial_intensity_thresh</span> <span class="o">=</span> <span class="n">get_initial_intensity_thresh</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="p">)</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="n">spot_intensity</span> <span class="o">&gt;</span> <span class="n">initial_intensity_thresh</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span>
    <span class="n">n_genes</span> <span class="o">=</span> <span class="n">bled_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bled_codes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_genes</span><span class="p">),</span>
                                              <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)])</span>
    <span class="n">n_use_rounds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">)</span>
    <span class="n">dp_norm_shift</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">)</span>

    <span class="n">dp_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dp_thresh&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_call_spots</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;call_spots&#39;</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">config_call_spots</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">config_call_spots</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
    <span class="n">max_genes</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_genes&#39;</span><span class="p">]</span>
    <span class="n">weight_coef_fit</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;weight_coef_fit&#39;</span><span class="p">]</span>

    <span class="n">all_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">spot_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_genes</span> <span class="o">+</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">n_channels</span><span class="p">))</span>
    <span class="n">all_coefs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_genes</span><span class="p">))],</span> \
    <span class="n">all_coefs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_genes</span><span class="p">)]</span> <span class="o">=</span> \
        <span class="n">get_all_coefs</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">[</span><span class="n">keep</span><span class="p">],</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">background_weight_shift</span><span class="p">,</span> <span class="n">dp_norm_shift</span><span class="p">,</span>
                      <span class="n">dp_thresh</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">max_genes</span><span class="p">,</span> <span class="n">weight_coef_fit</span><span class="p">)</span>

    <span class="n">n_genes</span> <span class="o">=</span> <span class="n">all_coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">coef_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_genes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">im_diameter_yx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">im_diameter_yx</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_genes</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="n">coef_images</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_coefs</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">im_diameter_yx</span><span class="p">),</span> <span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_diameter_yx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                      <span class="n">im_diameter_yx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ind</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">im_diameter_yx</span><span class="p">)</span>
    <span class="n">coef_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">coef_images</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># move z index to end</span>
    <span class="n">min_global_yxz</span> <span class="o">=</span> <span class="n">im_yxz</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">max_global_yxz</span> <span class="o">=</span> <span class="n">im_yxz</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">nb</span><span class="o">.</span><span class="n">stitch</span><span class="o">.</span><span class="n">tile_origin</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">coef_images</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">),</span> <span class="n">min_global_yxz</span><span class="p">,</span> <span class="n">max_global_yxz</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="score-shape">Score Shape</h2>
<h3 id="view_omp_score"><code>view_omp_score</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>Diagnostic to show how score is computed in the omp method
Hatched region in top plot shows pixels which contribute to the final score.
Score is actually equal to the absolute sum of the top plots in the hatched regions.</p>
<p>Can also see how <code>score_omp_multiplier</code> affects the final score. The larger this is, the more
the positive pixels contribute compared to the negative.</p>
<div class="admonition warning">
<p class="admonition-title">Requires access to <code>nb.file_names.tile_dir</code></p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.notebook.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to be plotted.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;omp&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>score_multiplier</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Initial value of <code>score_omp_multiplier</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>check</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If <code>True</code>, will compare score found to that saved in <em>Notebook</em> and raise error if they differ.
Will also check that absolute sum of the top plots in the hatched regions is equal to
score calculated from counting the number of pixels with the correct sign.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/omp/score_shape.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span> <span class="n">score_multiplier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic to show how score is computed in the omp method</span>
<span class="sd">    Hatched region in top plot shows pixels which contribute to the final score.</span>
<span class="sd">    Score is actually equal to the absolute sum of the top plots in the hatched regions.</span>

<span class="sd">    Can also see how `score_omp_multiplier` affects the final score. The larger this is, the more</span>
<span class="sd">    the positive pixels contribute compared to the negative.</span>

<span class="sd">    !!! warning &quot;Requires access to `nb.file_names.tile_dir`&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to be plotted.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        score_multiplier: Initial value of `score_omp_multiplier`.</span>
<span class="sd">        check: If `True`, will compare score found to that saved in *Notebook* and raise error if they differ.</span>
<span class="sd">            Will also check that absolute sum of the top plots in the hatched regions is equal to</span>
<span class="sd">            score calculated from counting the number of pixels with the correct sign.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: The textbox for this plot seems to be much less responsive than in the other diagnostics</span>
    <span class="c1">#  for some reason.</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;ref_spots&#39;</span>
        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check</span> <span class="o">=</span> <span class="n">check</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">omp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spot_no</span> <span class="o">=</span> <span class="n">spot_no</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[</span><span class="n">spot_no</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">expected_sign_image</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">omp</span><span class="o">.</span><span class="n">spot_shape</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_sign_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">im_radius</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_sign_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coef_images</span><span class="p">,</span> <span class="n">min_global_yxz</span><span class="p">,</span> <span class="n">max_global_yxz</span> <span class="o">=</span> <span class="n">get_coef_images</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">im_radius</span><span class="p">)</span>
    <span class="c1"># Find where sign of coef image matches that of expected sign image</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">both_positive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_images</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_sign_image</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">both_negative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_images</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_sign_image</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_neighbours</span><span class="p">()</span>

    <span class="c1"># Start with default multiplier</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">score_multiplier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">score_multiplier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp_multiplier&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span> <span class="o">=</span> <span class="n">score_multiplier</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp&#39;</span><span class="p">]</span>

    <span class="c1"># maximum possible value of any one pixel in expected_shape for any score_multiplier</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vmax_expected</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_sign_image</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_sign_image</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vmax_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_images</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Initialize plots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">min_global_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">max_global_yxz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">min_global_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">max_global_yxz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">bottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">expected_image_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_image</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">expected_image_plot</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">expected_image_plot</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span>
                                       <span class="n">vmin</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">vmax_expected</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vmax_expected</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span>
                                       <span class="n">extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_extent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_images</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span>
                                                         <span class="n">vmin</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">vmax_coef</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vmax_coef</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span>
                                                         <span class="n">extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_extent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected Coefficient Sign</span><span class="se">\n</span><span class="s2">Z=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">min_global_yxz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Z=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">min_global_yxz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_coef_plot_title</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_hatching</span><span class="p">()</span>

    <span class="c1"># Set up colorbars for each plot</span>
    <span class="n">mid_point</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">gap_size</span> <span class="o">=</span> <span class="mf">0.08</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">mid_point</span><span class="o">+</span><span class="n">gap_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="mf">0.005</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">mid_point</span><span class="o">-</span><span class="n">gap_size</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># left, bottom, width, height</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">gap_size</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span>
                                 <span class="mf">0.005</span><span class="p">,</span> <span class="n">mid_point</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">gap_size</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># left, bottom, width, height</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

    <span class="c1"># Add titles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OMP Score Calculation for Spot </span><span class="si">{</span><span class="n">spot_no</span><span class="si">}</span><span class="s2">, Gene </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add text box to change score multiplier</span>
    <span class="n">text_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.062</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">gap_size</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span>
                                 <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_box</span> <span class="o">=</span> <span class="n">TextBox</span><span class="p">(</span><span class="n">text_ax</span><span class="p">,</span> <span class="s1">&#39;Score</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;Multiplier, $\rho$&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">hovercolor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_box</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">text_ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># label is a child of the TextBox axis</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.75</span><span class="p">])</span>  <span class="c1"># [x,y] - change here to set the position</span>
    <span class="c1"># centering the text</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_box</span><span class="o">.</span><span class="n">on_submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="score-histogram">Score Histogram</h2>
<h3 id="histogram_score"><code>histogram_score</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>If method is anchor, this will show the histogram of <code>nb.ref_spots.score</code> with the option to
view the histogram of the score computed using various other configurations of <code>background</code> fitting
and <code>gene_efficiency</code>. This allows one to see how the these affect the score.</p>
<p>If <code>method</code> is omp, this will show the histogram of omp score, computed with
<code>coppafish.call_spots.omp_spot_score</code>.
There will also be the option to view the histograms shown for the anchor method.
I.e. we compute the dot product score for the omp spots.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p><em>Notebook</em> containing at least <code>call_spots</code> page.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
                <code>&#39;omp&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>score_omp_multiplier</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Can specify the value of score_omp_multiplier to use to compute omp score.
If <code>None</code>, will use value in config file.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>check</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If <code>True</code>, and <code>method='anchor'</code>, will check that scores computed here match those saved to Notebook.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>hist_spacing</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Initial width of bin in histogram.</p></td>
          <td>
                <code>0.001</code>
          </td>
        </tr>
        <tr>
          <td><code>show_plot</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to run <code>plt.show()</code> or not.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/omp/score_hist.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span> <span class="n">score_omp_multiplier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">hist_spacing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">show_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If method is anchor, this will show the histogram of `nb.ref_spots.score` with the option to</span>
<span class="sd">    view the histogram of the score computed using various other configurations of `background` fitting</span>
<span class="sd">    and `gene_efficiency`. This allows one to see how the these affect the score.</span>

<span class="sd">    If `method` is omp, this will show the histogram of omp score, computed with</span>
<span class="sd">    `coppafish.call_spots.omp_spot_score`.</span>
<span class="sd">    There will also be the option to view the histograms shown for the anchor method.</span>
<span class="sd">    I.e. we compute the dot product score for the omp spots.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: *Notebook* containing at least `call_spots` page.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        score_omp_multiplier: Can specify the value of score_omp_multiplier to use to compute omp score.</span>
<span class="sd">            If `None`, will use value in config file.</span>
<span class="sd">        check: If `True`, and `method=&#39;anchor&#39;`, will check that scores computed here match those saved to Notebook.</span>
<span class="sd">        hist_spacing: Initial width of bin in histogram.</span>
<span class="sd">        show_plot: Whether to run `plt.show()` or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add data</span>
    <span class="k">if</span> <span class="n">score_omp_multiplier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
        <span class="n">score_omp_multiplier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;score_omp_multiplier&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span> <span class="o">=</span> <span class="n">score_omp_multiplier</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">gene_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_names</span><span class="o">.</span><span class="n">size</span>
    <span class="c1"># Use all genes by default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genes_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">)</span>

    <span class="c1"># For computing score_dp</span>
    <span class="n">spot_colors</span><span class="p">,</span> <span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">background_var</span> <span class="o">=</span> <span class="n">background_fitting</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="n">grc_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_genes</span><span class="p">),</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)</span>
    <span class="c1"># Bled codes saved to Notebook should already have L2 norm = 1 over used_channels and rounds</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes</span><span class="p">[</span><span class="n">grc_ind</span><span class="p">]</span>
    <span class="n">bled_codes_ge</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">[</span><span class="n">grc_ind</span><span class="p">]</span>

    <span class="c1"># Save score_dp for each permutation of with/without background/gene_efficiency</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">omp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span><span class="o">.</span><span class="n">gene_no</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">omp_spot_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbp_omp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;OMP&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">gene_no</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Anchor&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">genes_use</span><span class="p">)</span>  <span class="c1"># which spots to plot</span>
    <span class="c1"># DP score</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">bled_codes_ge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span>
                                             <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span><span class="p">,</span> <span class="n">background_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;omp&#39;</span> <span class="ow">and</span> <span class="n">check</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">))</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_tol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nb.ref_spots.score differs to that computed here</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Set check=False to get past this error&quot;</span><span class="p">)</span>

    <span class="c1"># DP score no weight</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">bled_codes_ge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span>
                                             <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span><span class="p">,</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># DP score no background</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">,</span> <span class="n">bled_codes_ge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span>
                                             <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span><span class="p">,</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># DP score no gene efficiency</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors_pb</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span>
                                             <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span><span class="p">,</span> <span class="n">background_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># DP score no background or gene efficiency</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dot_product_score</span><span class="p">(</span><span class="n">spot_colors</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_no</span><span class="p">,</span>
                                             <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span><span class="p">,</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Initialise plot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">bottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Number of Spots&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Score, $\gamma_s$ or $\Delta_s$&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Score, $\Delta_s$&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribution of Scores for all </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> spots&quot;</span><span class="p">)</span>

    <span class="c1"># Set lower bound based on dot product score with no GE/no background as likely to be lowest</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hist_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># Set upper bound based on dot product score with GE and background because this is likely to be highest</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hist_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">99.9</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span> <span class="o">=</span> <span class="n">hist_spacing</span>
    <span class="n">hist_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_max</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span>
    <span class="n">default_colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_left</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span><span class="p">):</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">use</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">hist_bins</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># so same length as x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_max</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Add text box to change score multiplier</span>
    <span class="n">text_box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span> <span class="s1">&#39;Histogram</span><span class="se">\n</span><span class="s1">Spacing&#39;</span><span class="p">,</span> <span class="s1">&#39;Score</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Multiplier, $\rho$&#39;</span><span class="p">]</span>
    <span class="n">text_box_values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_multiplier</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
    <span class="n">text_box_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">update_genes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_hist_spacing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_score_multiplier</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">text_box_labels</span> <span class="o">=</span> <span class="n">text_box_labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">text_box_values</span> <span class="o">=</span> <span class="n">text_box_values</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">text_box_funcs</span> <span class="o">=</span> <span class="n">text_box_funcs</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)):</span>
        <span class="n">text_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_box_labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TextBox</span><span class="p">(</span><span class="n">text_ax</span><span class="p">,</span> <span class="n">text_box_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">text_box_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                     <span class="n">hovercolor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">text_ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># label is a child of the TextBox axis</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.77</span><span class="p">])</span>  <span class="c1"># [x,y] - change here to set the position</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.75</span><span class="p">])</span>
            <span class="c1"># centering the text</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">on_submit</span><span class="p">(</span><span class="n">text_box_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Add buttons to add/remove score_dp histograms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttons_ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot_adjust</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\Delta_s$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dot Product Score&quot;</span><span class="p">,</span>
                          <span class="sa">r</span><span class="s2">&quot;$\Delta_s$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No Weighting&quot;</span><span class="p">,</span>
                          <span class="sa">r</span><span class="s2">&quot;$\Delta_s$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No Background&quot;</span><span class="p">,</span>
                          <span class="sa">r</span><span class="s2">&quot;$\Delta_s$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No Gene Efficiency&quot;</span><span class="p">,</span>
                          <span class="sa">r</span><span class="s2">&quot;$\Delta_s$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No Background</span><span class="se">\n</span><span class="s2">No Gene Efficiency&quot;</span><span class="p">]</span>
    <span class="n">label_checked</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\gamma_s$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OMP Score&quot;</span><span class="p">]</span>
        <span class="n">label_checked</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
        <span class="n">label_checked</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span> <span class="o">=</span> <span class="n">CheckButtons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buttons_ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span><span class="p">,</span> <span class="n">label_checked</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">default_colors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">rectangles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="o">.</span><span class="n">on_clicked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_plots</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h3 id="histogram_2d_score"><code>histogram_2d_score</code></h3>


<div class="doc doc-object doc-function">



  <div class="doc doc-contents first">
  
      <p>This plots the bivariate histogram to see the correlation between the omp spot score, <span class="arithmatex">\(\gamma_s\)</span> and
the dot product score <span class="arithmatex">\(\Delta_s\)</span>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p><em>Notebook</em> containing at least <code>call_spots</code> page.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>score_omp_multiplier</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Can specify the value of score_omp_multiplier to use to compute omp score.
If <code>None</code>, will use value in config file.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/omp/score_hist.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">score_omp_multiplier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This plots the bivariate histogram to see the correlation between the omp spot score, $\gamma_s$ and</span>
<span class="sd">    the dot product score $\Delta_s$.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: *Notebook* containing at least `call_spots` page.</span>
<span class="sd">        score_omp_multiplier: Can specify the value of score_omp_multiplier to use to compute omp score.</span>
<span class="sd">            If `None`, will use value in config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># large hist_spacing so quick as we change it anway</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="s1">&#39;omp&#39;</span><span class="p">,</span> <span class="n">score_omp_multiplier</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1"># Get rid of buttons - only use actual dot product score</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttons_ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_plots</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">plots</span>
    <span class="n">hist_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_max</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_score_ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_score_ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hist_bins</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_max</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_max</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_spacing</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><h2 id="track-fit">Track Fit</h2>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="coppafish.plot.omp.track_fit.get_track_info" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_track_info</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">dp_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This runs omp while tracking the residual at each stage.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nb</code></td>
          <td>
                <code><span title="coppafish.setup.Notebook">Notebook</span></code>
          </td>
          <td><p>Notebook containing experiment details. Must have run at least as far as <code>call_reference_spots</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>spot_no</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Spot of interest to get track_info for.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><code>'anchor'</code> or <code>'omp'</code>.
Which method of gene assignment used i.e. <code>spot_no</code> belongs to <code>ref_spots</code> or <code>omp</code> page of Notebook.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dp_thresh</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>If None, will use value in omp section of config file.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>max_genes</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>If None, will use value in omp section of config file.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict</code>
          </td>
          <td><p><code>track_info</code> - dictionary containing info about genes added at each step returned:</p>
<ul>
<li><code>background_codes</code> - <code>float [n_channels x n_rounds x n_channels]</code>.
    <code>background_codes[c]</code> is the background vector for channel <code>c</code> with L2 norm of 1.</li>
<li><code>background_coefs</code> - <code>float [n_channels]</code>.
    <code>background_coefs[c]</code> is the coefficient value for <code>background_codes[c]</code>.</li>
<li><code>gene_added</code> - <code>int [n_genes_added + 2]</code>.
    <code>gene_added[0]</code> and <code>gene_added[1]</code> are -1.
    <code>gene_added[2+i]</code> is the <code>ith</code> gene that was added.</li>
<li><code>residual</code> - <code>float [(n_genes_added + 2) x n_rounds x n_channels]</code>.
    <code>residual[0]</code> is the initial <code>pixel_color</code>.
    <code>residual[1]</code> is the post background <code>pixel_color</code>.
    <code>residual[2+i]</code> is the <code>pixel_color</code> after removing gene <code>gene_added[2+i]</code>.</li>
<li><code>coef</code> - <code>float [(n_genes_added + 2) x n_genes]</code>.
    <code>coef[0]</code> and <code>coef[1]</code> are all 0.
    <code>coef[2+i]</code> are the coefficients for all genes after the ith gene has been added.</li>
<li><code>dot_product</code> - <code>float [n_genes_added + 2]</code>.
    <code>dot_product[0]</code> and <code>dot_product[1]</code> are 0.
    <code>dot_product[2+i]</code> is the dot product for the gene <code>gene_added[2+i]</code>.</li>
<li><code>inverse_var</code> - <code>float [(n_genes_added + 2) x n_rounds x n_channels]</code>.
    <code>inverse_var[0]</code> and <code>inverse_var[1]</code> are all 0.
    <code>inverse_var[2+i]</code> is the weighting used to compute <code>dot_product[2+i]</code>,
     which down-weights rounds/channels for which a gene has already been fitted.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>bled_codes</code> - <code>float [n_genes x n_use_rounds x n_use_channels]</code>.
gene <code>bled_codes</code> used in omp with L2 norm = 1.</p></td>
        </tr>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><p><code>dp_thresh</code> - threshold dot product score, above which gene is fitted.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/plot/omp/track_fit.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_track_info</span><span class="p">(</span><span class="n">nb</span><span class="p">:</span> <span class="n">Notebook</span><span class="p">,</span> <span class="n">spot_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dp_thresh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">max_genes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This runs omp while tracking the residual at each stage.</span>

<span class="sd">    Args:</span>
<span class="sd">        nb: Notebook containing experiment details. Must have run at least as far as `call_reference_spots`.</span>
<span class="sd">        spot_no: Spot of interest to get track_info for.</span>
<span class="sd">        method: `&#39;anchor&#39;` or `&#39;omp&#39;`.</span>
<span class="sd">            Which method of gene assignment used i.e. `spot_no` belongs to `ref_spots` or `omp` page of Notebook.</span>
<span class="sd">        dp_thresh: If None, will use value in omp section of config file.</span>
<span class="sd">        max_genes: If None, will use value in omp section of config file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `track_info` - dictionary containing info about genes added at each step returned:</span>

<span class="sd">            - `background_codes` - `float [n_channels x n_rounds x n_channels]`.</span>
<span class="sd">                `background_codes[c]` is the background vector for channel `c` with L2 norm of 1.</span>
<span class="sd">            - `background_coefs` - `float [n_channels]`.</span>
<span class="sd">                `background_coefs[c]` is the coefficient value for `background_codes[c]`.</span>
<span class="sd">            - `gene_added` - `int [n_genes_added + 2]`.</span>
<span class="sd">                `gene_added[0]` and `gene_added[1]` are -1.</span>
<span class="sd">                `gene_added[2+i]` is the `ith` gene that was added.</span>
<span class="sd">            - `residual` - `float [(n_genes_added + 2) x n_rounds x n_channels]`.</span>
<span class="sd">                `residual[0]` is the initial `pixel_color`.</span>
<span class="sd">                `residual[1]` is the post background `pixel_color`.</span>
<span class="sd">                `residual[2+i]` is the `pixel_color` after removing gene `gene_added[2+i]`.</span>
<span class="sd">            - `coef` - `float [(n_genes_added + 2) x n_genes]`.</span>
<span class="sd">                `coef[0]` and `coef[1]` are all 0.</span>
<span class="sd">                `coef[2+i]` are the coefficients for all genes after the ith gene has been added.</span>
<span class="sd">            - `dot_product` - `float [n_genes_added + 2]`.</span>
<span class="sd">                `dot_product[0]` and `dot_product[1]` are 0.</span>
<span class="sd">                `dot_product[2+i]` is the dot product for the gene `gene_added[2+i]`.</span>
<span class="sd">            - `inverse_var` - `float [(n_genes_added + 2) x n_rounds x n_channels]`.</span>
<span class="sd">                `inverse_var[0]` and `inverse_var[1]` are all 0.</span>
<span class="sd">                `inverse_var[2+i]` is the weighting used to compute `dot_product[2+i]`,</span>
<span class="sd">                 which down-weights rounds/channels for which a gene has already been fitted.</span>
<span class="sd">        `bled_codes` - `float [n_genes x n_use_rounds x n_use_channels]`.</span>
<span class="sd">            gene `bled_codes` used in omp with L2 norm = 1.</span>
<span class="sd">        `dp_thresh` - threshold dot product score, above which gene is fitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_norm</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">color_norm_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span>
                                                        <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span>
    <span class="n">n_use_rounds</span><span class="p">,</span> <span class="n">n_use_channels</span> <span class="o">=</span> <span class="n">color_norm</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;omp&#39;</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
        <span class="n">config_name</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_name</span> <span class="o">=</span> <span class="s1">&#39;ref_spots&#39;</span>
        <span class="n">config_name</span> <span class="o">=</span> <span class="s1">&#39;call_spots&#39;</span>
    <span class="n">spot_color</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">spot_no</span><span class="p">][</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)]</span> <span class="o">/</span> <span class="n">color_norm</span>
    <span class="n">n_genes</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_genes</span><span class="p">),</span>
                                           <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_channels</span><span class="p">)])</span>
    <span class="c1"># ensure L2 norm is 1 for bled codes</span>
    <span class="n">norm_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bled_codes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">norm_factor</span><span class="p">[</span><span class="n">norm_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># For genes with no dye in use_dye, this avoids blow up on next line</span>
    <span class="n">bled_codes</span> <span class="o">=</span> <span class="n">bled_codes</span> <span class="o">/</span> <span class="n">norm_factor</span>

    <span class="c1"># Get info to run omp</span>
    <span class="n">dp_norm_shift</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">dp_norm_shift</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_use_rounds</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dp_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dp_thresh</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;omp&#39;</span><span class="p">][</span><span class="s1">&#39;dp_thresh&#39;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">max_genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_genes</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;omp&#39;</span><span class="p">][</span><span class="s1">&#39;max_genes&#39;</span><span class="p">]</span>
    <span class="n">weight_coef_fit</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;omp&#39;</span><span class="p">][</span><span class="s1">&#39;weight_coef_fit&#39;</span><span class="p">]</span>

    <span class="c1"># Run omp with track to get residual at each stage</span>
    <span class="n">track_info</span> <span class="o">=</span> <span class="n">get_all_coefs</span><span class="p">(</span><span class="n">spot_color</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">background_weight_shift</span><span class="p">,</span>
                               <span class="n">dp_norm_shift</span><span class="p">,</span> <span class="n">dp_thresh</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">max_genes</span><span class="p">,</span> <span class="n">weight_coef_fit</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">track_info</span><span class="p">,</span> <span class="n">bled_codes</span><span class="p">,</span> <span class="n">dp_thresh</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../call_spots/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Call Spots" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Call Spots
            </div>
          </div>
        </a>
      
      
        
        <a href="../../sep_round_reg/" class="md-footer__link md-footer__link--next" aria-label="Next: Sep round reg" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Sep round reg
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://github.com/jduffield65/coppafish" target="_blank" rel="noopener" title="Github Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.expand", "content.tabs.link", "navigation.sections", "navigation.top"], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>