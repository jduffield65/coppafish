
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../images/logo.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>Shift - coppafish</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coppafish.stitch.shift.compute_shift" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="coppafish" class="md-header__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            coppafish
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Shift
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../config_setup/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../pipeline/overview/" class="md-tabs__link">
        Pipeline
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../setup/notebook/" class="md-tabs__link md-tabs__link--active">
        Code
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="coppafish" class="md-nav__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../../images/logo.png" alt="logo">

    </a>
    coppafish
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config_setup/" class="md-nav__link">
        Setting up the Config File
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../run_code/" class="md-nav__link">
        Running the code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../view_results/" class="md-nav__link">
        Viewing the results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../config/" class="md-nav__link">
        Config Default Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebook_comments/" class="md-nav__link">
        Notebook Comments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/extract/" class="md-nav__link">
        Extract and Filter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/tile_details/" class="md-nav__link">
        Tile Detail
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/file_names/" class="md-nav__link">
        File Names
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Extract
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extract" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Extract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/deconvolution/" class="md-nav__link">
        Deconvolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/fstack/" class="md-nav__link">
        Fstack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extract/scale/" class="md-nav__link">
        Scale
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Find Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Find Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Find Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/check_spots/" class="md-nav__link">
        Check Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../find_spots/detect/" class="md-nav__link">
        Detect
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Stitch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Stitch" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Stitch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Shift
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Shift
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.compute_shift" class="md-nav__link">
    compute_shift()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.extend_array" class="md-nav__link">
    extend_array()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_2d_slices" class="md-nav__link">
    get_2d_slices()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_best_shift_2d" class="md-nav__link">
    get_best_shift_2d()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_best_shift_3d" class="md-nav__link">
    get_best_shift_3d()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_score_thresh" class="md-nav__link">
    get_score_thresh()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.refined_shifts" class="md-nav__link">
    refined_shifts()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.shift_score" class="md-nav__link">
    shift_score()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.update_shifts" class="md-nav__link">
    update_shifts()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../starting_shifts/" class="md-nav__link">
        Starting Shifts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tile_origin/" class="md-nav__link">
        Tile Origin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../check_shifts/" class="md-nav__link">
        Check Shifts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Register
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Register" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Register
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../register/check_transforms/" class="md-nav__link">
        Check Transforms
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Spot Colors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Spot Colors" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Spot Colors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spot_colors/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_7">
          Call Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Call Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          Call Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/background/" class="md-nav__link">
        Background
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/bleed_matrix/" class="md-nav__link">
        Bleed Matrix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/dot_product/" class="md-nav__link">
        Dot Product
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../call_spots/qual_check/" class="md-nav__link">
        Quality Check
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_8" type="checkbox" id="__nav_4_8" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_8">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OMP" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          OMP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/coefs/" class="md-nav__link">
        Coefficients
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../omp/spots/" class="md-nav__link">
        Spots
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_9" type="checkbox" id="__nav_4_9" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_9">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_9">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/run/" class="md-nav__link">
        Run
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/basic_info/" class="md-nav__link">
        Basic Info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/extract_run/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_10" type="checkbox" id="__nav_4_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_10">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_10">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/pciseq/" class="md-nav__link">
        pciSeq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/matlab/" class="md-nav__link">
        Matlab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/morphology/" class="md-nav__link">
        Morphology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/nd2/" class="md-nav__link">
        nd2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/npy/" class="md-nav__link">
        npy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/strel/" class="md-nav__link">
        Strel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_11" type="checkbox" id="__nav_4_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_11">
          Plot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_11">
          <span class="md-nav__icon md-icon"></span>
          Plot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/viewer/" class="md-nav__link">
        Viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/raw/" class="md-nav__link">
        Raw
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/extract/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/call_spots/" class="md-nav__link">
        Call Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_12" type="checkbox" id="__nav_4_12" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_12">
          Separate Round Registration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Separate Round Registration" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_12">
          <span class="md-nav__icon md-icon"></span>
          Separate Round Registration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sep_round_reg/" class="md-nav__link">
        Sep round reg
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.compute_shift" class="md-nav__link">
    compute_shift()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.extend_array" class="md-nav__link">
    extend_array()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_2d_slices" class="md-nav__link">
    get_2d_slices()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_best_shift_2d" class="md-nav__link">
    get_best_shift_2d()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_best_shift_3d" class="md-nav__link">
    get_best_shift_3d()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.get_score_thresh" class="md-nav__link">
    get_score_thresh()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.refined_shifts" class="md-nav__link">
    refined_shifts()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.shift_score" class="md-nav__link">
    shift_score()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coppafish.stitch.shift.update_shifts" class="md-nav__link">
    update_shifts()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/jduffield65/coppafish/edit/master/docs/code/stitch/shift.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Shift</h1>

<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.compute_shift" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_shift</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform</span><span class="p">,</span> <span class="n">min_score_2d</span><span class="p">,</span> <span class="n">min_score_multiplier</span><span class="p">,</span> <span class="n">min_score_min_dist</span><span class="p">,</span> <span class="n">min_score_max_dist</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">z_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">widen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nz_collapse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_step</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This finds the shift from those given that is best applied to <code>yxz_base</code> to match <code>yxz_transform</code>.</p>
<p>If the <code>score</code> of this is below <code>min_score_2d</code>, a widened search is performed.
If the <code>score</code> is above <code>min_score_2d</code>, a refined search is done about the best shift so as to find the absolute
best shift, not the best shift among those given.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>yxz_base</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>int [n_spots_base x 3]</code>.
Coordinates of spots on base image (yx in yx pixel units, z in z pixel units).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>yxz_transform</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>int [n_spots_transform x 3]</code>.
Coordinates of spots on transformed image (yx in yx pixel units, z in z pixel units).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_score_2d</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>If score of best shift is below this, will search among the widened shifts.
If <code>None</code>, <code>min_score_2d</code> will be computed using <code>get_score_thresh</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_score_multiplier</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>Parameter used to find <code>min_score_2d</code> and <code>min_score_3d</code> if not given.
Typical = <code>1.5</code> (definitely more than <code>1</code>).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_score_min_dist</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p><code>min_score_2d</code> is set to max score of those scores for shifts a distance between <code>min_dist</code>
and <code>max_dist</code> from the best_shift.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_score_max_dist</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p><code>min_score_2d</code> is set to max score of those scores for shifts a distance between <code>min_dist</code>
and <code>max_dist</code> from the best_shift.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>neighb_dist_thresh</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Basically the distance below which neighbours are a good match.
Typical = <code>2</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_y_shifts]</code>.
All possible shifts to test in y direction, probably made with <code>np.arange</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>x_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_x_shifts]</code>.
All possible shifts to test in x direction, probably made with <code>np.arange</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>z_shifts</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p><code>float [n_z_shifts]</code>.
All possible shifts to test in z direction, probably made with <code>np.arange</code>.
If not given, will compute automatically from initial guess when making slices and <code>z_step</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>widen</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[int]]</code>
          </td>
          <td><p><code>int [3]</code>.
By how many shifts to extend search in <code>[y, x, z]</code> direction if score below <code>min_score</code>.
This many are added above and below current range.
If all widen parameters are <code>0</code>, widened search is never performed.
If <code>None</code>, set to <code>[0, 0, 0]</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>max_range</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[int]]</code>
          </td>
          <td><p><code>int [3]</code>.
The range of shifts searched over will continue to be increased according to <code>widen</code> until
the <code>max_range</code> is reached in each dimension.
If a good shift is still not found, the best shift will still be returned without error.
If None and widen supplied, range will only be widened once.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>z_scale</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[float, <span title="typing.List">List</span>]</code>
          </td>
          <td><p>By what scale factor to multiply z coordinates to make them same units as xy.
I.e. <code>z_pixel_size / xy_pixel_size</code>.
If one value, given same scale used for yxz_base and yxz_transform.
Otherwise, first value used for yxz_base and second for yxz_transform.</p></td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>nz_collapse</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>Maximum number of z-planes allowed to be flattened into a 2D slice.
If <code>None</code>, <code>n_slices</code>=1. Should be <code>None</code> for 2D data.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>z_step</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p><code>int</code>.
Step of shift search in z direction in uints of <code>z_pixels</code>.
<code>z_shifts</code> are computed automatically as 1 shift either side of an initial guess.</p></td>
          <td>
                <code>3</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><ul>
<li><code>best_shift</code> - <code>float [shift_y, shift_x, shift_z]</code>.
Best shift found.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><ul>
<li><code>best_score</code> - <code>float</code>.
Score of best shift.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><ul>
<li><code>min_score_3d</code> - <code>float</code>.
Same as <code>min_score_2d</code>, unless input was <code>None</code> in which case this is the calculated value.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code>dict</code>
          </td>
          <td><ul>
<li><code>debug_info</code> - dict containing debugging information:</li>
<li><code>shifts_2d</code>: <code>int [n_shifts_2d x 2]</code>
    All yx shifts searched to get best <code>yx_shift</code>.</li>
<li><code>scores_2d</code>: <code>float [n_shifts_2d]</code>
    Score corresponding to each 2d shift.</li>
<li><code>shifts_3d</code>: <code>int [n_shifts_3d x 3]</code>
    All yxz shifts searched to get best <code>yxz_shift</code>. <code>None</code> if <code>nz_collapse is None</code> i.e. 2D point cloud.</li>
<li><code>scores_3d</code>: <code>float [n_shifts_3d]</code>
    Score corresponding to each 3d shift. <code>None</code> if <code>nz_collapse is None</code> i.e. 2D point cloud.</li>
<li><code>shift_2d_initial</code>: <code>float [2]</code>
    Best shift found after first 2D search. I.e. annulus around this shift was used
    to compute <code>min_score_2d</code> and <code>shift_thresh</code>.</li>
<li><code>shift_thresh</code>: <code>int [3]</code>
    yxz shift corresponding to <code>min_score_3d</code>. Will be <code>None</code> if <code>min_score_2d</code> provided in advance.
    <code>shift_thresh[:2]</code> is the yx shift corresponding to <code>min_score_2d</code></li>
<li><code>min_score_2d</code>: Same as input <code>min_score_2d</code>, unless was <code>None</code> in
    which case this is the calculated value.</li>
</ul></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_shift</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">yxz_transform</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">min_score_2d</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                  <span class="n">min_score_multiplier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">min_score_min_dist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                  <span class="n">min_score_max_dist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                  <span class="n">neighb_dist_thresh</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                  <span class="n">z_shifts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">widen</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">max_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_scale</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">nz_collapse</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This finds the shift from those given that is best applied to `yxz_base` to match `yxz_transform`.</span>

<span class="sd">    If the `score` of this is below `min_score_2d`, a widened search is performed.</span>
<span class="sd">    If the `score` is above `min_score_2d`, a refined search is done about the best shift so as to find the absolute</span>
<span class="sd">    best shift, not the best shift among those given.</span>

<span class="sd">    Args:</span>
<span class="sd">        yxz_base: `int [n_spots_base x 3]`.</span>
<span class="sd">            Coordinates of spots on base image (yx in yx pixel units, z in z pixel units).</span>
<span class="sd">        yxz_transform: `int [n_spots_transform x 3]`.</span>
<span class="sd">            Coordinates of spots on transformed image (yx in yx pixel units, z in z pixel units).</span>
<span class="sd">        min_score_2d: If score of best shift is below this, will search among the widened shifts.</span>
<span class="sd">            If `None`, `min_score_2d` will be computed using `get_score_thresh`.</span>
<span class="sd">        min_score_multiplier: Parameter used to find `min_score_2d` and `min_score_3d` if not given.</span>
<span class="sd">            Typical = `1.5` (definitely more than `1`).</span>
<span class="sd">        min_score_min_dist: `min_score_2d` is set to max score of those scores for shifts a distance between `min_dist`</span>
<span class="sd">            and `max_dist` from the best_shift.</span>
<span class="sd">        min_score_max_dist: `min_score_2d` is set to max score of those scores for shifts a distance between `min_dist`</span>
<span class="sd">            and `max_dist` from the best_shift.</span>
<span class="sd">        neighb_dist_thresh: Basically the distance below which neighbours are a good match.</span>
<span class="sd">            Typical = `2`.</span>
<span class="sd">        y_shifts: `float [n_y_shifts]`.</span>
<span class="sd">            All possible shifts to test in y direction, probably made with `np.arange`.</span>
<span class="sd">        x_shifts: `float [n_x_shifts]`.</span>
<span class="sd">            All possible shifts to test in x direction, probably made with `np.arange`.</span>
<span class="sd">        z_shifts: `float [n_z_shifts]`.</span>
<span class="sd">            All possible shifts to test in z direction, probably made with `np.arange`.</span>
<span class="sd">            If not given, will compute automatically from initial guess when making slices and `z_step`.</span>
<span class="sd">        widen: `int [3]`.</span>
<span class="sd">            By how many shifts to extend search in `[y, x, z]` direction if score below `min_score`.</span>
<span class="sd">            This many are added above and below current range.</span>
<span class="sd">            If all widen parameters are `0`, widened search is never performed.</span>
<span class="sd">            If `None`, set to `[0, 0, 0]`.</span>
<span class="sd">        max_range: `int [3]`.</span>
<span class="sd">            The range of shifts searched over will continue to be increased according to `widen` until</span>
<span class="sd">            the `max_range` is reached in each dimension.</span>
<span class="sd">            If a good shift is still not found, the best shift will still be returned without error.</span>
<span class="sd">            If None and widen supplied, range will only be widened once.</span>
<span class="sd">        z_scale: By what scale factor to multiply z coordinates to make them same units as xy.</span>
<span class="sd">            I.e. `z_pixel_size / xy_pixel_size`.</span>
<span class="sd">            If one value, given same scale used for yxz_base and yxz_transform.</span>
<span class="sd">            Otherwise, first value used for yxz_base and second for yxz_transform.</span>
<span class="sd">        nz_collapse: Maximum number of z-planes allowed to be flattened into a 2D slice.</span>
<span class="sd">            If `None`, `n_slices`=1. Should be `None` for 2D data.</span>
<span class="sd">        z_step: `int`.</span>
<span class="sd">            Step of shift search in z direction in uints of `z_pixels`.</span>
<span class="sd">            `z_shifts` are computed automatically as 1 shift either side of an initial guess.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - `best_shift` - `float [shift_y, shift_x, shift_z]`.</span>
<span class="sd">            Best shift found.</span>
<span class="sd">        - `best_score` - `float`.</span>
<span class="sd">            Score of best shift.</span>
<span class="sd">        - `min_score_3d` - `float`.</span>
<span class="sd">            Same as `min_score_2d`, unless input was `None` in which case this is the calculated value.</span>
<span class="sd">        - `debug_info` - dict containing debugging information:</span>
<span class="sd">            - `shifts_2d`: `int [n_shifts_2d x 2]`</span>
<span class="sd">                All yx shifts searched to get best `yx_shift`.</span>
<span class="sd">            - `scores_2d`: `float [n_shifts_2d]`</span>
<span class="sd">                Score corresponding to each 2d shift.</span>
<span class="sd">            - `shifts_3d`: `int [n_shifts_3d x 3]`</span>
<span class="sd">                All yxz shifts searched to get best `yxz_shift`. `None` if `nz_collapse is None` i.e. 2D point cloud.</span>
<span class="sd">            - `scores_3d`: `float [n_shifts_3d]`</span>
<span class="sd">                Score corresponding to each 3d shift. `None` if `nz_collapse is None` i.e. 2D point cloud.</span>
<span class="sd">            - `shift_2d_initial`: `float [2]`</span>
<span class="sd">                Best shift found after first 2D search. I.e. annulus around this shift was used</span>
<span class="sd">                to compute `min_score_2d` and `shift_thresh`.</span>
<span class="sd">            - `shift_thresh`: `int [3]`</span>
<span class="sd">                yxz shift corresponding to `min_score_3d`. Will be `None` if `min_score_2d` provided in advance.</span>
<span class="sd">                `shift_thresh[:2]` is the yx shift corresponding to `min_score_2d`</span>
<span class="sd">            - `min_score_2d`: Same as input `min_score_2d`, unless was `None` in</span>
<span class="sd">                which case this is the calculated value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">widen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">widen</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z_scale</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">z_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">z_scale</span><span class="p">,</span> <span class="n">z_scale</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_scale</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only 2 z_scale values should be provided but z_scale given was </span><span class="si">{</span><span class="n">z_scale</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="n">yx_base_slices</span><span class="p">,</span> <span class="n">yx_transform_trees</span><span class="p">,</span> <span class="n">z_shift_guess</span> <span class="o">=</span> <span class="n">get_2d_slices</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform</span><span class="p">,</span> <span class="n">nz_collapse</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nz_collapse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Only do z-scaling in 3D case</span>
        <span class="n">yxz_base</span> <span class="o">=</span> <span class="n">yxz_base</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">yxz_transform</span> <span class="o">=</span> <span class="n">yxz_transform</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">yxz_transform_tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">yxz_transform</span><span class="p">)</span>
    <span class="n">shift_2d</span><span class="p">,</span> <span class="n">score_2d</span><span class="p">,</span> <span class="n">all_shifts_2d</span><span class="p">,</span> <span class="n">all_scores_2d</span> <span class="o">=</span> <span class="n">get_best_shift_2d</span><span class="p">(</span><span class="n">yx_base_slices</span><span class="p">,</span> <span class="n">yx_transform_trees</span><span class="p">,</span>
                                                                         <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">)</span>

    <span class="c1"># Only look at 3 shifts in z to start with about guess from getting the 2d slices.</span>
    <span class="k">if</span> <span class="n">z_shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">z_shift_guess</span> <span class="o">-</span> <span class="n">z_step</span><span class="p">,</span> <span class="n">z_shift_guess</span> <span class="o">+</span> <span class="n">z_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_step</span><span class="p">)</span>

    <span class="c1"># save initial_shifts so don&#39;t look over same shifts twice</span>
    <span class="c1"># initial_shifts = np.array(np.meshgrid(y_shifts, x_shifts)).T.reshape(-1, 2)</span>
    <span class="n">shift_2d_initial</span> <span class="o">=</span> <span class="n">shift_2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">min_score_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_score_2d</span><span class="p">,</span> <span class="n">shift_thresh</span> <span class="o">=</span> <span class="n">get_score_thresh</span><span class="p">(</span><span class="n">all_shifts_2d</span><span class="p">,</span> <span class="n">all_scores_2d</span><span class="p">,</span> <span class="n">shift_2d</span><span class="p">,</span> <span class="n">min_score_min_dist</span><span class="p">,</span>
                                                      <span class="n">min_score_max_dist</span><span class="p">,</span> <span class="n">min_score_multiplier</span><span class="p">)</span>
        <span class="n">shift_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">shift_thresh</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># add z shift = 0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shift_thresh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">score_2d</span> <span class="o">&lt;=</span> <span class="n">min_score_2d</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">widen</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">shift_ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">max_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If don&#39;t specify max_range, only widen once.</span>
            <span class="n">max_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">z_shifts</span><span class="p">]])</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">widen</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">max_range</span><span class="p">[</span><span class="n">max_range</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">max_range_2d</span> <span class="o">=</span> <span class="n">max_range</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_range_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">max_range</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="c1"># keep extending range of shifts in yx until good score reached or hit max shift_range.</span>
        <span class="k">while</span> <span class="n">score_2d</span> <span class="o">&lt;=</span> <span class="n">min_score_2d</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">shift_ranges</span> <span class="o">&gt;=</span> <span class="n">max_range_2d</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shift search range exceeds max_range = </span><span class="si">{</span><span class="n">max_range_2d</span><span class="si">}</span><span class="s2"> in yxz directions but </span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;best score is only </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">score_2d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> which is below &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;min_score = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">min_score_2d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best shift found was </span><span class="si">{</span><span class="n">shift_2d</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best shift found (</span><span class="si">{</span><span class="n">shift_2d</span><span class="si">}</span><span class="s2">) has score of </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">score_2d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> which is below &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;min_score = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">min_score_2d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running again with extended shift search range in yx.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shift_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_range_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">extend_array</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">widen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">shift_ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_range_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">extend_array</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">widen</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shift_2d_new</span><span class="p">,</span> <span class="n">score_2d_new</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">all_scores_new</span> <span class="o">=</span> \
                <span class="n">get_best_shift_2d</span><span class="p">(</span><span class="n">yx_base_slices</span><span class="p">,</span> <span class="n">yx_transform_trees</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span>
                                  <span class="n">all_shifts_2d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score_2d_new</span> <span class="o">&gt;</span> <span class="n">score_2d</span><span class="p">:</span>
                <span class="n">score_2d</span> <span class="o">=</span> <span class="n">score_2d_new</span>
                <span class="n">shift_2d</span> <span class="o">=</span> <span class="n">shift_2d_new</span>
            <span class="c1"># update initial_shifts so don&#39;t look over same shifts twice</span>
            <span class="n">all_shifts_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_shifts_2d</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_scores_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_scores_2d</span><span class="p">,</span> <span class="n">all_scores_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># initial_shifts = np.array(np.meshgrid(y_shifts, x_shifts)).T.reshape(-1, 2)</span>
            <span class="n">shift_ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">nz_collapse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># nz_collapse not provided for 2D data.</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_2d</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score_2d</span>
        <span class="n">all_shifts_3d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">all_scores_3d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">min_score_3d</span> <span class="o">=</span> <span class="n">min_score_2d</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ignore_shifts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">shift_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_shift_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shift_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x_shift_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shift_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_shift_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shift_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shift_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">x_shift_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shift_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shift_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_shift_2d</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_shift_2d</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Only find shifts for the shift_2d and shift_thresh, get rid of cross terms.</span>
                <span class="n">ignore_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">shift_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shift_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">shift_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shift_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                <span class="n">ignore_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">ignore_shifts</span><span class="p">,</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">z_shifts</span><span class="p">),</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">ignore_shifts</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">z_shifts</span> <span class="o">*</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_shift_2d</span><span class="p">))</span>
        <span class="c1"># z_scale for yxz_base used from now on as we are finding the shift from yxz_base to yxz_transform.</span>
        <span class="n">shift</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">all_shifts_3d</span><span class="p">,</span> <span class="n">all_scores_3d</span> <span class="o">=</span> <span class="n">get_best_shift_3d</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform_tree</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span>
                                                                       <span class="n">y_shift_2d</span><span class="p">,</span> <span class="n">x_shift_2d</span><span class="p">,</span> <span class="n">z_shifts</span> <span class="o">*</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                       <span class="n">ignore_shifts</span><span class="o">=</span><span class="n">ignore_shifts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shift_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set min_score_3d to max score at shift used to find min_score_2d across all z planes</span>
            <span class="c1"># multiplied by min_score_multiplier</span>
            <span class="n">shift_thresh_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy_indexed</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">shift_thresh</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                                                              <span class="n">all_shifts_3d</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">missing</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shift_thresh_best_ind</span> <span class="o">=</span> <span class="n">shift_thresh_ind</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">all_scores_3d</span><span class="p">[</span><span class="n">shift_thresh_ind</span><span class="p">])]</span>
            <span class="n">min_score_3d</span> <span class="o">=</span> <span class="n">all_scores_3d</span><span class="p">[</span><span class="n">shift_thresh_best_ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">min_score_multiplier</span>
            <span class="n">shift_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_shifts_3d</span><span class="p">[</span><span class="n">shift_thresh_best_ind</span><span class="p">]</span> <span class="o">/</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_score_3d</span> <span class="o">=</span> <span class="n">min_score_2d</span>

        <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">min_score_2d</span> <span class="ow">and</span> <span class="n">widen</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># keep extending range of shifts in z until good score reached or hit max shift_range.</span>
            <span class="c1"># yx shift is kept as 2d shift found when using slices.</span>
            <span class="n">max_range_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">max_range</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">z_shift_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">z_shifts</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">min_score_3d</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">z_shift_range</span> <span class="o">&gt;</span> <span class="n">max_range_z</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shift search range exceeds max_range = </span><span class="si">{</span><span class="n">max_range_z</span><span class="si">}</span><span class="s2"> in z directions but </span><span class="se">\n</span><span class="s2">&quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;best score is only </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> which is below &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;min_score = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">min_score_3d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best shift found was </span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best shift found (</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">) has score of </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> which is below &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;min_score = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">min_score_3d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running again with extended shift search range in z.&quot;</span><span class="p">)</span>
                <span class="n">z_shifts</span> <span class="o">=</span> <span class="n">extend_array</span><span class="p">(</span><span class="n">z_shifts</span><span class="p">,</span> <span class="n">widen</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">shift_new</span><span class="p">,</span> <span class="n">score_new</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">all_scores_new</span> <span class="o">=</span> \
                    <span class="n">get_best_shift_3d</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform_tree</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shift_2d</span><span class="p">,</span>
                                      <span class="n">x_shift_2d</span><span class="p">,</span> <span class="n">z_shifts</span> <span class="o">*</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">all_shifts_3d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">score_new</span> <span class="o">&gt;</span> <span class="n">score</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">score_new</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">shift_new</span>
                <span class="c1"># update initial_shifts so don&#39;t look over same shifts twice</span>
                <span class="n">all_shifts_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_shifts_3d</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">all_scores_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_scores_3d</span><span class="p">,</span> <span class="n">all_scores_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">z_shift_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">z_shifts</span><span class="p">)</span>

    <span class="c1"># refined search near maxima with half the step</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">refined_shifts</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">refined_shifts</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">z_shifts</span> <span class="o">=</span> <span class="n">refined_shifts</span><span class="p">(</span><span class="n">z_shifts</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">shift2</span><span class="p">,</span> <span class="n">score2</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">all_scores_new</span> <span class="o">=</span> \
        <span class="n">get_best_shift_3d</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform_tree</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span>
                          <span class="n">z_shifts</span> <span class="o">*</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">all_shifts_3d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">shift2</span>
    <span class="k">if</span> <span class="n">nz_collapse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_shifts_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_shifts_2d</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_scores_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_scores_2d</span><span class="p">,</span> <span class="n">all_scores_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_shifts_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_shifts_3d</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_scores_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_scores_3d</span><span class="p">,</span> <span class="n">all_scores_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># final search with a step of 1</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">refined_shifts</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">refined_scale</span><span class="o">=</span><span class="mf">1e-50</span><span class="p">,</span> <span class="n">extend_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">refined_shifts</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">refined_scale</span><span class="o">=</span><span class="mf">1e-50</span><span class="p">,</span> <span class="n">extend_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">z_shifts</span> <span class="o">=</span> <span class="n">refined_shifts</span><span class="p">(</span><span class="n">z_shifts</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">refined_scale</span><span class="o">=</span><span class="mf">1e-50</span><span class="p">,</span> <span class="n">extend_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">all_scores_new</span> <span class="o">=</span> \
        <span class="n">get_best_shift_3d</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform_tree</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span>
                          <span class="n">z_shifts</span> <span class="o">*</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">all_shifts_3d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nz_collapse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_shifts_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_shifts_2d</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_scores_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_scores_2d</span><span class="p">,</span> <span class="n">all_scores_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_shifts_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_shifts_3d</span><span class="p">,</span> <span class="n">all_shifts_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_scores_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_scores_3d</span><span class="p">,</span> <span class="n">all_scores_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_shifts_3d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_shifts_3d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">all_shifts_3d</span> <span class="o">=</span> <span class="n">all_shifts_3d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">z_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">shift</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">score</span><span class="p">,</span> <span class="n">min_score_3d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;shifts_2d&#39;</span><span class="p">:</span> <span class="n">all_shifts_2d</span><span class="p">,</span> <span class="s1">&#39;scores_2d&#39;</span><span class="p">:</span> <span class="n">all_scores_2d</span><span class="p">,</span>
                                                    <span class="s1">&#39;shifts_3d&#39;</span><span class="p">:</span> <span class="n">all_shifts_3d</span><span class="p">,</span> <span class="s1">&#39;scores_3d&#39;</span><span class="p">:</span> <span class="n">all_scores_3d</span><span class="p">,</span>
                                                    <span class="s1">&#39;shift_2d_initial&#39;</span><span class="p">:</span> <span class="n">shift_2d_initial</span><span class="p">,</span> <span class="s1">&#39;shift_thresh&#39;</span><span class="p">:</span> <span class="n">shift_thresh</span><span class="p">,</span>
                                                    <span class="s1">&#39;min_score_2d&#39;</span><span class="p">:</span> <span class="n">min_score_2d</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.extend_array" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extend_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">extend_scale</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Extrapolates array using its mean spacing in the direction specified by <code>extend_sz</code> values.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_values]</code>.
Array probably produced using <code>np.arange</code>. It is expected to be in ascending order with constant step.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>extend_scale</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>By how many values to extend the array.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>direction</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>One of the following, specifying how to extend the <code>array</code> -</p>
<ul>
<li><code>'below'</code> - <code>array</code> extended below the min value.</li>
<li><code>'above'</code> - <code>array</code> extended above the max value</li>
<li><code>'both'</code> - <code>array</code> extended in both directions (by <code>extend_sz</code> in each direction).</li>
</ul></td>
          <td>
                <code>&#39;both&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_values + extend_scale * (direction == 'both' + 1)]</code>.
<code>array</code> extrapolated in <code>direction</code> specified.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extend_array</span><span class="p">(</span><span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">extend_scale</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extrapolates array using its mean spacing in the direction specified by `extend_sz` values.</span>

<span class="sd">    Args:</span>
<span class="sd">        array: `float [n_values]`.</span>
<span class="sd">            Array probably produced using `np.arange`. It is expected to be in ascending order with constant step.</span>
<span class="sd">        extend_scale: By how many values to extend the array.</span>
<span class="sd">        direction: One of the following, specifying how to extend the `array` -</span>

<span class="sd">            - `&#39;below&#39;` - `array` extended below the min value.</span>
<span class="sd">            - `&#39;above&#39;` - `array` extended above the max value</span>
<span class="sd">            - `&#39;both&#39;` - `array` extended in both directions (by `extend_sz` in each direction).</span>

<span class="sd">    Returns:</span>
<span class="sd">        `float [n_values + extend_scale * (direction == &#39;both&#39; + 1)]`.</span>
<span class="sd">            `array` extrapolated in `direction` specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">extend_scale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ext_array</span> <span class="o">=</span> <span class="n">array</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
        <span class="n">ext_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">extend_scale</span> <span class="o">*</span> <span class="n">step</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">ext_above</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">extend_scale</span> <span class="o">*</span> <span class="n">step</span> <span class="o">+</span> <span class="n">step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span><span class="p">:</span>
            <span class="n">ext_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ext_below</span><span class="p">,</span> <span class="n">array</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span><span class="p">:</span>
            <span class="n">ext_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">array</span><span class="p">,</span> <span class="n">ext_above</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">ext_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ext_below</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">ext_above</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;direction specified was </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">, whereas it should be &#39;below&#39;, &#39;above&#39; or &#39;both&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ext_array</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.get_2d_slices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_2d_slices</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform</span><span class="p">,</span> <span class="n">nz_collapse</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This splits <code>yxz_base</code> and <code>yxz_transform</code> into <code>n_slices = nz / nz_collapse</code> 2D slices.
Then can do a 2D exhaustive search over multiple 2D slices instead of 3D exhaustive search.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>yxz_base</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_spots_base x 3]</code>.
Coordinates of spots on base image (yx in yx pixel units, z in z pixel units).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>yxz_transform</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_spots_transform x 3]</code>.
Coordinates of spots on transformed image (yx in yx pixel units, z in z pixel units).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nz_collapse</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>Maximum number of z-planes allowed to be flattened into a 2D slice.
If <code>None</code>, <code>n_slices</code>=1.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><ul>
<li><code>yx_base_slices</code> - List of n_slices arrays indicating yx_base coordinates of spots in that slice.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="scipy.spatial.KDTree">KDTree</span>]</code>
          </td>
          <td><ul>
<li><code>yx_transform_trees</code> - List of n_slices KDTrees, each built from the yx_transform coordinates of spots in
that slice.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code>int</code>
          </td>
          <td><ul>
<li>transform_min_z - Guess of z shift from <code>yxz_base</code> to <code>yxz_transform</code> in units of <code>z_pixels</code>.</li>
</ul></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_2d_slices</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">yxz_transform</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                  <span class="n">nz_collapse</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">KDTree</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This splits `yxz_base` and `yxz_transform` into `n_slices = nz / nz_collapse` 2D slices.</span>
<span class="sd">    Then can do a 2D exhaustive search over multiple 2D slices instead of 3D exhaustive search.</span>

<span class="sd">    Args:</span>
<span class="sd">        yxz_base: `float [n_spots_base x 3]`.</span>
<span class="sd">            Coordinates of spots on base image (yx in yx pixel units, z in z pixel units).</span>
<span class="sd">        yxz_transform: `float [n_spots_transform x 3]`.</span>
<span class="sd">            Coordinates of spots on transformed image (yx in yx pixel units, z in z pixel units).</span>
<span class="sd">        nz_collapse: Maximum number of z-planes allowed to be flattened into a 2D slice.</span>
<span class="sd">            If `None`, `n_slices`=1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - `yx_base_slices` - List of n_slices arrays indicating yx_base coordinates of spots in that slice.</span>
<span class="sd">        - `yx_transform_trees` - List of n_slices KDTrees, each built from the yx_transform coordinates of spots in</span>
<span class="sd">            that slice.</span>
<span class="sd">        - transform_min_z - Guess of z shift from `yxz_base` to `yxz_transform` in units of `z_pixels`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nz_collapse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">n_slices</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nz</span> <span class="o">/</span> <span class="n">nz_collapse</span><span class="p">))</span>
        <span class="n">base_z_slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nz</span><span class="p">),</span> <span class="n">n_slices</span><span class="p">)</span>
        <span class="n">slice_max_z_base</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># min z for slice 0</span>
        <span class="n">transform_max_z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">yxz_transform</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># transform_min_z provides an approx guess to the z shift.</span>
        <span class="n">transform_min_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yxz_transform</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())),</span> <span class="n">transform_max_z</span> <span class="o">-</span> <span class="n">nz</span><span class="p">])</span>
        <span class="n">slice_max_z_transform</span> <span class="o">=</span> <span class="n">transform_min_z</span>  <span class="c1"># min z for slice 0</span>
        <span class="n">yx_base_slices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">yx_transform_trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slices</span><span class="p">):</span>
            <span class="n">slice_min_z_base</span> <span class="o">=</span> <span class="n">slice_max_z_base</span>  <span class="c1"># set min z to the max z of the last slice</span>
            <span class="n">slice_max_z_base</span> <span class="o">=</span> <span class="n">base_z_slices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">in_slice_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">yxz_base</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">slice_min_z_base</span><span class="p">,</span>
                                      <span class="n">yxz_base</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">slice_max_z_base</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">yx_base_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">[</span><span class="n">in_slice_base</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1"># transform z coords may have systematic z shift so start from min_z not 0.</span>
            <span class="n">slice_min_z_transform</span> <span class="o">=</span> <span class="n">slice_max_z_transform</span>  <span class="c1"># set min z to the max z of the last slice</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n_slices</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># For final slice, ensure all z planes in yxz_transform included.</span>
                <span class="n">slice_max_z_transform</span> <span class="o">=</span> <span class="n">transform_max_z</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slice_max_z_transform</span> <span class="o">=</span> <span class="n">base_z_slices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">transform_min_z</span>
            <span class="n">in_slice_transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">yxz_transform</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">slice_min_z_transform</span><span class="p">,</span>
                                           <span class="n">yxz_transform</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">slice_max_z_transform</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">yx_transform_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">KDTree</span><span class="p">(</span><span class="n">yxz_transform</span><span class="p">[</span><span class="n">in_slice_transform</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transform_min_z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">yx_base_slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">yxz_base</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">yx_transform_trees</span> <span class="o">=</span> <span class="p">[</span><span class="n">KDTree</span><span class="p">(</span><span class="n">yxz_transform</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">yx_base_slices</span><span class="p">,</span> <span class="n">yx_transform_trees</span><span class="p">,</span> <span class="n">transform_min_z</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.get_best_shift_2d" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_best_shift_2d</span><span class="p">(</span><span class="n">yx_base_slices</span><span class="p">,</span> <span class="n">yx_transform_trees</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">ignore_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>yx_base_slices</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>List of n_slices arrays indicating yx_base coordinates of spots in that slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>yx_transform_trees</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="scipy.spatial.KDTree">KDTree</span>]</code>
          </td>
          <td><p>List of n_slices KDTrees, each built from the yx_transform coordinates of spots in
that slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>neighb_dist_thresh</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Basically the distance below which neighbours are a good match.
Typical = <code>2</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_y_shifts]</code>.
All possible shifts to test in y direction, probably made with <code>np.arange</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>x_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_x_shifts]</code>.
All possible shifts to test in x direction, probably made with <code>np.arange</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ignore_shifts</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p><code>float [n_ignore x 2]</code>.
Contains yx shifts to not search over.
If <code>None</code>, all permutations of <code>y_shifts</code>, <code>x_shifts</code> used.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><ul>
<li><code>best_shift</code> - <code>float [shift_y, shift_x]</code>.
Best shift found.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><ul>
<li><code>best_score</code> - <code>float</code>.
Score of best shift.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><ul>
<li><code>all_shifts</code> - <code>float [n_shifts x 2]</code>.
yx shifts searched over.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><ul>
<li><code>score</code> - <code>float [n_shifts]</code>.
Score of all shifts.</li>
</ul></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_best_shift_2d</span><span class="p">(</span><span class="n">yx_base_slices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">yx_transform_trees</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">KDTree</span><span class="p">],</span> <span class="n">neighb_dist_thresh</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">y_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                      <span class="n">ignore_shifts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        yx_base_slices: List of n_slices arrays indicating yx_base coordinates of spots in that slice.</span>
<span class="sd">        yx_transform_trees: List of n_slices KDTrees, each built from the yx_transform coordinates of spots in</span>
<span class="sd">            that slice.</span>
<span class="sd">        neighb_dist_thresh: Basically the distance below which neighbours are a good match.</span>
<span class="sd">            Typical = `2`.</span>
<span class="sd">        y_shifts: `float [n_y_shifts]`.</span>
<span class="sd">            All possible shifts to test in y direction, probably made with `np.arange`.</span>
<span class="sd">        x_shifts: `float [n_x_shifts]`.</span>
<span class="sd">            All possible shifts to test in x direction, probably made with `np.arange`.</span>
<span class="sd">        ignore_shifts: `float [n_ignore x 2]`.</span>
<span class="sd">            Contains yx shifts to not search over.</span>
<span class="sd">            If `None`, all permutations of `y_shifts`, `x_shifts` used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - `best_shift` - `float [shift_y, shift_x]`.</span>
<span class="sd">            Best shift found.</span>
<span class="sd">        - `best_score` - `float`.</span>
<span class="sd">            Score of best shift.</span>
<span class="sd">        - `all_shifts` - `float [n_shifts x 2]`.</span>
<span class="sd">            yx shifts searched over.</span>
<span class="sd">        - `score` - `float [n_shifts]`.</span>
<span class="sd">            Score of all shifts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ignore_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_shifts</span> <span class="o">=</span> <span class="n">setdiff2d</span><span class="p">(</span><span class="n">all_shifts</span><span class="p">,</span> <span class="n">ignore_shifts</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">all_shifts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n_trees</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">yx_transform_trees</span><span class="p">)</span>
    <span class="n">dist_upper_bound</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">neighb_dist_thresh</span>  <span class="c1"># beyond this, score &lt; exp(-4.5) and quicker to use this.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">all_shifts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trees</span><span class="p">):</span>
            <span class="n">yx_shifted</span> <span class="o">=</span> <span class="n">yx_base_slices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">yx_transform_trees</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">yx_shifted</span><span class="p">,</span> <span class="n">distance_upper_bound</span><span class="o">=</span><span class="n">dist_upper_bound</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_score</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">)</span>
    <span class="n">best_shift_ind</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">all_shifts</span><span class="p">[</span><span class="n">best_shift_ind</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">best_shift_ind</span><span class="p">],</span> <span class="n">all_shifts</span><span class="p">,</span> <span class="n">score</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.get_best_shift_3d" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_best_shift_3d</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">,</span> <span class="n">yxz_transform_tree</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">z_shifts</span><span class="p">,</span> <span class="n">ignore_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Finds the shift from those given that is best applied to <code>yx_base</code> to match <code>yx_transform</code>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>yxz_base</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_spots_base x 3]</code>.
Coordinates of spots on base image (yxz units must be same).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>yxz_transform_tree</code></td>
          <td>
                <code><span title="scipy.spatial.KDTree">KDTree</span></code>
          </td>
          <td><p>KDTree built from coordinates of spots on transformed image
(<code>float [n_spots_transform x 3]</code>, yxz units must be same).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>neighb_dist_thresh</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Basically the distance below which neighbours are a good match.
Typical = <code>2</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_y_shifts]</code>.
All possible shifts to test in y direction, probably made with <code>np.arange</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>x_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_x_shifts]</code>.
All possible shifts to test in x direction, probably made with <code>np.arange</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>z_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_z_shifts]</code>.
All possible shifts to test in z direction, probably made with <code>np.arange</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ignore_shifts</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p><code>float [n_ignore x 3]</code>.
Contains yxz shifts to not search over.
If <code>None</code>, all permutations of <code>y_shifts</code>, <code>x_shifts</code>, <code>z_shifts</code> used.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><ul>
<li><code>best_shift</code> - <code>float [shift_y, shift_x, shift_z]</code>.
Best shift found.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><ul>
<li><code>best_score</code> - <code>float</code>.
Score of best shift.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><ul>
<li><code>all_shifts</code> - <code>float [n_shifts x 3]</code>.
yxz shifts searched over.</li>
</ul></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><ul>
<li><code>score</code> - <code>float [n_shifts]</code>.
Score of all shifts.</li>
</ul></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_best_shift_3d</span><span class="p">(</span><span class="n">yxz_base</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">yxz_transform_tree</span><span class="p">:</span> <span class="n">KDTree</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                      <span class="n">x_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">z_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                      <span class="n">ignore_shifts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the shift from those given that is best applied to `yx_base` to match `yx_transform`.</span>

<span class="sd">    Args:</span>
<span class="sd">        yxz_base: `float [n_spots_base x 3]`.</span>
<span class="sd">            Coordinates of spots on base image (yxz units must be same).</span>
<span class="sd">        yxz_transform_tree: KDTree built from coordinates of spots on transformed image</span>
<span class="sd">            (`float [n_spots_transform x 3]`, yxz units must be same).</span>
<span class="sd">        neighb_dist_thresh: Basically the distance below which neighbours are a good match.</span>
<span class="sd">            Typical = `2`.</span>
<span class="sd">        y_shifts: `float [n_y_shifts]`.</span>
<span class="sd">            All possible shifts to test in y direction, probably made with `np.arange`.</span>
<span class="sd">        x_shifts: `float [n_x_shifts]`.</span>
<span class="sd">            All possible shifts to test in x direction, probably made with `np.arange`.</span>
<span class="sd">        z_shifts: `float [n_z_shifts]`.</span>
<span class="sd">            All possible shifts to test in z direction, probably made with `np.arange`.</span>
<span class="sd">        ignore_shifts: `float [n_ignore x 3]`.</span>
<span class="sd">            Contains yxz shifts to not search over.</span>
<span class="sd">            If `None`, all permutations of `y_shifts`, `x_shifts`, `z_shifts` used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - `best_shift` - `float [shift_y, shift_x, shift_z]`.</span>
<span class="sd">            Best shift found.</span>
<span class="sd">        - `best_score` - `float`.</span>
<span class="sd">            Score of best shift.</span>
<span class="sd">        - `all_shifts` - `float [n_shifts x 3]`.</span>
<span class="sd">            yxz shifts searched over.</span>
<span class="sd">        - `score` - `float [n_shifts]`.</span>
<span class="sd">            Score of all shifts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">z_shifts</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ignore_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_shifts</span> <span class="o">=</span> <span class="n">setdiff2d</span><span class="p">(</span><span class="n">all_shifts</span><span class="p">,</span> <span class="n">ignore_shifts</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">all_shifts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dist_upper_bound</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">neighb_dist_thresh</span>  <span class="c1"># beyond this, score &lt; exp(-4.5) and quicker to use this.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">all_shifts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">yxz_shifted</span> <span class="o">=</span> <span class="n">yxz_base</span> <span class="o">+</span> <span class="n">all_shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">yxz_transform_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">yxz_shifted</span><span class="p">,</span> <span class="n">distance_upper_bound</span><span class="o">=</span><span class="n">dist_upper_bound</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_score</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">neighb_dist_thresh</span><span class="p">)</span>
    <span class="n">best_shift_ind</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">all_shifts</span><span class="p">[</span><span class="n">best_shift_ind</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">best_shift_ind</span><span class="p">],</span> <span class="n">all_shifts</span><span class="p">,</span> <span class="n">score</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.get_score_thresh" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_score_thresh</span><span class="p">(</span><span class="n">all_shifts</span><span class="p">,</span> <span class="n">all_scores</span><span class="p">,</span> <span class="n">best_shift</span><span class="p">,</span> <span class="n">min_dist</span><span class="p">,</span> <span class="n">max_dist</span><span class="p">,</span> <span class="n">thresh_multiplier</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Score thresh is the max of all scores from transforms between a <code>distance=min_dist</code> and <code>distance=max_dist</code>
from the <code>best_shift</code>.
I.e. we expect just for actual shift, there will be sharp gradient in score near it,
so threshold is multiple of nearby score.
If not the actual shift, then expect scores in this annulus will also be quite large.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>all_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_shifts x 2]</code>.
yx shifts searched over.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>all_scores</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_shifts]</code>.
<code>all_scores[s]</code> is the score corresponding to <code>all_shifts[s]</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>best_shift</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="typing.List">List</span>]</code>
          </td>
          <td><p><code>float [2]</code>.
yx shift with the best score.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_dist</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p><code>score_thresh</code> computed from <code>all_shifts</code> a distance between <code>min_shift</code> and <code>max_shift</code>
from <code>best_shifts</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_dist</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p><code>score_thresh</code> computed from <code>all_shifts</code> a distance between <code>min_shift</code> and <code>max_shift</code>
from <code>best_shifts</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thresh_multiplier</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p><code>score_thresh</code> is <code>thresh_multiplier</code> * mean of scores of shifts the correct distance
from <code>best_shift</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><p>score_thresh - Threshold used to determine if <code>best_shift</code> found is legitimate.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>shift_thresh - <code>float [2]</code>
shift corresponding to <code>score_thresh</code>. Will be None if there were no shifts
in the range set by <code>min_dist</code> and <code>max_dist</code>.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_score_thresh</span><span class="p">(</span><span class="n">all_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">all_scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">best_shift</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">],</span> <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">max_dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">thresh_multiplier</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score thresh is the max of all scores from transforms between a `distance=min_dist` and `distance=max_dist`</span>
<span class="sd">    from the `best_shift`.</span>
<span class="sd">    I.e. we expect just for actual shift, there will be sharp gradient in score near it,</span>
<span class="sd">    so threshold is multiple of nearby score.</span>
<span class="sd">    If not the actual shift, then expect scores in this annulus will also be quite large.</span>

<span class="sd">    Args:</span>
<span class="sd">        all_shifts: `float [n_shifts x 2]`.</span>
<span class="sd">            yx shifts searched over.</span>
<span class="sd">        all_scores: `float [n_shifts]`.</span>
<span class="sd">            `all_scores[s]` is the score corresponding to `all_shifts[s]`.</span>
<span class="sd">        best_shift: `float [2]`.</span>
<span class="sd">            yx shift with the best score.</span>
<span class="sd">        min_dist: `score_thresh` computed from `all_shifts` a distance between `min_shift` and `max_shift`</span>
<span class="sd">            from `best_shifts`.</span>
<span class="sd">        max_dist: `score_thresh` computed from `all_shifts` a distance between `min_shift` and `max_shift`</span>
<span class="sd">            from `best_shifts`.</span>
<span class="sd">        thresh_multiplier: `score_thresh` is `thresh_multiplier` * mean of scores of shifts the correct distance</span>
<span class="sd">            from `best_shift`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        score_thresh - Threshold used to determine if `best_shift` found is legitimate.</span>
<span class="sd">        shift_thresh - `float [2]`</span>
<span class="sd">            shift corresponding to `score_thresh`. Will be None if there were no shifts</span>
<span class="sd">            in the range set by `min_dist` and `max_dist`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist_to_best</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_shifts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_shift</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">dist_to_best</span> <span class="o">&lt;=</span> <span class="n">max_dist</span><span class="p">,</span> <span class="n">dist_to_best</span> <span class="o">&gt;=</span> <span class="n">min_dist</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">use</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">thresh_ind</span> <span class="o">=</span> <span class="n">use</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">all_scores</span><span class="p">[</span><span class="n">use</span><span class="p">])]</span>
        <span class="n">score_thresh</span> <span class="o">=</span> <span class="n">thresh_multiplier</span> <span class="o">*</span> <span class="n">all_scores</span><span class="p">[</span><span class="n">thresh_ind</span><span class="p">]</span>
        <span class="n">shift_thresh</span> <span class="o">=</span> <span class="n">all_shifts</span><span class="p">[</span><span class="n">thresh_ind</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score_thresh</span> <span class="o">=</span> <span class="n">thresh_multiplier</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_scores</span><span class="p">)</span>
        <span class="n">shift_thresh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">score_thresh</span><span class="p">,</span> <span class="n">shift_thresh</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.refined_shifts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">refined_shifts</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">best_shift</span><span class="p">,</span> <span class="n">refined_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">extend_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>If <code>shifts</code> is an array with mean spacing <code>step</code> then this builds array
that covers from</p>
<p><code>best_shift - extend_scale * step</code> to <code>best_shift + extend_scale * step</code>
with a spacing of <code>step*refined_scale</code>.</p>
<p>The new step, <code>step*refined_scale</code>, is forced to be an integer.</p>
<p>If only one <code>shift</code> provided, doesn't do anything.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_shifts]</code>.
Array probably produced using <code>np.arange</code>. It is expected to be in ascending order with constant step.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>best_shift</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Value in <code>shifts</code> to build new shifts around.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>refined_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Scaling to apply to find new shift spacing.</p></td>
          <td>
                <code>0.5</code>
          </td>
        </tr>
        <tr>
          <td><code>extend_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>By how many steps to build new shifts.</p></td>
          <td>
                <code>2</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_new_shifts]</code>. Array covering from</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>best_shift - extend_scale * step</code> to <code>best_shift + extend_scale * step</code> with a spacing of <code>step*refined_scale</code>.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">refined_shifts</span><span class="p">(</span><span class="n">shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">best_shift</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">refined_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">extend_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If `shifts` is an array with mean spacing `step` then this builds array</span>
<span class="sd">    that covers from</span>

<span class="sd">    `best_shift - extend_scale * step` to `best_shift + extend_scale * step`</span>
<span class="sd">    with a spacing of `step*refined_scale`.</span>

<span class="sd">    The new step, `step*refined_scale`, is forced to be an integer.</span>

<span class="sd">    If only one `shift` provided, doesn&#39;t do anything.</span>

<span class="sd">    Args:</span>
<span class="sd">        shifts: `float [n_shifts]`.</span>
<span class="sd">            Array probably produced using `np.arange`. It is expected to be in ascending order with constant step.</span>
<span class="sd">        best_shift: Value in `shifts` to build new shifts around.</span>
<span class="sd">        refined_scale: Scaling to apply to find new shift spacing.</span>
<span class="sd">        extend_scale: By how many steps to build new shifts.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `float [n_new_shifts]`. Array covering from</span>

<span class="sd">        `best_shift - extend_scale * step` to `best_shift + extend_scale * step` with a spacing of `step*refined_scale`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">refined_shifts</span> <span class="o">=</span> <span class="n">shifts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">shifts</span><span class="p">))</span>
        <span class="n">refined_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">refined_scale</span> <span class="o">*</span> <span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">refined_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">best_shift</span> <span class="o">-</span> <span class="n">extend_scale</span> <span class="o">*</span> <span class="n">step</span><span class="p">,</span>
                                   <span class="n">best_shift</span> <span class="o">+</span> <span class="n">extend_scale</span> <span class="o">*</span> <span class="n">step</span> <span class="o">+</span> <span class="n">refined_step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">refined_step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">refined_shifts</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.shift_score" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shift_score</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes a score to quantify how good a shift is based on the distances between the neighbours found.
the value of this score is approximately the number of close neighbours found.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>distances</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>float [n_neighbours]</code>.
Distances between each pair of neighbours.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thresh</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Basically the distance in pixels below which neighbours are a good match.
Typical = <code>2</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><p>Score to quantify how good a shift is based on the distances between the neighbours found.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shift_score</span><span class="p">(</span><span class="n">distances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">thresh</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a score to quantify how good a shift is based on the distances between the neighbours found.</span>
<span class="sd">    the value of this score is approximately the number of close neighbours found.</span>

<span class="sd">    Args:</span>
<span class="sd">        distances: `float [n_neighbours]`.</span>
<span class="sd">            Distances between each pair of neighbours.</span>
<span class="sd">        thresh: Basically the distance in pixels below which neighbours are a good match.</span>
<span class="sd">            Typical = `2`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Score to quantify how good a shift is based on the distances between the neighbours found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">distances</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">thresh</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="coppafish.stitch.shift.update_shifts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_shifts</span><span class="p">(</span><span class="n">search_shifts</span><span class="p">,</span> <span class="n">prev_found_shifts</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns a new array of <code>search_shifts</code> around the mean of <code>prev_found_shifts</code> if new array has fewer entries or if
mean of <code>prev_found_shifts</code> is outside initial range of <code>search_shifts</code>.
If more than one <code>prev_found_shifts</code> is outside the <code>search_shifts</code> in the same way i.e. too high or too low,
<code>search_shifts</code> will be updated too.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>search_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>int [n_shifts]</code>.
Indicates all shifts currently searched over.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>prev_found_shifts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>int [n_shifts_found]</code>.
Indicate shifts found on all previous runs of <code>compute_shift</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p><code>int [n_new_shifts]</code>.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>New set of shifts around mean of previously found shifts.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Will only return updated shifts if new array has fewer entries than before or mean of <code>prev_found_shifts</code></p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>is outside range of <code>search_shifts</code>.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>coppafish/stitch/shift.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_shifts</span><span class="p">(</span><span class="n">search_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">prev_found_shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a new array of `search_shifts` around the mean of `prev_found_shifts` if new array has fewer entries or if</span>
<span class="sd">    mean of `prev_found_shifts` is outside initial range of `search_shifts`.</span>
<span class="sd">    If more than one `prev_found_shifts` is outside the `search_shifts` in the same way i.e. too high or too low,</span>
<span class="sd">    `search_shifts` will be updated too.</span>

<span class="sd">    Args:</span>
<span class="sd">        search_shifts: `int [n_shifts]`.</span>
<span class="sd">            Indicates all shifts currently searched over.</span>
<span class="sd">        prev_found_shifts: `int [n_shifts_found]`.</span>
<span class="sd">            Indicate shifts found on all previous runs of `compute_shift`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `int [n_new_shifts]`.</span>

<span class="sd">        New set of shifts around mean of previously found shifts.</span>
<span class="sd">        Will only return updated shifts if new array has fewer entries than before or mean of `prev_found_shifts`</span>
<span class="sd">        is outside range of `search_shifts`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_shifts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_shifts</span><span class="p">)</span>
    <span class="n">n_prev_shifts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_found_shifts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_shifts</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n_prev_shifts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">search_shifts</span><span class="p">))</span>
        <span class="n">mean_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prev_found_shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">n_shifts_new</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prev_found_shifts</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean_shift</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n_shifts_new</span> <span class="o">&lt;</span> <span class="n">n_shifts</span> <span class="ow">or</span> <span class="n">mean_shift</span> <span class="o">&lt;=</span> <span class="n">search_shifts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="ow">or</span> <span class="n">mean_shift</span> <span class="o">&gt;=</span> <span class="n">search_shifts</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="c1"># only update shifts if results in less to search over.</span>
            <span class="n">search_shifts</span> <span class="o">=</span> <span class="n">refined_shifts</span><span class="p">(</span><span class="n">search_shifts</span><span class="p">,</span> <span class="n">mean_shift</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">n_shifts_new</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prev_found_shifts</span> <span class="o">&gt;</span> <span class="n">search_shifts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">search_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">search_shifts</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">prev_found_shifts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prev_found_shifts</span> <span class="o">&lt;</span> <span class="n">search_shifts</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">search_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prev_found_shifts</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">search_shifts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">search_shifts</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../find_spots/detect/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Detect" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Detect
            </div>
          </div>
        </a>
      
      
        
        <a href="../starting_shifts/" class="md-footer__link md-footer__link--next" aria-label="Next: Starting Shifts" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Starting Shifts
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://github.com/jduffield65/coppafish" target="_blank" rel="noopener" title="Github Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.expand", "content.tabs.link", "navigation.sections", "navigation.top"], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>