
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>Register - coppafish</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#register" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="coppafish" class="md-header__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            coppafish
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Register
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../config_setup/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../overview/" class="md-tabs__link md-tabs__link--active">
        Pipeline
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../code/setup/notebook/" class="md-tabs__link">
        Code
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="coppafish" class="md-nav__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    coppafish
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config_setup/" class="md-nav__link">
        Setting up the Config File
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../run_code/" class="md-nav__link">
        Running the code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../view_results/" class="md-nav__link">
        Viewing the results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/" class="md-nav__link">
        Config Default Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notebook_comments/" class="md-nav__link">
        Notebook Comments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extract/" class="md-nav__link">
        Extract and Filter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Register
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Register
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#affine-transform" class="md-nav__link">
    Affine Transform
  </a>
  
    <nav class="md-nav" aria-label="Affine Transform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-transform" class="md-nav__link">
    Starting Transform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icp" class="md-nav__link">
    ICP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-icp-results" class="md-nav__link">
    Checking ICP results
  </a>
  
    <nav class="md-nav" aria-label="Checking ICP results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#number-of-matches" class="md-nav__link">
    Number of matches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chromatic-aberration" class="md-nav__link">
    Chromatic Aberration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shift" class="md-nav__link">
    Shift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-average-transform" class="md-nav__link">
    Error - average transform
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regularized-icp" class="md-nav__link">
    Regularized ICP
  </a>
  
    <nav class="md-nav" aria-label="Regularized ICP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_icp_reg" class="md-nav__link">
    view_icp_reg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-too-few-matches" class="md-nav__link">
    Error - too few matches
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
    <nav class="md-nav" aria-label="Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_affine_shift_info" class="md-nav__link">
    view_affine_shift_info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale_box_plots" class="md-nav__link">
    scale_box_plots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_icp" class="md-nav__link">
    view_icp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#psuedocode" class="md-nav__link">
    Psuedocode
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/setup/notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/setup/tile_details/" class="md-nav__link">
        Tile Detail
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/setup/file_names/" class="md-nav__link">
        File Names
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Extract
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extract" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Extract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/deconvolution/" class="md-nav__link">
        Deconvolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/fstack/" class="md-nav__link">
        Fstack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/scale/" class="md-nav__link">
        Scale
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Find Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Find Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Find Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/find_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/find_spots/check_spots/" class="md-nav__link">
        Check Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/find_spots/detect/" class="md-nav__link">
        Detect
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Stitch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Stitch" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Stitch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/shift/" class="md-nav__link">
        Shift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/starting_shifts/" class="md-nav__link">
        Starting Shifts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/tile_origin/" class="md-nav__link">
        Tile Origin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/check_shifts/" class="md-nav__link">
        Check Shifts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Register
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Register" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Register
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/register/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/register/check_transforms/" class="md-nav__link">
        Check Transforms
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Spot Colors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Spot Colors" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Spot Colors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/spot_colors/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_7">
          Call Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Call Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          Call Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/background/" class="md-nav__link">
        Background
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/bleed_matrix/" class="md-nav__link">
        Bleed Matrix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/dot_product/" class="md-nav__link">
        Dot Product
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/qual_check/" class="md-nav__link">
        Quality Check
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_8" type="checkbox" id="__nav_4_8" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_8">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OMP" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          OMP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/omp/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/omp/coefs/" class="md-nav__link">
        Coefficients
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/omp/spots/" class="md-nav__link">
        Spots
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_9" type="checkbox" id="__nav_4_9" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_9">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_9">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/run/" class="md-nav__link">
        Run
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/basic_info/" class="md-nav__link">
        Basic Info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/extract_run/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_10" type="checkbox" id="__nav_4_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_10">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_10">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/pciseq/" class="md-nav__link">
        pciSeq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/matlab/" class="md-nav__link">
        Matlab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/morphology/" class="md-nav__link">
        Morphology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/nd2/" class="md-nav__link">
        nd2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/npy/" class="md-nav__link">
        npy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/strel/" class="md-nav__link">
        Strel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_11" type="checkbox" id="__nav_4_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_11">
          Plot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_11">
          <span class="md-nav__icon md-icon"></span>
          Plot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/viewer/" class="md-nav__link">
        Viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/raw/" class="md-nav__link">
        Raw
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/extract/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/call_spots/" class="md-nav__link">
        Call Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_12" type="checkbox" id="__nav_4_12" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_12">
          Separate Round Registration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Separate Round Registration" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_12">
          <span class="md-nav__icon md-icon"></span>
          Separate Round Registration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/sep_round_reg/" class="md-nav__link">
        Sep round reg
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#affine-transform" class="md-nav__link">
    Affine Transform
  </a>
  
    <nav class="md-nav" aria-label="Affine Transform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-transform" class="md-nav__link">
    Starting Transform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icp" class="md-nav__link">
    ICP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-icp-results" class="md-nav__link">
    Checking ICP results
  </a>
  
    <nav class="md-nav" aria-label="Checking ICP results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#number-of-matches" class="md-nav__link">
    Number of matches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chromatic-aberration" class="md-nav__link">
    Chromatic Aberration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shift" class="md-nav__link">
    Shift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-average-transform" class="md-nav__link">
    Error - average transform
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regularized-icp" class="md-nav__link">
    Regularized ICP
  </a>
  
    <nav class="md-nav" aria-label="Regularized ICP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_icp_reg" class="md-nav__link">
    view_icp_reg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-too-few-matches" class="md-nav__link">
    Error - too few matches
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
    <nav class="md-nav" aria-label="Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_affine_shift_info" class="md-nav__link">
    view_affine_shift_info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale_box_plots" class="md-nav__link">
    scale_box_plots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_icp" class="md-nav__link">
    view_icp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#psuedocode" class="md-nav__link">
    Psuedocode
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/jduffield65/coppafish/edit/master/docs/pipeline/register.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="register">Register</h1>
<p>The <a href="../../code/pipeline/register/"><em>register</em> step of the pipeline</a> finds an affine transform between
the reference round/reference channel (<span class="arithmatex">\(r_{ref}\)</span>/<span class="arithmatex">\(c_{ref}\)</span>) and each imaging round and channel for every tile.
The affine transform to tile <span class="arithmatex">\(t\)</span>, round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span> is found through iterative closest point
using the shift, <code>nb.register_initial.shift[t, r]</code>, found during the <a href="../register_initial/"><em>register_initial</em></a> step of 
the pipeline as the starting point. It is saved to the <em>Notebook</em> as <code>nb.register.transform[t, r, c]</code>.
These transforms are <a href="../get_reference_spots/#applying-transform">used later in the pipeline</a> to 
determine the intensity of a pixel in each round and channel.</p>
<p>The <a href="../../notebook_comments/#register"><code>register</code></a> and <a href="../../notebook_comments/#register_debug"><code>register_debug</code></a> 
<em>NotebookPages</em> are added to the <em>Notebook</em> after this stage is finished.</p>
<h2 id="affine-transform">Affine Transform</h2>
<p>We want to find the transform from tile <span class="arithmatex">\(t\)</span>, round <span class="arithmatex">\(r_{ref}\)</span>, channel <span class="arithmatex">\(c_{ref}\)</span> to round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span> for all
tiles, rounds and channels such that there is pixel-level alignment between the images. The pixel-level 
alignment is important because most spots are only a few pixels in size, so even a one-pixel registration error 
can compromise the <code>spot_colors</code> found in the <a href="../get_reference_spots/">next stage of the pipeline</a> 
and thus the <a href="../call_reference_spots/">gene assignment</a>.</p>
<p>The shifts found in the <a href="../register_initial/"><em>register_initial</em></a> step of 
the pipeline are not sufficient for this, because of chromatic aberration which will cause a scaling between 
color channels. There may also be small rotational or non-rigid shifts; thus we find affine transformations 
which can include shifts, scalings, rotations and shears.</p>
<h3 id="starting-transform">Starting Transform</h3>
<p>The affine transforms are found using the <a href="../../code/register/base/#coppafish.register.base.icp">iterative-closest point</a> 
(<em>ICP</em>) algorithm. This is highly sensitive to local maxima, so it is initialized with the shifts found in the 
<a href="../register_initial/"><em>register_initial</em></a> step, <code>nb.register_initial.shift</code>.</p>
<p>The starting transform to a particular round and tile is the same for all channels. The shifts are put into
the form of an affine transform (<span class="arithmatex">\(4 \times 3\)</span> array) using the 
<a href="../../code/register/base/#coppafish.register.base.transform_from_scale_shift"><code>transform_from_scale_shift</code></a> function.</p>
<details class="example">
<summary>Starting transform from shifts</summary>
<p>The code below indicates how the initial shifts (<span class="arithmatex">\(n_{tiles} \times n_{rounds} \times 3\)</span> array) 
are converted into initial transforms (<span class="arithmatex">\(n_{tiles} \times n_{rounds} \times n_{channels} \times 4 \times 3\)</span> array).</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Code</label><label for="__tabbed_1_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">coppafish.register.base</span> <span class="kn">import</span> <span class="n">transform_from_scale_shift</span>
<span class="n">t_print</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">r_print</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">initial_shifts</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">register_initial</span><span class="o">.</span><span class="n">shift</span>   <span class="c1"># z shift is in z-pixel units</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial shift for tile </span><span class="si">{</span><span class="n">t_print</span><span class="si">}</span><span class="s2">, round </span><span class="si">{</span><span class="n">r_print</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">initial_shifts</span><span class="p">[</span><span class="n">t_print</span><span class="p">,</span> <span class="n">r_print</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Convert z shift into same units as yx pixels</span>
<span class="n">initial_shifts</span> <span class="o">=</span> <span class="n">initial_shifts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">z_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">pixel_size_z</span> <span class="o">/</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">pixel_size_xy</span><span class="p">]</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_tiles</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">use_rounds</span><span class="p">:</span>
        <span class="n">initial_shifts</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_shifts</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_scale</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial shift for tile </span><span class="si">{</span><span class="n">t_print</span><span class="si">}</span><span class="s2">, round </span><span class="si">{</span><span class="n">r_print</span><span class="si">}</span><span class="s2"> (z shift in YX pixels):</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">initial_shifts</span><span class="p">[</span><span class="n">t_print</span><span class="p">,</span> <span class="n">r_print</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Convert shifts to affine transform 4 x 3 form</span>
<span class="n">initial_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">n_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># set all scalings to 1 initially </span>
                                                        <span class="c1"># as just want shift.</span>
<span class="n">initial_transforms</span> <span class="o">=</span> <span class="n">transform_from_scale_shift</span><span class="p">(</span><span class="n">initial_scale</span><span class="p">,</span> <span class="n">initial_shifts</span><span class="p">)</span>

<span class="c1"># Show transform different for rounds but same for channel within round</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial transform for tile </span><span class="si">{</span><span class="n">t_print</span><span class="si">}</span><span class="s2">, round </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">, channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">initial_transforms</span><span class="p">[</span><span class="n">t_print</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>Initial Shifts for tile 1, round 1:
[25 14  1]
Initial shift for tile 1, round 1 (z shift in YX pixels):
[25.   14.    5.99]
Initial transform for tile 1, round 0, channel 0:
[[ 1.  0.  0.]
 [ 0.  1.  0.]
 [ 0.  0.  1.]
 [48. 30.  0.]]
Initial transform for tile 1, round 0, channel 1:
[[ 1.  0.  0.]
 [ 0.  1.  0.]
 [ 0.  0.  1.]
 [48. 30.  0.]]
Initial transform for tile 1, round 1, channel 0:
[[ 1.    0.    0.  ]
 [ 0.    1.    0.  ]
 [ 0.    0.    1.  ]
 [25.   14.    5.99]]
Initial transform for tile 1, round 1, channel 1:
[[ 1.    0.    0.  ]
 [ 0.    1.    0.  ]
 [ 0.    0.    1.  ]
 [25.   14.    5.99]]
</code></pre></div>
</div>
</div>
</div>
</details>
<h3 id="icp"><em>ICP</em></h3>
<p>The pseudocode for the <a href="../../code/register/base/#coppafish.register.base.icp"><em>ICP</em></a> algorithm to 
find the affine transform for tile <span class="arithmatex">\(t\)</span> round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span> is indicated below.
The shape of the various arrays are indicated in the comments (#).</p>
<details class="note">
<summary>Preparing point clouds</summary>
<p>Prior to the <em>ICP</em> algorithm, the <span class="arithmatex">\(yxz\)</span> coordinates of spots on a tile
are centered. This is because, it makes more sense to me, if any rotation is applied around 
the centre of the tile.</p>
<p>Also, like for the initial shifts, the z-coordinates must be converted into units of yx-pixels,
so overall:</p>
<div class="highlight"><pre><span></span><code><span class="n">spot_yxz</span> <span class="o">=</span> <span class="n">spot_yxz</span> <span class="o">-</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">tile_centre</span>  <span class="c1"># center coordinates</span>
<span class="c1"># Convert units of z-coordinates</span>
<span class="n">z_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">pixel_size_z</span> <span class="o">/</span> <span class="n">nb</span><span class="o">.</span><span class="n">basic_info</span><span class="o">.</span><span class="n">pixel_size_xy</span><span class="p">]</span>
<span class="n">spot_yxz</span> <span class="o">=</span> <span class="n">spot_yxz</span> <span class="o">*</span> <span class="n">z_scale</span>
</code></pre></div>
<p>For the non-reference point clouds we only keep spots which are isolated. This 
is because the <em>ICP</em> algorithm is less likely to fall into local maxima if 
the spots are quite well separated.</p>
<p>We deam a spot <a href="../../code/find_spots/base/#coppafish.find_spots.base.get_isolated_points">isolated</a> 
if the nearest spot to it is further away than <code>2 * neighb_dist</code>.
Where <code>neighb_dist = config['register']['neighb_dist_thresh_2d']</code> if <em>2D</em> and
<code>config['register']['neighb_dist_thresh_3d']</code> if <em>3D</em>. </p>
</details>
<p><code>n_iter</code> is the maximum number of iterations and is set by <code>config['register']['n_iter']</code>. 
<code>neighb_dist_thresh</code> is the distance in <span class="arithmatex">\(yx\)</span> pixels below which neighbours are a good match. 
It is given by <code>config['register']['neighb_dist_thresh_2d']</code> if <em>2D</em> and
<code>config['register']['neighb_dist_thresh_3d']</code> if <em>3D</em>. 
Only neighbours which are closer than this are used when computing the transform.</p>
<details class="note">
<summary>Padding <code>ref_spot_yxz</code></summary>
<p><code>ref_spot_yxz</code> has shape <code>[n_ref x 4]</code> not <code>[n_ref x 3]</code> because to be able to be multiplied by 
the affine transform (<code>[4 x 3]</code>), it must be padded with ones i.e. <code>ref_spot_yxz[:, 3] = 1</code>.</p>
<p><code>ref_spot_yxz @ transform</code> is then the same as <code>ref_spot_yxz[:, :3] @ transform[:3, :] + transform[3]</code> i.e.
rotation/scaling matrix applied and then the shift is added.</p>
</details>
<div class="highlight"><pre><span></span><code>spot_yxz = yxz coordinates for spots detected on tile t,
           round r, channel c.  # [n_base x 3]
ref_spot_yxz = padded yxz coordinates for spots detected on tile t,
               reference round, reference channel.  # [n_ref x 4]                    
transform_initial = starting transform for tile t, round r, channel c.

transform = transform_initial  # [4 x 3]
neighb_ind = zeros(n_ref)      # [n_ref]
neighb_ind_last = neighb_ind   # [n_ref]
i = 0
while i &lt; n_iter:
    1. Transform ref_spot_yxz according to transform to give 
       ref_spot_yxz_transform. # [n_ref x 3]
       This is just matrix multiplication.

    2. neighb_ind[s] is index of spot in spot_yxz closest to 
       ref_spot_yxz_transform[s].

    3. dist[s] is the distance between spot_yxz[neighb_ind[s]]
       and ref_spot_yxz_transform[s]  # [n_ref]

    4. Choose which spots to use to update the transform:
        use = dist &lt; neighb_dist_thresh
        spot_yxz_use = spot_yxz[neighb_ind[use]]  # [n_use x 3]
        ref_spot_yxz_use = ref_spot_yxz[use]  # [n_use x 4]

    5. Update transform to be the 4x3 matrix which multiplies ref_spot_yxz_use
       such that the distances between the transformed spots 
       and spot_yxz_use are minimised. This is the least squares solution.

    6. If neighb_ind and neighb_ind_last are identical, then stop iteration
       i.e. i = n_iter.

    7. neighb_ind_last = neighb_ind

    8. i = i + 1
</code></pre></div>
<h3 id="checking-icp-results">Checking <em>ICP</em> results</h3>
<p>Once the <a href="#icp"><em>ICP</em></a> algorithm has obtained a transform, <code>transform[t, r, c]</code> for each tile, round and channel, 
we want to determine if they are acceptable. Three criteria must be satisfied for 
<code>transform[t, r, c]</code> to be <a href="../../code/register/base/#coppafish.register.base.get_average_transform">considered acceptable</a>:</p>
<ul>
<li><a href="#number-of-matches">Number of matches exceeds threshold</a></li>
<li><a href="#chromatic-aberration">Diagonal elements of <code>transform[t, r, c]</code> are near to what we broadly expect them to be</a>.</li>
<li><a href="#shift">Shift part of <code>transform[t, r, c]</code> i.e. <code>transform[t, r, c][3]</code> is near to what we broadly expect it to be</a>.</li>
</ul>
<h4 id="number-of-matches">Number of matches</h4>
<p>The number of matches, <code>n_matches[t, r, c]</code>, 
are the number of pairs of spots used to compute <code>transform[t, r, c]</code>, i.e. 
<code>n_use</code> in the above pseudocode, and thus it depends on the <code>neighb_dist_thresh</code> parameter. 
The number of matches are saved to the <em>Notebook</em> as <code>nb.register_debug.n_matches[t, r, c]</code>.</p>
<p><code>transform[t, r, c]</code> is deemed to have failed if <code>n_matches[t, r, c] &lt; n_matches_thresh[t, r, c]</code>.
<code>n_matches_thresh[t, r, c]</code> is computed as follows:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># n_ref[t] - number of spots detected on tile t,</span>
<span class="c1">#            reference round, reference channel</span>
<span class="c1"># n_base[t, r, c] - number of spots detected on tile t, </span>
<span class="c1">#                   round r, channel c</span>

<span class="c1"># Set threshold to be fraction of max possible n_matches</span>
<span class="n">n_matches_thresh</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh_fract</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_ref</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">n_base</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>

<span class="c1"># Clip threshold between min and max</span>
<span class="k">if</span> <span class="n">n_matches_thresh</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresh_min</span><span class="p">:</span>
    <span class="n">n_matches_thresh</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh_min</span>
<span class="k">if</span> <span class="n">n_matches_thresh</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh_max</span><span class="p">:</span>
    <span class="n">n_matches_thresh</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh_max</span>
</code></pre></div>
<p>Where:</p>
<ul>
<li><code>thresh_fract = config['register']['matches_thresh_fract]</code>. <em>Default: 0.25</em></li>
<li><code>thresh_min = config['register']['matches_thresh_min]</code>. <em>Default: 25</em></li>
<li><code>thresh_max = config['register']['matches_thresh_max]</code>. <em>Default: 300</em></li>
</ul>
<p>The default are parameters are such that in most cases, <code>n_matches_thresh[t, r, c] = thresh_max</code> so 
we require more than 300 matches for a transform to be acceptable. 
The thresholds are saved to the <em>Notebook</em> as <code>nb.register_debug.n_matches_thresh[t, r, c]</code>.</p>
<h4 id="chromatic-aberration">Chromatic Aberration</h4>
<p>Our expectation of the transforms found is that there should be a scaling factor to 
correct for chromatic aberration between color channels. We do not expect significant scaling between rounds
or tiles though.</p>
<p>Thus, we can compute the expected scaling for each transform to channel <span class="arithmatex">\(c\)</span> by averaging over all tiles 
and rounds. We also avoid transforms which have failed based on their <a href="#number-of-matches">matches</a>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Code</label><label for="__tabbed_2_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># transforms: [n_tiles x n_rounds x n_channels x 4 x 3]</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">failed</span> <span class="o">=</span> <span class="n">n_matches</span> <span class="o">&lt;</span> <span class="n">n_matches_thresh</span>   <span class="c1"># [n_tiles x n_rounds x n_channels]</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>  <span class="c1"># [n_tiles x n_rounds x n_channels x 3]</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [3 x n_tiles x n_rounds x n_channels]</span>
<span class="n">failed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">failed</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [3 x n_tiles x n_riounds x n_channels]</span>
<span class="n">scaling</span><span class="p">[</span><span class="n">failed</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># don&#39;t use failed t/r/c in average</span>

<span class="c1"># Use median to take average as to avoid outlier values</span>
<span class="n">av_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># average over tiles and rounds</span>
<span class="n">av_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">av_scaling</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>      <span class="c1"># [n_channels x 3]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">av_scaling</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>[[0.99863349 0.99863439 1.        ]
 [1.001767   1.00164772 1.        ]
 [1.00026354 1.00017105 1.        ]
 [1.00129138 1.00123909 1.        ]
 [1.00002731 0.99993372 1.        ]
 [0.99826052 0.99822415 1.        ]
 [0.99554262 0.99556903 1.        ]]
</code></pre></div>
</div>
</div>
</div>
<p>This gives us <code>av_scaling[c, i]</code> which is the scale factor for channel <span class="arithmatex">\(c\)</span> in dimension <span class="arithmatex">\(i\)</span> (order is <span class="arithmatex">\(yxz\)</span>). 
This is saved to the <em>Notebook</em> as <code>nb.register_debug.av_scaling</code>. 
From the <em>Output</em> above, there is a clear difference between channels, as we expect. Also, the <span class="arithmatex">\(y\)</span> and <span class="arithmatex">\(x\)</span> scaling
for a particular channel tend to be very similar but the <span class="arithmatex">\(z\)</span> scaling is always 1. This is because the z-pixels
are larger than the yx-pixels so there are no two pixels very close in <span class="arithmatex">\(z\)</span>.</p>
<p><code>transform[t, r, c]</code> is deemed to have failed if the scaling is significantly different from <code>av_scaling[c]</code> 
as quantified by:</p>
<p><code>np.abs(transform[t, r, c][i, i] - av_scaling[c, i]) &gt; scale_thresh[i]</code> for any dimension <span class="arithmatex">\(i\)</span>. </p>
<p>Here, <code>scale_thresh</code> is <code>config['register']['scale_dev_thresh']</code>. The <a href="../../config/#register">default value</a> 
of <code>[0.01, 0.01, 0.1]</code> is 
intended to be quite hard to exceed i.e. only really awful scaling will fail in this way. The <span class="arithmatex">\(z\)</span> threshold
is larger because if there is scaling in <span class="arithmatex">\(z\)</span>, you would expect larger variance because the <span class="arithmatex">\(z\)</span>-pixels are larger
than the <span class="arithmatex">\(yx\)</span>-pixels (this may need looking at though, I am not too sure about it, but I think I made it
larger because quite a lot of transforms were failing based on the z-scaling).</p>
<h4 id="shift">Shift</h4>
<p>Our expectation of the transforms found is that there should be a shift between rounds 
for a particular tile (in <a href="../register_initial/#updating-initial-range"><em>register_initial</em></a> 
we expected the shift to a particular round should be quite similar across tiles - we relax that here).
We do not expect significant shifts between channels for the same tile and round though.</p>
<p>Thus, we can compute the expected shift for each transform of tile <span class="arithmatex">\(t\)</span> to round <span class="arithmatex">\(r\)</span> by averaging over all channels. 
We also avoid transforms which have failed based on their <a href="#number-of-matches">matches</a> or 
<a href="#chromatic-aberration">scaling</a>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Code</label><label for="__tabbed_3_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># transforms: [n_tiles x n_rounds x n_channels x 4 x 3]</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">failed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">failed_matches</span><span class="p">,</span> <span class="n">failed_scale</span><span class="p">)</span>   <span class="c1"># [n_tiles x n_rounds x n_channels]</span>
<span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">transforms</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [3 x n_tiles x n_rounds x n_channels]</span>
<span class="n">failed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">failed</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [3 x n_tiles x n_rounds x n_channels]</span>
<span class="n">shifts</span><span class="p">[</span><span class="n">failed</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># don&#39;t use failed t/r/c in average</span>

<span class="c1"># Use median to take average as to avoid outlier values</span>
<span class="n">av_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># average over channels</span>
<span class="n">av_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">av_shifts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>      <span class="c1"># [n_tiles x n_rounds x 3]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">av_shifts</span><span class="p">[:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,:],</span> <span class="mi">2</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>[[[35.79 24.04  0.  ]
  [14.49  9.23 -0.  ]
  [-2.25 -2.43  5.99]]

 [[47.74 30.01  0.  ]
  [25.26 13.78  5.99]
  [10.35  4.43 -0.  ]]

 [[52.54 36.04  0.  ]
  [32.24 21.99  5.99]
  [16.64 11.6   5.99]]

 [[57.75 38.31 -5.99]
  [38.57 27.41 -0.  ]
  [26.15 16.23  0.  ]]]
</code></pre></div>
</div>
</div>
</div>
<p>This gives us <code>av_shifts[t, r, i]</code> which is the average shift for tile <span class="arithmatex">\(t\)</span>, round <span class="arithmatex">\(r\)</span> in dimension <span class="arithmatex">\(i\)</span> (order is <span class="arithmatex">\(yxz\)</span>). 
This is saved to the <em>Notebook</em> as <code>nb.register_debug.av_shifts</code>. From the first 4 tiles and 3 rounds printed in 
<em>Output</em> above, we see that for a given round, there is significant variance across tiles 
(note that the z-shift is in units of <span class="arithmatex">\(yx\)</span>-pixels, 5.99 in these units is 1 in z-pixels). </p>
<details class="note">
<summary>Systematic shift between tiles</summary>
<p>In the above <em>Output</em>, there seems to be a systematic shift between tiles:</p>
<ul>
<li>The <span class="arithmatex">\(y\)</span> shifts for tile 1 for all rounds seem to be approximately equal to the tile 0 shifts + 11.</li>
<li>The <span class="arithmatex">\(x\)</span> shifts for tile 1 for all rounds seem to be approximately equal to the tile 0 shifts + 6.</li>
<li>The <span class="arithmatex">\(y\)</span> shifts for tile 2 for all rounds seem to be approximately equal to the tile 1 shifts + 6.</li>
<li>The <span class="arithmatex">\(x\)</span> shifts for tile 2 for all rounds seem to be approximately equal to the tile 1 shifts + 7.</li>
<li>The <span class="arithmatex">\(y\)</span> shifts for tile 3 for all rounds seem to be approximately equal to the tile 2 shifts + 5.</li>
<li>The <span class="arithmatex">\(x\)</span> shifts for tile 3 for all rounds seem to be approximately equal to the tile 2 shifts + 5.</li>
<li>The <span class="arithmatex">\(z\)</span> shifts for tile 3 for all rounds seem to be approximately equal to the tile 2 shifts - 5.99.</li>
</ul>
<p>I am not sure if this is seen in all experiments but if it is, it may be useful to 
incorporate it into the code, both here and in the <a href="../register_initial/"><em>register initial</em></a> section.</p>
</details>
<p><code>transform[t, r, c]</code> is deemed to have failed if the shift is significantly different from <code>av_shifts[t, r]</code> 
as quantified by:</p>
<p><code>np.abs(transform[t, r, c][3, i] - av_shifts[t, r, i]) &gt; shift_thresh[i]</code> for any dimension <span class="arithmatex">\(i\)</span>. </p>
<p>Here, <code>shift_thresh</code> is <code>config['register']['shift_dev_thresh']</code>. The <a href="../../config/#register">default value</a> 
of <code>[15, 15, 5]</code> is 
intended to be quite hard to exceed i.e. only really awful shifts will fail in this way. 
<code>config['register']['shift_dev_thresh'][2]</code> is in units of z-pixels and is converted to <span class="arithmatex">\(yx\)</span>-pixels before
applying the thresholding (the default value of 5 will become 29.95 for our examples).</p>
<h4 id="error-average-transform">Error - average transform</h4>
<p>When <a href="../../code/register/base/#coppafish.register.base.get_average_transform">computing</a> <code>av_shifts[t, r]</code>, 
we require that for tile <span class="arithmatex">\(t\)</span>, round <span class="arithmatex">\(r\)</span>, at least one channel has not failed
based on <a href="#number-of-matches">matches</a> or <a href="#chromatic-aberration">scaling</a>. If they have all failed, 
it cannot be computed and an error will be raised indicating the problematic tile/round pairs.</p>
<p>If this error occurs, it is probably worth using the <a href="#debugging">diagnostics</a> to see why registration
produces few matches or bad scaling for these tile/round pairs.
If it seems to be a single tile or round that is the problem, it may be worth removing it from 
<code>use_tiles</code>/<code>use_rounds</code> and <a href="../../notebook/#changing-basic_info-mid-pipeline">re-running</a>.</p>
<p>When <a href="../../code/register/base/#coppafish.register.base.get_average_transform">computing</a> <code>av_scaling[c]</code>, 
we require that for channel <span class="arithmatex">\(c\)</span>, at least one round and tile has not failed
based on <a href="#number-of-matches">matches</a>. If they have all failed, 
it cannot be computed and an error will be raised indicating the problematic channels.</p>
<p>As <span class="arithmatex">\(n_{tiles} \times n_{rounds} &gt; n_{channels}\)</span>, this error is less likely to occur, but if it does, it 
is probably worth removing the indicated channels from <code>use_channels</code> and 
<a href="../../notebook/#changing-basic_info-mid-pipeline">re-running</a>.</p>
<h3 id="regularized-icp">Regularized <em>ICP</em></h3>
<p>For the transforms which <a href="#checking-icp-results">failed</a> (those for which <code>nb.register_debug.failed[t, r, c] == True</code>),
we save the failed transform as <code>nb.register_debug.transform_outlier[t, r, c]</code>.
We then re-run <em>ICP</em> to compute a new transform.
This time, though we want to ensure that <code>transform[t, r, c]</code> is pretty close to the <code>av_transform[t, r, c]</code>.</p>
<details class="note">
<summary><code>av_transform</code></summary>
<p><code>av_transform[t, r, c]</code> is the expected transform for tile <span class="arithmatex">\(t\)</span>, round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span>.
It is assumed to have no rotation, a scaling consistent with acceptable transforms to channel <span class="arithmatex">\(c\)</span>
and a shift consistent with acceptable transforms for tile <span class="arithmatex">\(t\)</span> to round <span class="arithmatex">\(r\)</span>.</p>
<p>The <em>Output</em> below shows the average transform for tile 1, round 0, channel 0 using the 
<a href="#chromatic-aberration"><code>av_scaling</code></a> and <a href="#shift"><code>av_shifts</code></a> produced in the earlier sections.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Code</label><label for="__tabbed_4_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">av_transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tiles</span><span class="p">,</span> <span class="n">n_rounds</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">use_tiles</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">use_rounds</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">use_channels</span><span class="p">:</span>
            <span class="n">av_transform</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_shifts</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">av_transform</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_scaling</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">av_transform</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>[[ 0.99863  0.       0.     ]
 [ 0.       0.99863  0.     ]
 [ 0.       0.       1.     ]
 [47.73948 30.00533  0.     ]]
</code></pre></div>
</div>
</div>
</div>
</details>
<p>To do this, we set the initial transform for <code>transform[t, r, c]</code> to be <code>av_transform[t, r, c]</code>. 
The <em>ICP</em> algorithm is then the same as in the <a href="#icp">pseudocode</a> except for section 5.
For normal least squares, we are finding the <span class="arithmatex">\(4\times3\)</span> transform <span class="arithmatex">\(M\)</span>, 
such that the following loss function is minimised:</p>
<div class="arithmatex">\[
L = \sum_{s=0}^{n_{neighb}-1} D_{s}^2 = \sum_{s=0}^{n_{neighb}-1} (y_s - x_sM)^2
\]</div>
<p>Where:</p>
<ul>
<li><span class="arithmatex">\(n_{neighb}\)</span> is <code>n_use</code> introduced in step 4 of the <a href="#icp">pseudocode</a>.</li>
<li><span class="arithmatex">\(y_s\)</span> is <code>spot_yxz_use[s]</code> introduced in step 4 of the <a href="#icp">pseudocode</a> (<span class="arithmatex">\(n_{neighb} \times 3\)</span>)</li>
<li><span class="arithmatex">\(x_s\)</span> is <code>ref_spot_yxz_use[s]</code> introduced in step 4 of the <a href="#icp">pseudocode</a> (<span class="arithmatex">\(n_{neighb} \times 4\)</span>)</li>
</ul>
<p>To keep <span class="arithmatex">\(M\)</span> close to the average transform, <span class="arithmatex">\(M_a\)</span>, we find <span class="arithmatex">\(M\)</span> through regularized least
squares which minimises the following loss function:</p>
<div class="arithmatex">\[
L = \sum_{s=0}^{n_{neighb}-1} D_{s}^2 + 0.5\lambda (\mu D_{scale}^2 + D_{shift}^2)
\]</div>
<p>Where:</p>
<ul>
<li><span class="arithmatex">\(D_{scale}^2 = \sum_{i=0}^2\sum_{j=0}^2(M_{ij} - M_{a_{ij}})^2\)</span> is the squared
distance between <code>transform[:3, :]</code> and <code>av_transform[:3, :]</code> i.e. between the rotation/scaling <span class="arithmatex">\(3\times3\)</span> matrix part
of the transforms.</li>
<li><span class="arithmatex">\(D_{shift}^2 = \sum_{j=0}^2(M_{3j} - M_{a_{3j}})^2\)</span> is the squared
distance between <code>transform[3]</code> and <code>av_transform[3]</code> i.e. between the shift part of the transforms.</li>
<li><span class="arithmatex">\(\lambda\)</span> is <code>config['register']['regularize_constant']</code>. <em>Default: 500</em></li>
<li><span class="arithmatex">\(\mu\)</span> is <code>config['register']['regularize_factor']</code>. <em>Default: <span class="arithmatex">\(5\times10^4\)</span></em></li>
</ul>
<details class="note">
<summary>Implementing regularized least squares in python</summary>
<p>Lets suppose we are doing normal least squares with <span class="arithmatex">\(n_{neighb} = 4\)</span>,</p>
<div class="arithmatex">\[
x = \begin{pmatrix}
    \lambda_0 &amp; 0 &amp; 0 &amp; 0\\
    0 &amp; \lambda_0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; \lambda_0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; \lambda_1
    \end{pmatrix},
\]</div>
<div class="arithmatex">\[
y = xM_a
  = \begin{pmatrix}
    \lambda_0M_{a_{00}} &amp; 0 &amp; 0\\
    0 &amp; \lambda_0M_{a_{11}} &amp; 0\\
    0 &amp; 0 &amp; \lambda_0M_{a_{22}}\\
    \lambda_1M_{a_{30}} &amp; \lambda_1M_{a_{31}} &amp; \lambda_1M_{a_{32}}
    \end{pmatrix}
\]</div>
<p>Then the least squares solution for <span class="arithmatex">\(M\)</span> will be the one which minimises the loss function:</p>
<div class="arithmatex">\[
L = \sum(y - xM)^2 = \sum x^2(M_a - M)^2 = \sum_{i=0}^3x_{ii}^2\sum_{j=0}^2(M_{ij} - M_{a_{ij}})^2 = 
\lambda_0^2 D_{scale}^2 + \lambda_1^2 D_{shift}^2
\]</div>
<p>This matches the additional term in the regularised least squares loss function if:</p>
<div class="arithmatex">\[
\lambda_0 = \sqrt{0.5\lambda\mu}
\]</div>
<div class="arithmatex">\[
\lambda_1 = \sqrt{0.5\lambda}
\]</div>
<p>Hence in <a href="../../code/register/base/#coppafish.register.base.get_transform">python</a>, 
we append to the <span class="arithmatex">\(y\)</span> array containing <code>spot_yxz_use</code> the form of y here so
it now has shape <span class="arithmatex">\((n_{neighb}+4) \times 3\)</span>. We also append to the <span class="arithmatex">\(x\)</span> array containing
<code>ref_spot_yxz_use</code> the form of x here so it now has shape <span class="arithmatex">\((n_{neighb}+4) \times 4\)</span>.</p>
<p>If we then just do normal least squares (<code>np.linalg.lstsq(x, y)</code>) on these modified <span class="arithmatex">\(y\)</span> and <span class="arithmatex">\(x\)</span> arrays,
we get the regularized least squares solution for <span class="arithmatex">\(M\)</span>. </p>
</details>
<p>The intuition for suitable values of <span class="arithmatex">\(\lambda\)</span> and <span class="arithmatex">\(\mu\)</span> comes from the following:</p>
<ul>
<li>The desired distance between the shift found and the target shift, <span class="arithmatex">\(D_{shift}\)</span>, 
is the equal to the average distance between neighbouring spots (the average of <span class="arithmatex">\(D_s\)</span>). </li>
<li>If <span class="arithmatex">\(\lambda = n_{neighb}\)</span>, the contribution of the two terms in the loss function will
then be equal if <span class="arithmatex">\(\mu = D_{shift}^2/D_{scale}^2\)</span> (in this case, regularised term
is <span class="arithmatex">\(n_{neighb}D_{shift}^2\)</span> but <span class="arithmatex">\(D_{shift}^2\)</span> is average of <span class="arithmatex">\(D_s^2\)</span> so this is equivalent to
<span class="arithmatex">\(\sum_{s=0}^{n_{neighb}-1} D_{s}^2\)</span>).</li>
<li>
<p>A typical value of <span class="arithmatex">\(D_s\)</span> is 2 (must be below <code>neighb_dist_thresh</code>) and a typical target value
of <span class="arithmatex">\(D_{scale}\)</span> is 0.009 hence <span class="arithmatex">\(\mu = 2^2/0.009^2 \approx 5\times10^4\)</span>. </p>
<p>The larger <span class="arithmatex">\(\mu\)</span>, the more the regularization will affect the scaling/rotation at the expense of the shift.</p>
</li>
<li>
<p>Regularised term dominates the loss function if <span class="arithmatex">\(\lambda &gt; n_{neighb}\)</span> so that as 
<span class="arithmatex">\(\lambda \rightarrow \infty\)</span>, <span class="arithmatex">\(M \rightarrow M_a\)</span>. Regularised term has little effect if <span class="arithmatex">\(\lambda &lt; n_{neighb}\)</span>
such that <span class="arithmatex">\(M\)</span> tends to the normal least squares solution as <span class="arithmatex">\(\lambda \rightarrow 0\)</span>.</p>
<p>Hence, the value of <span class="arithmatex">\(\lambda\)</span> should be thought of as an <span class="arithmatex">\(n_{neighb}\)</span> threshold. If there are more neighbours
than <span class="arithmatex">\(\lambda\)</span> used to determine <span class="arithmatex">\(M\)</span> then we trust that this is enough to get the correct transform.
If there are less than <span class="arithmatex">\(\lambda\)</span> neighbours used, we don't think this is enough to trust the transform it would
produce freely, so we restrict the value of <span class="arithmatex">\(M\)</span> produced to be near the expected <span class="arithmatex">\(M_a\)</span>. </p>
<p>Typically, 500 neighbours is quite a good value, <code>config['register']['regularize_constant']</code> 
should always be larger than <code>config['register']['matches_thresh_max']</code>.</p>
</li>
</ul>
<h4 id="view_icp_reg"><a href="../../code/plot/register/#view_icp_reg"><code>view_icp_reg</code></a></h4>
<p>The function <a href="../../code/plot/register/#view_icp_reg"><code>view_icp_reg</code></a> is also useful for investigating
the effect of <span class="arithmatex">\(\lambda\)</span> and <span class="arithmatex">\(\mu\)</span>.</p>
<p>It is very similar to <a href="#view_icp"><code>view_icp</code></a> but <code>view_icp_reg(t, r, c, reg_constant=[lambda1, lambda2], 
reg_factor=[mu1, mu2])</code>
will have blue point clouds corresponding to:</p>
<ul>
<li>Reference: Reference (<span class="arithmatex">\(r_{ref}\)</span>/<span class="arithmatex">\(c_{ref}\)</span>) point cloud for tile <span class="arithmatex">\(t\)</span> with no transform applied.</li>
<li><span class="arithmatex">\(\lambda=0\)</span>: Reference point cloud transformed according to transform found with no regularization.</li>
<li><span class="arithmatex">\(\lambda=\infty\)</span>: Reference point cloud transformed according to target transform for regularization, <span class="arithmatex">\(M_a\)</span>.
This is found from <code>av_scaling[c]</code> and <code>av_shifts[t, r]</code> unless it is provided.</li>
<li><span class="arithmatex">\(\lambda=\)</span><code>lambda1</code>, <span class="arithmatex">\(\mu=\)</span><code>mu1</code>: Reference point cloud transformed according to transform found with 
regularized <em>ICP</em> using <code>lambda1</code> and <code>mu1</code> as the regularization parameters.</li>
<li><span class="arithmatex">\(\lambda=\)</span><code>lambda2</code>, <span class="arithmatex">\(\mu=\)</span><code>mu2</code>: Reference point cloud transformed according to transform found with 
regularized <em>ICP</em> using <code>lambda2</code> and <code>mu2</code> as the regularization parameters.</li>
</ul>
<p>If <code>reg_constant</code> and <code>reg_factor</code> are not provided, <code>config['register']['regularize_constant']</code> and
<code>config['register']['regularize_factor']</code> will be used.</p>
<p>The example below shows the point clouds produced after running
<code>view_icp_reg(0, 1, 0, reg_constant=[3e4], reg_factor=[1e6])</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:4"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><input id="__tabbed_5_4" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">No transform</label><label for="__tabbed_5_2"><span class="arithmatex">\(\lambda=0\)</span></label><label for="__tabbed_5_3"><span class="arithmatex">\(\lambda=\infty\)</span></label><label for="__tabbed_5_4"><span class="arithmatex">\(\lambda=30000, \mu=1\times10^6\)</span></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/pc_no_transform.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/pc_no_reg.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/pc_reg_infinite.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/pc_reg.png" width="800" /></p>
</div>
</div>
</div>
<p>Here we see that all the transforms are visibly different but the <span class="arithmatex">\(\lambda=30000, \mu=1\times10^6\)</span> case
is closer to <span class="arithmatex">\(\lambda=\infty\)</span> than <span class="arithmatex">\(\lambda=0\)</span>. This makes sense because as shown in the right sidebar 
of the plots, the number of matches is about 5600 so <span class="arithmatex">\(\lambda = 30000 &gt; n_{neighb}\)</span> so 
the final transform should be close to the target transform we are regularising towards.</p>
<p>If <a href="../../code/plot/register/#view_icp_reg"><code>view_icp_reg</code></a> is run with <code>plot_residual=True</code>, it produces
another plot which indicates how <span class="arithmatex">\(D_{shift}\)</span> and <span class="arithmatex">\(D_{scale}\)</span> vary with different values of <code>reg_constant</code>
and <code>reg_factor</code>. </p>
<p><code>view_icp_reg(nb, 0, 1, 0, reg_constant=np.logspace(0, 7, 8), reg_factor=[5e4]*8, plot_residual=True)</code> 
produces the following additional plot:</p>
<p><img alt="image" src="../../images/pipeline/register/varying_reg_constant.png" width="800" /></p>
<p>Here, each colored marker refers to a different <span class="arithmatex">\(\lambda/\mu\)</span> combination. 
The <span class="arithmatex">\(\lambda=0\)</span> horizontal line indicates the values with no regularisation and 
the <span class="arithmatex">\(n_{matches}\)</span> line indicates the number of matches found with <span class="arithmatex">\(\lambda=\infty\)</span>. </p>
<p>This plot nicely shows that for <span class="arithmatex">\(\lambda &lt; n_{matches}\)</span>, the transform found is pretty close to 
the normal least squares solution but for <span class="arithmatex">\(\lambda &gt; n_{matches}\)</span>, it is closer to the 
target transform we are regularising towards.</p>
<p><code>view_icp_reg(nb, 0, 1, 0, reg_constant=[500] * 8, reg_factor=np.logspace(2, 9, 8), plot_residual=True)</code> 
produces the following additional plot:</p>
<p><img alt="image" src="../../images/pipeline/register/varying_reg_factor.png" width="800" /></p>
<p>This shows that varying <span class="arithmatex">\(\mu\)</span> while keeping <span class="arithmatex">\(\lambda\)</span> constant does not affect <span class="arithmatex">\(D_{shift}\)</span> much 
but <span class="arithmatex">\(D_{scale}\)</span> does decrease as <span class="arithmatex">\(\mu\)</span> increases.</p>
<h2 id="error-too-few-matches">Error - too few matches</h2>
<p>After the <a href="../call_reference_spots/"><em>call reference spots</em></a> step, 
<a href="../../code/register/check_transforms/#coppafish.register.check_transforms.check_transforms"><code>check_transforms</code></a> 
will be run.</p>
<p>This will produce a warning for any tile, round, channel for which</p>
<p><code>nb.register_debug.n_matches &lt; nb.register_debug.n_matches_thresh</code></p>
<p>An error will be raised if any of the following is satisfied:</p>
<ul>
<li>
<p>For any given channel, the number of transforms with 
<code>n_matches &lt; n_matches_thresh</code> exceeds <code>error_fraction</code>.</p>
<p>The faulty channels should then be removed from <code>use_channels</code>.</p>
</li>
<li>
<p>For any given tile, the number of transforms with 
<code>n_matches &lt; n_matches_thresh</code> exceeds <code>error_fraction</code>.</p>
<p>The faulty tiles should then be removed from <code>use_tiles</code>.</p>
</li>
<li>
<p>For any given round, the number of transforms with 
<code>n_matches &lt; n_matches_thresh</code> exceeds <code>error_fraction</code>.</p>
<p>The faulty rounds should then be removed from <code>use_rounds</code>.</p>
</li>
</ul>
<p><code>error_fraction</code> is given by <code>config['register']['n_transforms_error_fraction</code>].</p>
<h2 id="debugging">Debugging</h2>
<p>There are a few functions using matplotlib which may help to debug this section of the pipeline.</p>
<h3 id="view_affine_shift_info"><a href="../../code/plot/register/#view_affine_shift_info"><code>view_affine_shift_info</code></a></h3>
<p>The <a href="../../code/plot/register/#view_affine_shift_info"><code>view_affine_shift_info</code></a> function
plots the shift part of the affine transform (<code>nb.register.transform[t, r, c, 3]</code>) to 
all tiles of a given round and channel on the same plot
(there are 3 plots for each round and channel).</p>
<p>It also includes a plot of <code>nb.register_debug.n_matches</code> vs <code>nb.register_debug.error</code> for each round and channel.
The error is the root-mean-square distance between neighbours used to compute the transform. Thus, the lower 
this value, and the higher <span class="arithmatex">\(n_{matches}\)</span>, the better the transform.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Channel 0</label><label for="__tabbed_6_2">Channel 2</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/affine_info0.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/affine_info2.png" width="800" /></p>
</div>
</div>
</div>
<p>The channel shown is changed by scrolling with the mouse and as a sanity check, we do not expect
the top two plots to vary much when the channel changes (the round 0 shifts above is quite a good example).</p>
<p>The numbers refer to the tile, and they are blue if 
<code>nb.register_debug.n_matches[t, r, c] &gt; nb.register_debug.n_matches_thresh[t, r, c]</code>.
Otherwise, they are red, as with tile 2 in round 1 and 4 of the channel 2 plots.</p>
<p>As with <a href="../register_initial/#view_register_shift_info"><code>view_register_shift_info</code></a>, this function 
can also be used to show <code>nb.register_debug.transform_outlier[t, r, c, 3]</code> by setting <code>outlier=True</code>, although 
the bottom plot will always show <code>nb.register_debug.n_matches</code> vs <code>nb.register_debug.error</code>.</p>
<h3 id="scale_box_plots"><a href="../../code/plot/register/#scale_box_plots"><code>scale_box_plots</code></a></h3>
<p>This function produces two or three plots, one for each dimension. In plot <span class="arithmatex">\(i\)</span>, there is a boxplot 
for each round and channel of <code>nb.register.transform[:, r, c, i, i]</code>:</p>
<p><img alt="image" src="../../images/pipeline/register/scale_box_plots.png" width="800" /></p>
<p>In this plot, we expect for a given channel, the scaling should be similar across all rounds and tiles (i.e.
boxplots of the same color should be at the same height, and they should have quite small ranges with any 
outlier tiles (white crosses, +) not far from the boxplot). Also, we expect the <em>Scaling - Y</em> and
<em>Scaling - X</em> to be very similar. <em>Scaling - Z</em> will likely be different, but it won't be shown if
the range of <em>Scaling - Z</em> is less than 0.00001, which usually the case.</p>
<h3 id="view_icp"><a href="../../code/plot/register/#view_icp"><code>view_icp</code></a></h3>
<p>This is similar to <a href="../stitch/#view_stitch_overlap"><code>view_stitch_overlap</code></a>.
<a href="../../code/plot/register/#view_icp"><code>view_icp(nb, t, r, c)</code></a>
will always show the local coordinates of the point cloud for tile <span class="arithmatex">\(t\)</span>, round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span> in red.
This is <code>spot_yxz</code> in the <a href="#icp">psuedocode</a>.</p>
<p>There are then buttons to select which reference point cloud for tile <span class="arithmatex">\(t\)</span>, round <span class="arithmatex">\(r_{ref}\)</span>, channel 
<span class="arithmatex">\(c_{ref}\)</span> is plotted in blue:</p>
<ul>
<li><em>No transform</em>: This is the reference point cloud with no transform applied
(<code>ref_spot_yxz</code> in the <a href="#icp">psuedocode</a>).</li>
<li><em>Shift</em>: This is the reference point cloud, shifted according to <code>nb.register_initial.shifts[t, r]</code>
(<code>ref_spot_yxz_transform</code> computed in the first iteration in the <a href="#icp">psuedocode</a>)</li>
<li><em>Affine</em>: This is the reference point cloud, transformed according to <code>nb.register.transform[t, r, c]</code>
(<code>ref_spot_yxz_transform</code> computed in the last iteration in the <a href="#icp">psuedocode</a>)</li>
</ul>
<p>An example is shown below:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:3"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><input id="__tabbed_7_3" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1"><em>No transform</em></label><label for="__tabbed_7_2"><em>Shift</em></label><label for="__tabbed_7_3"><em>Affine</em></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/view_icp0.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/view_icp1.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/register/view_icp2.png" width="800" /></p>
</div>
</div>
</div>
<p>If <a href="#regularized-icp">regularized <em>ICP</em></a> was required for the chosen tile/round/channel, an additional button 
will be present titled <em>Regularized</em>. The <em>Affine</em> button will then indicate 
the reference point cloud, transformed according to <code>nb.register_debug.transform_outlier</code> (i.e. with no regularization).
The <em>Regularized</em> button will indicate the reference point cloud, transformed according to 
<code>nb.register.transform[t, r, c]</code> (i.e. final transform found with regularization).</p>
<details class="note">
<summary>Can I use <a href="../../code/plot/register/#view_icp"><code>view_icp</code></a> before running the register stage of the pipeline?</summary>
<p>The <a href="../../code/plot/register/#view_icp"><code>view_icp</code></a> function can be used after the <code>find_spots</code>
page has been added to the <em>Notebook</em>. </p>
<p>In the case where the <em>Notebook</em> does not have the 
<code>register_initial</code> page, the shift will be computed. In the case where the <em>Notebook</em> does not have the 
<code>register</code> page, the affine transform will be 
<a href="../../code/register/base/#coppafish.register.base.get_single_affine_transform">computed</a> with no regularization.</p>
</details>
<h2 id="psuedocode">Psuedocode</h2>
<p>This is the pseudocode outlining the basics of this <a href="../../code/pipeline/register/">step of the pipeline</a>.
For more detailed pseudocode about how the transform is found, see the <a href="#icp"><em>ICP</em></a> section.</p>
<div class="highlight"><pre><span></span><code>r_ref = reference round
c_ref = reference round
spot_yxz[t, r, c] = yxz coordinates for spots detected on tile t,
                    round r, channel c.
for t in use_tiles:      
    Center reference point cloud:
        spot_yxz[t, r_ref, c_ref] = spot_yxz[t, r_ref, c_ref] - tile_centre
    Convert z coordinate into yx-pixels:
        spot_yxz[t, r_ref, c_ref][:, 2] = spot_yxz[t, r_ref, c_ref][:, 2] * z_scale
    for r in use_rounds:            
        for c in use_channels:
            Center point cloud:
                spot_yxz[t, r, c] = spot_yxz[t, r, c] - tile_centre
            Convert z coordinate into yx-pixels:
                spot_yxz[t, r, c][:, 2] = spot_yxz[t, r, c][:, 2] * z_scale
            Only keep spots whose nearest neighbour is far
                spot_yxz[t, r, c] = spot_yxz[t, r, c][isolated]           
            Find transform between spot_yxz[t, r_ref, c_ref] and 
                                   spot_yxz[t, r, c] using ICP.

Compute av_scaling and av_shift.

transforms[t, r, c] is failed if one of the following is satisfied:
    - n_matches &lt; n_matches_thresh.
    - transforms[t, r, c][i, i] significantly different to av_scaling[c, i] for any i.
    - transforms[t, r, c][3, i] significantly different to av_shift[t, r, i] for any i.

For failed transforms, recompute transform between 
    spot_yxz[t, r_ref, c_ref] and spot_yxz[t, r, c]
    using regularized ICP.           

Add transform to register NotebookPage.
Add debugging information to register_debug NotebookPage.      
Add register and register_debug NotebookPages to Notebook.  
</code></pre></div>




              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../register_initial/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Register Initial" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Register Initial
            </div>
          </div>
        </a>
      
      
        
        <a href="../get_reference_spots/" class="md-footer__link md-footer__link--next" aria-label="Next: Get Reference Spots" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Get Reference Spots
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://github.com/jduffield65/coppafish" target="_blank" rel="noopener" title="Github Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.expand", "content.tabs.link", "navigation.sections", "navigation.top"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>