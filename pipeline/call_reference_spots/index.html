
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>Call Reference Spots - coppafish</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#call-reference-spots" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="coppafish" class="md-header__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            coppafish
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Call Reference Spots
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../config_setup/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../overview/" class="md-tabs__link md-tabs__link--active">
        Pipeline
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../code/setup/notebook/" class="md-tabs__link">
        Code
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="coppafish" class="md-nav__button md-logo" aria-label="coppafish" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    coppafish
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jduffield65/coppafish" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jduffield65/coppafish
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config_setup/" class="md-nav__link">
        Setting up the Config File
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../run_code/" class="md-nav__link">
        Running the code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../view_results/" class="md-nav__link">
        Viewing the results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/" class="md-nav__link">
        Config Default Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notebook_comments/" class="md-nav__link">
        Notebook Comments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extract/" class="md-nav__link">
        Extract and Filter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Call Reference Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Call Reference Spots
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#re-run-call_reference_spots" class="md-nav__link">
    Re-run call_reference_spots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#color-normalisation" class="md-nav__link">
    Color Normalisation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_background" class="md-nav__link">
    view_background
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bleed-matrix" class="md-nav__link">
    Bleed Matrix
  </a>
  
    <nav class="md-nav" aria-label="Bleed Matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-bleed-matrix" class="md-nav__link">
    Initial Bleed Matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scaled-k-means" class="md-nav__link">
    Scaled K Means
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_scaled_k_means" class="md-nav__link">
    view_scaled_k_means
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gene-bled-codes" class="md-nav__link">
    Gene Bled Codes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot-product-score" class="md-nav__link">
    Dot Product Score
  </a>
  
    <nav class="md-nav" aria-label="Dot Product Score">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_score" class="md-nav__link">
    view_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gene-efficiency" class="md-nav__link">
    Gene Efficiency
  </a>
  
    <nav class="md-nav" aria-label="Gene Efficiency">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spots-used" class="md-nav__link">
    Spots used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-bled_codes" class="md-nav__link">
    Updating bled_codes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#intensity" class="md-nav__link">
    Intensity
  </a>
  
    <nav class="md-nav" aria-label="Intensity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_intensity" class="md-nav__link">
    view_intensity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#diagnostics" class="md-nav__link">
    Diagnostics
  </a>
  
    <nav class="md-nav" aria-label="Diagnostics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#histogram_score" class="md-nav__link">
    histogram_score
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gene_counts" class="md-nav__link">
    gene_counts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_bleed_matrix" class="md-nav__link">
    view_bleed_matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_bled_codes" class="md-nav__link">
    view_bled_codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_codes" class="md-nav__link">
    view_codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_spot" class="md-nav__link">
    view_spot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#psuedocode" class="md-nav__link">
    Psuedocode
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/setup/notebook/" class="md-nav__link">
        Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/setup/tile_details/" class="md-nav__link">
        Tile Detail
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/setup/file_names/" class="md-nav__link">
        File Names
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Extract
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extract" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Extract
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/deconvolution/" class="md-nav__link">
        Deconvolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/fstack/" class="md-nav__link">
        Fstack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/extract/scale/" class="md-nav__link">
        Scale
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Find Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Find Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Find Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/find_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/find_spots/check_spots/" class="md-nav__link">
        Check Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/find_spots/detect/" class="md-nav__link">
        Detect
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Stitch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Stitch" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Stitch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/shift/" class="md-nav__link">
        Shift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/starting_shifts/" class="md-nav__link">
        Starting Shifts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/tile_origin/" class="md-nav__link">
        Tile Origin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/stitch/check_shifts/" class="md-nav__link">
        Check Shifts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Register
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Register" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Register
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/register/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/register/check_transforms/" class="md-nav__link">
        Check Transforms
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Spot Colors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Spot Colors" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Spot Colors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/spot_colors/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_7">
          Call Spots
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Call Spots" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          Call Spots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/background/" class="md-nav__link">
        Background
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/bleed_matrix/" class="md-nav__link">
        Bleed Matrix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/dot_product/" class="md-nav__link">
        Dot Product
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/call_spots/qual_check/" class="md-nav__link">
        Quality Check
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_8" type="checkbox" id="__nav_4_8" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_8">
          OMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OMP" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          OMP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/omp/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/omp/coefs/" class="md-nav__link">
        Coefficients
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/omp/spots/" class="md-nav__link">
        Spots
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_9" type="checkbox" id="__nav_4_9" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_9">
          Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipeline" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_9">
          <span class="md-nav__icon md-icon"></span>
          Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/run/" class="md-nav__link">
        Run
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/basic_info/" class="md-nav__link">
        Basic Info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/extract_run/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/register_initial/" class="md-nav__link">
        Register Initial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/get_reference_spots/" class="md-nav__link">
        Get Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/call_reference_spots/" class="md-nav__link">
        Call Reference Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/pipeline/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_10" type="checkbox" id="__nav_4_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_10">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_10">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/base/" class="md-nav__link">
        Base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/pciseq/" class="md-nav__link">
        pciSeq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/matlab/" class="md-nav__link">
        Matlab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/morphology/" class="md-nav__link">
        Morphology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/nd2/" class="md-nav__link">
        nd2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/npy/" class="md-nav__link">
        npy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/utils/strel/" class="md-nav__link">
        Strel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_11" type="checkbox" id="__nav_4_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_11">
          Plot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_11">
          <span class="md-nav__icon md-icon"></span>
          Plot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/viewer/" class="md-nav__link">
        Viewer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/raw/" class="md-nav__link">
        Raw
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/extract/" class="md-nav__link">
        Extract
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/find_spots/" class="md-nav__link">
        Find Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/stitch/" class="md-nav__link">
        Stitch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/register/" class="md-nav__link">
        Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/call_spots/" class="md-nav__link">
        Call Spots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/plot/omp/" class="md-nav__link">
        OMP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_12" type="checkbox" id="__nav_4_12" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_12">
          Separate Round Registration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Separate Round Registration" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_12">
          <span class="md-nav__icon md-icon"></span>
          Separate Round Registration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code/sep_round_reg/" class="md-nav__link">
        Sep round reg
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#re-run-call_reference_spots" class="md-nav__link">
    Re-run call_reference_spots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#color-normalisation" class="md-nav__link">
    Color Normalisation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_background" class="md-nav__link">
    view_background
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bleed-matrix" class="md-nav__link">
    Bleed Matrix
  </a>
  
    <nav class="md-nav" aria-label="Bleed Matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-bleed-matrix" class="md-nav__link">
    Initial Bleed Matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scaled-k-means" class="md-nav__link">
    Scaled K Means
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_scaled_k_means" class="md-nav__link">
    view_scaled_k_means
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gene-bled-codes" class="md-nav__link">
    Gene Bled Codes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot-product-score" class="md-nav__link">
    Dot Product Score
  </a>
  
    <nav class="md-nav" aria-label="Dot Product Score">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_score" class="md-nav__link">
    view_score
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gene-efficiency" class="md-nav__link">
    Gene Efficiency
  </a>
  
    <nav class="md-nav" aria-label="Gene Efficiency">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spots-used" class="md-nav__link">
    Spots used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-bled_codes" class="md-nav__link">
    Updating bled_codes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#intensity" class="md-nav__link">
    Intensity
  </a>
  
    <nav class="md-nav" aria-label="Intensity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view_intensity" class="md-nav__link">
    view_intensity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#diagnostics" class="md-nav__link">
    Diagnostics
  </a>
  
    <nav class="md-nav" aria-label="Diagnostics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#histogram_score" class="md-nav__link">
    histogram_score
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gene_counts" class="md-nav__link">
    gene_counts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_bleed_matrix" class="md-nav__link">
    view_bleed_matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_bled_codes" class="md-nav__link">
    view_bled_codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_codes" class="md-nav__link">
    view_codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view_spot" class="md-nav__link">
    view_spot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#psuedocode" class="md-nav__link">
    Psuedocode
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/jduffield65/coppafish/edit/master/docs/pipeline/call_reference_spots.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="call-reference-spots">Call Reference Spots</h1>
<p>The <a href="../../code/pipeline/call_reference_spots/"><em>call reference spots</em> step of the pipeline</a> uses the 
<span class="arithmatex">\(n_{rounds} \times n_{channels}\)</span>  <code>color</code> obtained for each reference spot 
(detected on the reference round/reference channel, <span class="arithmatex">\(r_{ref}\)</span>/<span class="arithmatex">\(c_{ref}\)</span>) in the 
<a href="../get_reference_spots/"><em>get reference spots</em></a> step of the pipeline to compute the <code>bleed_matrix</code>, accounting
for crosstalk between color channels. We then compute the <code>gene_efficiency</code> which allows for varying round
strengths for each gene, before assigning each reference spot to a gene.</p>
<p>These gene assignments are saved in the <a href="../../notebook_comments/#ref_spots"><code>ref_spots</code></a> <em>NotebookPage</em>, 
while the <code>bleed_matrix</code> and expected <code>bled_code</code> for each gene are saved in the 
<a href="../../notebook_comments/#call_spots"><code>call_spots</code></a> <em>NotebookPage</em>. The distribution of the genes can be 
seen using <a href="../../view_results/"><code>coppafish.Viewer</code></a> once these pages have been added.</p>
<div class="admonition note">
<p class="admonition-title">Note: <code>config</code> in this section, with no section specified, means <code>config['call_spots']</code></p>
</div>
<h2 id="re-run-call_reference_spots">Re-run <a href="../../code/pipeline/call_reference_spots/"><code>call_reference_spots</code></a></h2>
<p>To re-run the <a href="../../code/pipeline/call_reference_spots/"><em>call reference spots</em> step of the pipeline</a> 
of the pipeline with different parameters in the configuration file, the 
<a href="../../notebook_comments/#call_spots"><code>call_spots</code></a> page must be
deleted and then the <a href="../../code/pipeline/run/#coppafish.pipeline.run.run_reference_spots"><code>run_reference_spots</code></a> 
function must be called with <code>overwrite_ref_spots = True</code>.</p>
<p>This is so the variables <code>gene_no</code>, <code>score</code>, <code>score_diff</code>, <code>intensity</code> in the 
<a href="../../notebook_comments/#ref_spots"><code>ref_spots</code></a> page will be updated.</p>
<details class="example">
<summary>Example</summary>
<p>The code below illustrates how you can re-run the 
<a href="../../code/pipeline/call_reference_spots/"><em>call reference spots</em> step of the pipeline</a> step
of the pipeline without <a href="#dot-product-score">weighting</a> or <a href="#gene-efficiency"><code>gene_efficiency</code></a>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Code</label><label for="__tabbed_1_2">Output</label><label for="__tabbed_1_3">nb._config (saved to <em>Notebook</em>)</label><label for="__tabbed_1_4"><em>/Users/user/coppafish/experiment/settings_new.ini</em></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">coppafish</span> <span class="kn">import</span> <span class="n">Notebook</span>
<span class="kn">from</span> <span class="nn">coppafish.pipeline.run</span> <span class="kn">import</span> <span class="n">run_reference_spots</span>
<span class="n">nb_file</span> <span class="o">=</span> <span class="s1">&#39;/Users/user/coppafish/experiment/notebook.npz&#39;</span>

<span class="c1"># Save new notebook with different name so it does not overwrite old notebook</span>
<span class="c1"># Make sure notebook_name is specified in [file_names] section </span>
<span class="c1"># of settings_new.ini file to be same as name given here.</span>
<span class="n">nb_file_new</span> <span class="o">=</span> <span class="s1">&#39;/Users/user/coppafish/experiment/notebook_new.npz&#39;</span>
<span class="n">ini_file_new</span> <span class="o">=</span> <span class="s1">&#39;/Users/user/coppafish/experiment/settings_new.ini&#39;</span>

<span class="c1"># config_file not given so will use last one saved to Notebook</span>
<span class="n">nb</span> <span class="o">=</span> <span class="n">Notebook</span><span class="p">(</span><span class="n">nb_file</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;call_spots&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using config file saved to notebook:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alpha: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gene_efficiency_n_iter: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gene_efficiency_n_iter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First 5 gene assignments: </span><span class="si">{</span><span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First 5 spot scores: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bled Code of Gene 0, Round 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Change call_spots</span>
<span class="k">del</span> <span class="n">nb</span><span class="o">.</span><span class="n">call_spots</span>           <span class="c1"># delete old call_spots</span>
<span class="n">nb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nb_file_new</span><span class="p">)</span>        <span class="c1"># save Notebook with no call_spots page to new file </span>
                            <span class="c1"># so does not overwrite old Notebook</span>
<span class="c1"># Load in new notebook with new config file</span>
<span class="n">nb_new</span> <span class="o">=</span> <span class="n">Notebook</span><span class="p">(</span><span class="n">nb_file_new</span><span class="p">,</span> <span class="n">ini_file_new</span><span class="p">)</span>
<span class="n">config_new</span> <span class="o">=</span> <span class="n">nb_new</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;call_spots&#39;</span><span class="p">]</span>
<span class="c1"># Show that config params have changed</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Using new config file but before re-running:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alpha: </span><span class="si">{</span><span class="n">config_new</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gene_efficiency_n_iter: </span><span class="si">{</span><span class="n">config_new</span><span class="p">[</span><span class="s1">&#39;gene_efficiency_n_iter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># Show that ref_spots page variables are still the same</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First 5 gene assignments: </span><span class="si">{</span><span class="n">nb_new</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First 5 spot scores: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">nb_new</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Get new call_spots page</span>
<span class="n">run_reference_spots</span><span class="p">(</span><span class="n">nb_new</span><span class="p">,</span> <span class="n">overwrite_ref_spots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Using new config file after re-running:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alpha: </span><span class="si">{</span><span class="n">config_new</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gene_efficiency_n_iter: </span><span class="si">{</span><span class="n">config_new</span><span class="p">[</span><span class="s1">&#39;gene_efficiency_n_iter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># Show that ref_spots and call_spots page variables have been updated</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First 5 gene assignments: </span><span class="si">{</span><span class="n">nb_new</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">gene_no</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First 5 spot scores: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">nb_new</span><span class="o">.</span><span class="n">ref_spots</span><span class="o">.</span><span class="n">score</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bled Code of Gene 0, Round 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">nb_new</span><span class="o">.</span><span class="n">call_spots</span><span class="o">.</span><span class="n">bled_codes_ge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>Using config file saved to notebook:
alpha: 120.0
gene_efficiency_n_iter: 10
First 5 gene assignments: [17 17 17 13 17]
First 5 spot scores: [0.645 0.806 0.702 0.692 0.796]
Bled Code of Gene 0, Round 0: [ 0.04  0.    0.   -0.    0.   -0.   -0.  ]

Using new config file but before re-running:
alpha: 0.0
gene_efficiency_n_iter: 0
First 5 gene assignments: [17 17 17 13 17]
First 5 spot scores: [0.645 0.806 0.702 0.692 0.796]

Using new config file after re-running:
alpha: 0.0
gene_efficiency_n_iter: 0
First 5 gene assignments: [17 17 17 13 17]
First 5 spot scores: [0.65  0.776 0.744 0.65  0.797]
Bled Code of Gene 0, Round 0: [ 0.25  0.    0.03 -0.    0.01 -0.   -0.  ]
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">[file_names]</span><span class="w"></span>
<span class="na">input_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/raw</span><span class="w"></span>
<span class="na">output_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/output</span><span class="w"></span>
<span class="na">tile_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/tiles</span><span class="w"></span>
<span class="na">round</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Exp1_r0, Exp1_r1, Exp1_r2, Exp1_r3, Exp1_r4, Exp1_r5, Exp1_r6</span><span class="w"></span>
<span class="na">anchor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Exp1_anchor</span><span class="w"></span>
<span class="na">code_book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/codebook.txt</span><span class="w"></span>

<span class="k">[basic_info]</span><span class="w"></span>
<span class="na">is_3d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span><span class="w"></span>
<span class="na">anchor_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">4</span><span class="w"></span>
<span class="na">dapi_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span><span class="w"></span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">[file_names]</span><span class="w"></span>
<span class="na">input_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/raw</span><span class="w"></span>
<span class="na">output_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/output</span><span class="w"></span>
<span class="na">tile_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/tiles</span><span class="w"></span>
<span class="na">round</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Exp1_r0, Exp1_r1, Exp1_r2, Exp1_r3, Exp1_r4, Exp1_r5, Exp1_r6</span><span class="w"></span>
<span class="na">anchor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Exp1_anchor</span><span class="w"></span>
<span class="na">code_book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/Users/user/coppafish/experiment1/codebook.txt</span><span class="w"></span>
<span class="na">notebook_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">notebook_new</span><span class="w"></span>

<span class="k">[basic_info]</span><span class="w"></span>
<span class="na">is_3d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span><span class="w"></span>
<span class="na">anchor_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">4</span><span class="w"></span>
<span class="na">dapi_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span><span class="w"></span>

<span class="k">[call_spots]</span><span class="w"></span>
<span class="na">gene_efficiency_n_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span><span class="w"></span>
<span class="na">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="color-normalisation">Color Normalisation</h2>
<p>We assign a spot <span class="arithmatex">\(s\)</span> to a gene <span class="arithmatex">\(g\)</span>, based on its <span class="arithmatex">\(n_{rounds} \times n_{channels}\)</span> <code>color</code>, <span class="arithmatex">\(\pmb{\acute{\zeta}_s}\)</span>, 
indicating the intensity in each round and channel.</p>
<p>However, we first need to equalize color channels, so that no one color channel dominates the others when 
it comes to gene assignment. The normalised <code>spot_colors</code>, <span class="arithmatex">\(\pmb{\zeta}\)</span>, are obtained by dividing the saved 
<code>spot_colors</code>, <span class="arithmatex">\(\pmb{\acute{\zeta}}\)</span>, by a <span class="arithmatex">\(n_{rounds} \times n_{channels}\)</span> 
normalisation factor, <code>nb.call_spots.color_norm_factor</code>.</p>
<details class="question">
<summary>Why do we need to normalise color channels?</summary>
<p>The gene assignment of the spot below indicates why we need to normalise color channels.
With no normalisation, the gene assignment is overly influenced by channel 4, which 
is one of the most intense channels (see <code>color_norm_factor</code> in example box below). Thus it matches 
to <em>Reln</em> which appears in channel 4 in rounds 0, 1, 5 and 6. It also doesn't care at all about 
channel 2 because it is the weakest channel and <em>Reln</em> does not appear in channel 2 in any rounds.</p>
<p>With normalisation, the most obvious effect is channel 2 gets boosted and now has an influence.
Given that <em>Id2</em> appears in channel 2 in rounds 1, 3, 5 and 6, if channel 2 was never considered,
it would always make the score to <em>Id2</em> low. When we include channel 2 though, we get a high score
even though we are not matching the round 0, channel 4 intensity which contributed to the <em>Reln</em> assignment
without normalisation.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">No Normalisation</label><label for="__tabbed_2_2">With Normalisation</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/spot_color_no_norm.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/spot_color_with_norm.png" width="800" /></p>
</div>
</div>
</div>
</details>
<p>This is <a href="../../code/call_spots/base/#coppafish.call_spots.base.color_normalisation">obtained</a> 
using the parameters <code>config['color_norm_intensities']</code> and 
<code>config['color_norm_probs']</code> such that for each round, <span class="arithmatex">\(r\)</span>, and channel <span class="arithmatex">\(c\)</span>, 
the probability of <span class="arithmatex">\(\zeta_{rc}\)</span> being larger than 
<code>config['color_norm_intensities'][i]</code> is less than <code>config['color_norm_probs'][i]</code> for each <span class="arithmatex">\(i\)</span>.</p>
<p>The probabilities come from the <a href="../extract/#hist_counts">histograms</a> produced in the <em>extract and filter</em> step i.e.
if <code>config['color_norm_intensities'] = 0.5</code> and <code>config['color_norm_probs'] = 0.01</code>, then 
in each round and channel, only 1% of pixels on the mid z-plane across all tiles would have <span class="arithmatex">\(\zeta_{rc} &gt; 0.5\)</span>.</p>
<p>If <code>config[bleed_matrix_method] = 'single'</code>, then we combine all rounds for each channel so that 
<code>nb.call_spots.color_norm_factor[r, c]</code> is the same for all <span class="arithmatex">\(r\)</span> of a particular <span class="arithmatex">\(c\)</span>. </p>
<details class="example">
<summary>Example</summary>
<p>With <code>config['color_norm_intensities'] = 0.5, 1, 5</code> and <code>config['color_norm_probs'] = 0.01, 5e-4, 1e-5</code>
and the <a href="../extract/#hist_counts">histograms</a> shown in the <a href="../extract/#hist_counts"><em>extract and filter</em></a> step, 
the two methods of <code>config[bleed_matrix_method]</code> produce the following <code>color_norm_factor</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Single</label><label for="__tabbed_3_2">Separate</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/color_norm_factor.png" width="500" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/color_norm_factor_sep.png" width="500" /></p>
</div>
</div>
</div>
<p>The <a href="../extract/#hist_counts">normalised histogram</a> shown was normalised using the <em>Single</em> <code>color_norm_factor</code>
and you can see that for each round and channel, there is a similar area under the curve
(probability) beyond <span class="arithmatex">\(\zeta_{rc}=0.5\)</span>, as expected from <code>config['color_norm_intensities']</code>.</p>
</details>
<h2 id="background">Background</h2>
<p>After we have the normalised spot colors, <span class="arithmatex">\(\pmb{\zeta}\)</span>, we 
<a href="../../code/call_spots/background/#coppafish.call_spots.background.fit_background">remove</a> some background <em>genes</em> from them. 
There is one background <em>gene</em> for each channel, <span class="arithmatex">\(\pmb{B}_C\)</span>. The background <em>gene</em> for channel <span class="arithmatex">\(C\)</span> is defined by:
<span class="arithmatex">\(\pmb{B}_{C_{rc}}=1\)</span> if <span class="arithmatex">\(c = C\)</span> and 0 otherwise i.e. it is just a strip in channel <span class="arithmatex">\(C\)</span>:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/background/channel1_background.png" width="300" /></p>
<p>It is also normalised to have an L2 norm of 1. These are saved as <code>nb.call_spots.background_codes</code>.</p>
<details class="question">
<summary>Why do we need to fit background <em>genes</em>?</summary>
<p>We fit the background <em>genes</em> because it is fairly common for <span class="arithmatex">\(\pmb{\zeta}_s\)</span> to have high intensity 
across all rounds of a channel as shown for the example <a href="../../view_results/#c-view_codes"><code>view_codes</code></a> 
plot below:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">No Background Removal</label><label for="__tabbed_4_2">With Background Removal</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/background/thsd7a_spot_no_background_remove.png" width="500" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/background/thsd7a_spot_background_remove.png" width="500" /></p>
</div>
</div>
</div>
<p>No gene in the codebook looks that much like a background gene but if the background genes have not
been fit, as with the first image above, spots like this will match to the gene which has the most 
rounds in the relavent channel/s. Here, <em>Thsd7a</em> has intensity in channel 2 in all rounds apart from round 2.
This problem will be exacerbated in the omp step, because at each iteration of the <a href="../omp/#omp-algorithm"><em>OMP</em></a> 
algorithm, it will just try and fit more and more genes to explain the intense channel.</p>
<p>If we do remove background though, as with the second image, the gene assignment will be based 
on the other channels where not all rounds were intense. In this case, we get a match to <em>Sst</em> due
to round 2 and 3 in channel 0.</p>
<p>If we look at <a href="#histogram_score"><code>histogram_score</code></a> for <em>Thsd7a</em>, we see that without background removal
(purple), the peak in score is significantly larger:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/background/thsd7a_hist.png" width="500" /></p>
<p>This indicates that without background removal, we would end up with a lot more spots assigned to
genes like <em>Thsd7a</em> which have high intensity in most rounds of a single channel.</p>
</details>
<p>The coefficient, <span class="arithmatex">\(\mu_{sC}\)</span>, for the channel <span class="arithmatex">\(C\)</span> background <em>gene</em>, <span class="arithmatex">\(\pmb{B}_C\)</span>, fit to the spot <span class="arithmatex">\(s\)</span> color, 
<span class="arithmatex">\(\pmb{\zeta}_s\)</span> is:</p>
<div class="arithmatex">\[
\mu_{sC} = \frac{\sum_rw^2_{rC}\zeta_{s_{rC}}B_{C_{rC}}}{\sum_rw^2_{rC}B^2_{C_{rC}}}; 
w_{rC} = \frac{1}{|\zeta_{s_{rC}}| + \lambda_b}
\]</div>
<p>Where, <span class="arithmatex">\(\lambda_b\)</span> is <code>config['background_weight_shift']</code> and the sum is over all rounds used.</p>
<details class="note">
<summary>Value of <span class="arithmatex">\(\lambda_b\)</span></summary>
<p>If <code>config['background_weight_shift']</code> is left blank, it is set to the median of the <a href="#intensity"><code>intensity</code></a> 
computed from the absolute colors, <a href="../omp/#initial-intensity-threshold"><span class="arithmatex">\(\tilde{\chi}\)</span></a>, 
of all pixels in the middle z-plane (<code>nb.call_spots.norm_shift_tile</code>) 
of the central tile (<code>nb.call_spots.norm_shift_z</code>).</p>
<p>This is because it gives an estimate of what <span class="arithmatex">\(|\zeta_{s_{rC}}|\)</span> would be for an average non-spot pixel.
If we set <span class="arithmatex">\(\lambda_b\)</span> to be equal to this, it is saying that if a spot had a round and channel with very
low intensity, then that round and channel would have as much influence on the final coefficient
as an average pixel. </p>
<p>If <span class="arithmatex">\(\lambda_b = 0\)</span>, then <span class="arithmatex">\(w_{rc}\)</span> would go to <span class="arithmatex">\(\infty\)</span> for low intensity rounds and channels,
so the value of <span class="arithmatex">\(\lambda_b\)</span> chosen also provides an upper bound on the contribution of low intensity 
rounds and channels to the final coefficient.</p>
</details>
<p>If the weighting, <span class="arithmatex">\(\pmb{w}\)</span>, was a constant across rounds and channels (<span class="arithmatex">\(\lambda_b = \infty\)</span>), this would just be 
the least squares solution. After we have found the coefficients, we remove the background contribution
from the spot colors to give <span class="arithmatex">\(\pmb{\zeta}_{{s0}}\)</span> which we use from now on.</p>
<div class="arithmatex">\[
\zeta_{{s0}_{rC}} = \zeta_{{s}_{rC}} - \mu_{sC}B_{C_{rC}}
\]</div>
<details class="question">
<summary>Why do we need a weighting?</summary>
<p>We find <span class="arithmatex">\(\mu_{sC}\)</span> via weighted least squares, because it limits the influence of outliers. 
The example below shows that with <span class="arithmatex">\(\lambda_b = \infty\)</span> (normal least squares), it really tries to remove
the outlier in round 4, channel 0. The result of this is that all the other rounds of channel 0 become 
very negative.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1"><span class="arithmatex">\(\pmb{\zeta}_s\)</span></label><label for="__tabbed_5_2"><span class="arithmatex">\(\pmb{\zeta}_{s0} (\lambda_b = 0.08)\)</span></label><label for="__tabbed_5_3"><span class="arithmatex">\(\pmb{\zeta}_{s0} (\lambda_b = \infty)\)</span></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/background/view_codes.png" width="600" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/background/view_codes_0_08_weight.png" width="600" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/background/view_codes_infinite_weight.png" width="600" /></p>
</div>
</div>
</div>
<p>This spot should be <em>Slc6a1</em> as shown from the <span class="arithmatex">\(\lambda_b = 0.08\)</span> image, but <em>Slc6a1</em> is expected to be 
in 4 of the 6 rounds that were set to negative by the background fitting with <span class="arithmatex">\(\lambda_b = \infty\)</span>.
Thus, this spot can no longer be assigned to the correct gene after <span class="arithmatex">\(\lambda_b = \infty\)</span> background fitting.</p>
<p>So basically, the job of the background fitting is to remove intensity in a particular channel if 
that channel is intense across all rounds. This is because there are no actual genes which can explain this.
We do not want it to tone down outlier rounds and channels because outliers are usually due to actual genes.</p>
</details>
<h3 id="view_background"><a href="../../code/plot/call_spots/#view_background"><code>view_background</code></a></h3>
<p>The background coefficient calculation can be visualised by using the 
<a href="../../code/plot/call_spots/#view_background"><code>view_background</code></a> function:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/background/thsd7a_background_fit.png" width="800" /></p>
<p>For each plot, each row corresponds to a different background <em>gene</em> coefficient calculation i.e. a different 
channel. There is no overlap between the background codes hence we can view all the calculations at the same time.</p>
<p>Round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span> in the <em>Weighted Dot Product</em> plot refers to the value
of <span class="arithmatex">\(\frac{w^2_{rc}\zeta_{s_{rc}}B_{C_{rc}}}{\sum_rw^2_{rC}B^2_{C_{rC}}}\)</span>. 
The <em>Dot Product</em> plot is the same as the <em>Weighted Dot Product</em> plot except <span class="arithmatex">\(\lambda_b = \infty\)</span>.</p>
<p>The <em>Weighted Coef</em> plot thus shows the coefficient computed for the current value of <span class="arithmatex">\(\lambda_b\)</span> 
(0.08 here, but can be specified in the textbox). The <em>Coef</em> plot shows the coefficient that would
be computed with <span class="arithmatex">\(\lambda_b = \infty\)</span>.</p>
<p>The main difference between the two in this case is that the channel 0 coefficient is much larger for the
<span class="arithmatex">\(\lambda_b = \infty\)</span> case. This is because the <em>Weight Squared</em>, <span class="arithmatex">\(\Omega^2_{s_{rc}}\)</span> term acts to increase the
contribution of the weak round 1, channel 0 and decrease the contribution of the strong rounds: 0, 2, 3 and 6.</p>
<h2 id="bleed-matrix">Bleed Matrix</h2>
<p>Crosstalk can occur between color channels. Some crosstalk may occur due to optical bleedthrough; 
additional crosstalk can occur due to chemical cross-reactivity of probes. The precise degree of crosstalk does not
seem to vary much between sequencing rounds.
It is therefore possible to largely compensate for this crosstalk by learning the precise amount of crosstalk 
between each pair of color channels.</p>
<p>To <a href="../../code/call_spots/bleed_matrix/#coppafish.call_spots.bleed_matrix.get_bleed_matrix">estimate the crosstalk</a>, 
we use the spot colors, <span class="arithmatex">\(\pmb{\zeta}_{s0}\)</span>, of all well isolated spots. We 
reshape these, so we have a set of <span class="arithmatex">\(n_{isolated} \times n_{rounds}\)</span> vectors, each of dimension 
<span class="arithmatex">\(n_{channels}\)</span>, <span class="arithmatex">\(\pmb{v}_i\)</span> (<span class="arithmatex">\(v_{0_c} = \zeta_{{s=0,0}_{r=0,c}}\)</span>).
Only <a href="../find_spots/#isolated-spots">well-isolated</a> spots are used to ensure that crosstalk estimation is 
not affected by spatial overlap of spots corresponding to different genes.</p>
<p>Crosstalk is then estimated by running a 
<a href="../../code/call_spots/bleed_matrix/#coppafish.call_spots.bleed_matrix.scaled_k_means">scaled k-means</a> 
algorithm on these vectors, which finds a set of <span class="arithmatex">\(n_{dyes}\)</span> vectors, <span class="arithmatex">\(\pmb{c}_d\)</span>, such that the error function:</p>
<div class="arithmatex">\[
\sum_i\min_{\lambda_i, d(i)}|\pmb{v}_i - \lambda_i\pmb{c}_{d(i)}|^2
\]</div>
<p>is minimized. In other words, it finds the <span class="arithmatex">\(n_{dyes}\)</span> intensity vectors, <span class="arithmatex">\(\pmb{c}_d\)</span>, each of dimension
<span class="arithmatex">\(n_{channels}\)</span>, such that the spot color of each well isolated spot on every round is close to a scaled version of 
one of them. The <span class="arithmatex">\(n_{dyes} \times n_{channels}\)</span>
array of dye vectors is termed the <code>bleed matrix</code> and is saved as <code>nb.call_spots.bleed_matrix</code> (a <code>bleed_matrix</code> 
is saved for each round, but if <code>config['bleed_matrix_method'] = 'single'</code>, it will be the same for each round).
The <a href="../../view_results/#b-view_bleed_matrix"><code>view_bleed_matrix</code></a> function can be used to show it:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Single Bleed Matrix</label><label for="__tabbed_6_2">Separate Bleed Matrix For Each Round</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/bleed_matrix/single.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/bleed_matrix/separate.png" width="800" /></p>
</div>
</div>
</div>
<p>As shown in the second plot, if <code>config['bleed_matrix_method'] = 'separate'</code>, we compute a different 
<code>bleed_matrix</code> for each round - i.e. we loosen the assumption that crosstalk does not vary between sequencing rounds.</p>
<h3 id="initial-bleed-matrix">Initial Bleed Matrix</h3>
<p>To estimate the dye intensity vectors, <span class="arithmatex">\(\pmb{c}_d\)</span>, the 
<a href="../../code/call_spots/bleed_matrix/#coppafish.call_spots.bleed_matrix.scaled_k_means"><code>scaled_k_means</code></a> algorithm
needs to know the number of dyes and a starting guess for what each dye vector looks like.</p>
<p>This is specified in the <a href="../../config/#basic_info"><code>basic_info</code></a> section of the configuration file as explained 
<a href="../../config_setup/#specifying-dyes">here</a>.</p>
<h3 id="scaled-k-means">Scaled K Means</h3>
<p>The pseudocode for the <a href="../../code/call_spots/bleed_matrix/#coppafish.call_spots.bleed_matrix.scaled_k_means"><code>scaled_k_means</code></a>
algorithm to obtain the dye intensity vectors, <span class="arithmatex">\(\pmb{c}_d\)</span>, is given below:</p>
<p><div class="highlight"><pre><span></span><code>v: Single round intensity vectors of well isolated spots 
   [n_vectors x n_channels]
c: Initial Guess of Bleed Matrix
   [n_dyes x n_channels]
dye_ind_old: [n_vectors] array of zeros.

v_norm = v normalised so each vector has an L2 norm of 1.
Normalise c so that each dye vector has an L2 norm of 1.

i = 0
while i &lt; n_iter:
    score = dot product between each vector in v_norm and each
        dye in c. [n_vectors x n_dyes]
    top_score = highest score across dyes for each vector
        in v_norm. [n_vectors].
    dye_ind = dye corresponding to top_score for each vector
        in v_norm. [n_vectors].

    if dye_ind == dye_ind_old:
        Stop iteration because we have reached convergence
        i.e. i = n_iter
    dye_ind_old = dye_ind

    for d in range(n_dyes):
        v_use = all vectors in v with dye_ind = d and 
            top_score &gt; score_thresh.
            Use un-normalised as to avoid overweighting weak points.
            [n_use x n_channels]
        if n_use &lt; min_size:
            c[d] = 0
        else:
            Update c[d] to be top svd component of v_use i.e.
                v_matrix = v_use.transpose() @ v_use / n_use
                    [n_channels x n_channels]
                c[d] = np.linalg.svd(v_matrix)[0][:, 0]
                    [n_channels]

    i = i + 1    
return c
</code></pre></div>
There are a few parameters in the config file which are used:</p>
<ul>
<li><code>bleed_matrix_n_iter</code>: This is <code>n_iter</code> in the above code.</li>
<li><code>bleed_matrix_min_cluster_size</code>: This is <code>min_size</code> in the above code.</li>
<li><code>bleed_matrix_score_thresh</code>: This is <code>score_thresh</code> in the above code.</li>
<li><code>bleed_matrix_anneal</code>: If this is <code>True</code>, the <code>scaled_k_means</code> algorithm will be run twice.
    The second time will use <span class="arithmatex">\(\pmb{c}_d\)</span> returned from the first run as the starting point,
    and it will have a different <code>score_thresh</code> for each dye. <code>score_thresh</code> for dye <span class="arithmatex">\(d\)</span> 
    will be equal to the median of <code>top_score[dye_ind == d]</code> in the last iteration of the first run.
    The idea is that for the second run, we only use vectors which have a large score,
    to get a more accurate estimate.</li>
</ul>
<h3 id="view_scaled_k_means"><a href="../../code/plot/call_spots/#scaled-k-means"><code>view_scaled_k_means</code></a></h3>
<p>The <a href="../../code/call_spots/bleed_matrix/#coppafish.call_spots.bleed_matrix.scaled_k_means"><code>scaled_k_means</code></a> algorithm 
can be visualised using the <a href="../../code/plot/call_spots/#scaled-k-means"><code>view_scaled_k_means</code></a> function:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/bleed_matrix/scaled_k_means.png" width="800" /></p>
<p>In each column, in the top row, boxplot <span class="arithmatex">\(d\)</span> is for <code>top_score[dye_ind == d]</code> (only showing scores above
<code>score_thresh</code> - 0 for the first two columns). The dye vectors, <span class="arithmatex">\(\pmb{c}_d\)</span>, are indicated in the second
row. The number of vectors assigned to each dye is indicated by the number within each boxplot.</p>
<p>The first column is for the first iteration i.e. with the initial guess of the bleed matrix.
The second column is after the first <code>scaled_k_means</code> algorithm has finished.
The third column is after the second <code>scaled_k_means</code> algorithm has finished (only shown if <code>bleed_matrix_anneal=True</code>).
The bottom whisker of the boxplots in the third column indicate the <code>score_thresh</code> used for each dye.</p>
<p>This is useful for debugging the <code>bleed_matrix</code> computation, as you want the boxplots to show high scores and for those
scores to increase from left to right as the algorithm is run.</p>
<h2 id="gene-bled-codes">Gene Bled Codes</h2>
<p>Once the <code>bleed_matrix</code> has been computed, the expected code for each gene can be 
<a href="../../code/call_spots/base/#coppafish.call_spots.base.get_bled_codes">obtained</a>.</p>
<p>Each gene appears with a single dye in each imaging round as indicated by the <a href="../../config_setup/#code_book">codebook</a>
and saved as <code>nb.call_spots.gene_codes</code>.
<code>bled_code[g, r, c]</code> for gene <span class="arithmatex">\(g\)</span> in round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span> is then given by <code>bleed_matrix[r, c, gene_codes[g, r]]</code>.
If <code>gene_codes[g, r]</code> is outside <code>nb.basic_info.use_dyes</code>, then <code>bled_code[g, r]</code> will be set to 0.</p>
<p>Each <code>bled_code</code> is also normalised to have an L2 norm of 1. They are saved as <code>nb.call_spots.bled_codes</code>.</p>
<details class="example">
<summary>Example</summary>
<p>Using the <em>Single Bleed Matrix</em> shown as an example <a href="#bleed-matrix">earlier</a>, the bled_code
for <em>Kcnk2</em> with <code>gene_code = 6304152</code> is:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/bleed_matrix/bled_code.png" width="800" /></p>
</details>
<h2 id="dot-product-score">Dot Product Score</h2>
<p>To assign spot <span class="arithmatex">\(s\)</span>, with spot color, <span class="arithmatex">\(\pmb{\zeta}_{{si}}\)</span>, to a gene, we compute a dot product
score, <span class="arithmatex">\(\Delta_{sig}\)</span> to each gene, <span class="arithmatex">\(g\)</span>, with <code>bled_code</code> <span class="arithmatex">\(\pmb{b}_g\)</span>. This is 
<a href="../../code/call_spots/dot_product/#coppafish.call_spots.dot_product.dot_product_score">defined</a> to be:</p>
<div class="arithmatex">\[
\Delta_{sig} = \sum_{r=0}^{n_r-1}\sum_{c=0}^{n_c-1}\omega^2_{{si}_{rc}}\tilde{\zeta}_{{si}_{rc}}b_{g_{rc}}
\]</div>
<p>Where:</p>
<div class="arithmatex">\[
\tilde{\zeta}_{{si}_{rc}} = \frac{\zeta_{{si}_{rc}}}
{\sqrt{\sum_{\mathscr{r}=0}^{n_r-1}\sum_{\mathscr{c}=0}^{n_c-1}\zeta^2_{{si}_{\mathscr{rc}}}} + \lambda_d}
\]</div>
<div class="arithmatex">\[
\sigma^2_{{si}_{rc}} = \beta^2 + \alpha\sum_g\mu^2_{sig}b^2_{g_{rc}}
\]</div>
<div class="arithmatex">\[
\omega^2_{{si}_{rc}} = n_rn_c\frac{\sigma^{-2}_{{si}_{rc}}}
{\sum_{\mathscr{r}=0}^{n_r-1}\sum_{\mathscr{c}=0}^{n_c-1}\sigma^{-2}_{{si}_{\mathscr{rc}}}}
\]</div>
<ul>
<li><span class="arithmatex">\(n_{r}\)</span> is the number of rounds.</li>
<li><span class="arithmatex">\(n_{c}\)</span> is the number of channels.</li>
<li><span class="arithmatex">\(\lambda_d\)</span> is <code>config['dp_norm_shift'] * sqrt(n_rounds)</code> (typical <code>config['dp_norm_shift']</code> is 0.1).</li>
<li><span class="arithmatex">\(\alpha\)</span> is <code>config['alpha']</code> (<em>default is 120</em>).</li>
<li><span class="arithmatex">\(\beta\)</span> is <code>config['beta']</code> (<em>default is 1</em>).</li>
<li>The sum over genes, <span class="arithmatex">\(\sum_g\)</span>, is over all real and background genes i.e. <span class="arithmatex">\(\sum_{g=0}^{n_g+n_c-1}\)</span>.
<span class="arithmatex">\(\mu_{sig=n_g+C} = \mu_{sC} \forall i\)</span> and <span class="arithmatex">\(\pmb{b}_{g=n_g+C} = \pmb{B}_C\)</span> where <span class="arithmatex">\(\mu_{sC}\)</span> and <span class="arithmatex">\(\pmb{B}_C\)</span>
were introduced in the <a href="#background">background</a> section.</li>
<li><span class="arithmatex">\(i\)</span> refers to the number of actual genes fit prior to this iteration of <em>OMP</em>. Here, because we are
only fitting one gene, <span class="arithmatex">\(i=0\)</span>, meaning only background has been fit (<span class="arithmatex">\(\sum_{g=0}^{n_g-1}\mu^2_{sig}b^2_{g_{rc}}=0\)</span>).</li>
</ul>
<p>So if <span class="arithmatex">\(\lambda_d = 0\)</span> and <span class="arithmatex">\(\pmb{\omega}^2_{si}=1\)</span> for each round and channel (achieved through <span class="arithmatex">\(\alpha=0\)</span>), then 
this would just be the normal dot product between two vectors with L2 norm of one. 
The min value is 0 and max value is 1. </p>
<p>The purpose of the weighting, <span class="arithmatex">\(\pmb{\omega}^2_{{si}}\)</span>, is to decrease the contribution of rounds/channels 
which already have a gene in. It is really more relevant to the 
<a href="../omp/#weighting-in-dot-product-score"><em>OMP</em> algorithm</a>. 
It can be turned off in this part of the pipeline by setting
<code>config['alpha'] = 0</code>. The <span class="arithmatex">\(n_rn_c\)</span> term at the start of the <span class="arithmatex">\(\omega^2_{{si}_{rc}}\)</span> equation is a normalisation
term such that the max possible value of <span class="arithmatex">\(\Delta_{sig}\)</span> is approximately 1 (it can be more though).</p>
<details class="note">
<summary>Value of <span class="arithmatex">\(\lambda_d\)</span></summary>
<p>If in the <span class="arithmatex">\(\Delta_{sig}\)</span> equation, we used <span class="arithmatex">\(\pmb{\zeta}_{{si}}\)</span> instead of <span class="arithmatex">\(\pmb{\tilde{\zeta}}_{{si}}\)</span>,
then the max value would no longer have an upper limit and a high score could be achieved by having 
large values of <span class="arithmatex">\(\pmb{\zeta}_{{si}}\)</span> in some rounds and channels as well as by having <span class="arithmatex">\(\pmb{\zeta}_{{si}}\)</span>
being similar to <span class="arithmatex">\(\pmb{b}_g\)</span>. </p>
<p>We use the <a href="#intensity">intensity</a> value to indicate the strength of the spot, so for <span class="arithmatex">\(\Delta_{sig}\)</span>, we 
really just want a variable which indicates how alike the spot color is to the gene, indepenent of
strength. Hence, we use <span class="arithmatex">\(\pmb{\tilde{\zeta}}_{{si}}\)</span>.</p>
<p>If <span class="arithmatex">\(\lambda_d = 0\)</span>, it would mean that even background pixels with very small intensity could get a high score.
So, we use a non-zero value of <span class="arithmatex">\(\lambda_d\)</span> to prevent very weak spots getting a large <span class="arithmatex">\(\Delta_{sig}\)</span>.</p>
<p>If <code>config['dp_norm_shift']</code> is not specified, it is set to the median of the L2 norm in a single round
computed from the colors of all pixels in the middle z-plane 
(<code>nb.call_spots.norm_shift_tile</code>) of the central tile (<code>nb.call_spots.norm_shift_z</code>).</p>
<p>The idea behind this, is that the L2 norm of an average background pixel would be 
<code>config['dp_norm_shift'] * sqrt(n_rounds)</code>. So if <span class="arithmatex">\(\lambda_d\)</span> was set to this, it is giving 
a penalty to any spot which is less intense than the average background pixel. This is 
desirable since any pixels of such low intensity are unlikely to be spots.</p>
</details>
<p>The spot <span class="arithmatex">\(s\)</span>, is assigned to the gene <span class="arithmatex">\(g\)</span>, for which <span class="arithmatex">\(\Delta_{sig}\)</span> is the largest.</p>
<h3 id="view_score"><a href="../../code/plot/call_spots/#view_score"><code>view_score</code></a></h3>
<p>How the various parameters in the dot product score calculation affect the final value can be investigated,
for a single spot, through the function <a href="../../code/plot/call_spots/#view_score"><code>view_score</code></a>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1"><code>view_score</code></label><label for="__tabbed_7_2"><code>view_weight</code></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/view_score.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/view_weight.png" width="800" /></p>
</div>
</div>
</div>
<ul>
<li>The top left plot shows the spot color prior to any removal of genes or background.</li>
<li>The bottom left plot shows the spot color after all genes fit prior to the current iteration have been removed
(just background for iteration 0).</li>
<li>The top right plot shows the dot product score obtained without weighting (<span class="arithmatex">\(\alpha=0\)</span>).</li>
<li>The bottom right plot shows the actual score obtained with the current weighting parameters.</li>
<li>To get to the gene with the highest dot product score for the current iteration, you can enter an impossible value
in the <em>Gene</em> textbox. As well as typing the index of the gene, you can also type in the gene name to 
look at the calculation for a specific gene.</li>
<li>Clicking on the <em>Weight Squared</em> plot shows the <a href="../../code/plot/call_spots/#view_weight"><code>view_weight</code></a> 
plot indicating how it is calculated (second image above). 
<a href="../omp/#view_weight">This is more useful for iterations other than 0</a>.</li>
</ul>
<p>Looking at the <code>view_weight</code> image and the far right plots of the <code>view_score</code> image, 
we see that the effect of the weighting is to down-weight color channel 0 because this is where the background
coefficient is the largest. The channels with a smaller background coefficient (1, 5 and 6) then have 
a weighting greater than 1. Thus, the weighted score is greater than the non-weighted one because
channel 6, where this spot is particularly strong has a greater contribution.
I.e. because the intensity in channel 6 cannot be explained by background genes, but it can be explained by Plp1, 
we boost the score. For most spots, the background coefficients are very small and so the weighting has little effect.</p>
<p>Using the <a href="#histogram_score"><code>histogram_score</code></a> function, we see that the effect of weighting (blue) is to 
add a tail of scores greater than 1 for spots where an increased contribution is given to the rounds/channels
where they are most intense. The mode score does not change though:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/hist_weight.png" width="800" /></p>
<h2 id="gene-efficiency">Gene Efficiency</h2>
<p>Once we have a <a href="#dot-product-score">score</a> and gene assigned to each spot, we can update the <code>bled_codes</code>
for each gene, <span class="arithmatex">\(\pmb{b}_g\)</span> based on all the spot colors assigned to them, <span class="arithmatex">\(\pmb{\zeta}_{{s0}}\)</span>. 
We do this by determining <code>nb.call_spots.gene_efficiency</code>. <code>gene_efficiency[g, r]</code> gives the expected intensity
of gene <span class="arithmatex">\(g\)</span> in round <span class="arithmatex">\(r\)</span>, as determined by the spots assigned to it, compared to that expected by the <code>bleed_matrix</code>.</p>
<p>The pseudocode below explains how it is <a href="../../code/call_spots/base/#coppafish.call_spots.base.get_gene_efficiency">computed</a>.</p>
<p><div class="highlight"><pre><span></span><code>spot_colors: Intensity of each spot in each channel
    [n_spots x n_rounds x n_channels]
spot_gene_no: Gene each spot was assigned to.
    [n_spots]
bm: Bleed Matrix, indicates expected intensity of each
    dye in each round and channel.
    [n_rounds x n_channels x n_dyes]
gene_codes: Indicates dye each gene should appear with in each round.
    [n_genes x n_rounds]

for g in range(n_genes):
    Only use spots assigned to current gene.
        use = spot_gene_no == g

    for r in use_rounds:
        Get bleed matrix prediction for strength of gene g in round r.
            bm_pred = bm[r, :, gene_codes[g, r]]
            [n_channels]
        Get spot colors for this round.
            spot_colors_r = spot_colors[use, r]
            [n_use x n_channels]
        For each spot, s, find the least squares coefficient, coef, such that
            spot_colors_r[s] = coef * bm_pred
    Store coef for each spot and round as spot_round_strength
        [n_use x n_rounds]

    for r in use_rounds:
        av_round_strength[r] = median(spot_round_strength[:, r])
    Find av_round which is the round such that av_round_strength[av_round]
        is the closest to median(av_round_strength).

    Update spot_round_strength to only use spots with positive strength in
        av_round.
        keep = spot_round_strength[:, av_round] &gt; 0
        spot_round_strength = spot_round_strength[keep]
        [n_use2 x n_rounds]

    For each spot, determine the strength of each round relative to av_round.
    for s in range(n_use2):
        for r in use_rounds:
            relative_round_strength[s, r] = spot_round_strength[s, r] /
                                            spot_round_strength[s, av_round]

    Update relative_round_strength based on maximum value.
        max_round_strength is max of relative_round_strength for 
            each spot across rounds [n_use2].
        keep = max_round_strength &lt; max_thresh
        relative_round_strength = relative_round_strength[keep]
        [n_use3 x n_rounds]

    Update relative_round_strength based on low values.
        Count number of rounds for each spot below min_thresh.
        for s in range(n_use3):
            n_min[s] = sum(relative_round_strength[s] &lt; min_thresh)
        keep = n_min &lt;= n_min_thresh
        relative_round_strength = relative_round_strength[keep]
        [n_use4 x n_rounds]

    for r in use_rounds:
        if n_use4 &gt; min_spots:
            gene_efficiency[g, r] = median(relative_round_strength[:, r])
        else:
            Not enought spots to compute gene efficiency so just set to 1 in 
                every round.
                gene_efficiency[g, r] = 1    

Clip negative gene efficiency at 0.
    gene_efficiency[gene_efficiency &lt; 0] = 0  
return gene_efficiency         
</code></pre></div>
There are a few parameters in the <a href="../../config/#call_spots">configuration file</a> which are used:</p>
<ul>
<li><code>gene_efficiency_max</code>: This is <code>max_thresh</code> in the above code.</li>
<li><code>gene_efficiency_min</code>: This is <code>min_thresh</code> in the above code.</li>
<li><code>gene_efficiency_min_factor</code>: <code>n_min_thresh</code> in the above code is set to 
<code>ceil(gene_efficiency_min_factor * n_rounds)</code>.</li>
<li><code>gene_efficiency_min_spots</code>: This is <code>min_spots</code> in the above code.</li>
</ul>
<p>In the gene_efficiency calculation, we computed the strength of each spot relative to <code>av_round</code>
because, as with the <code>bleed_matrix</code> calculation, we expect each spot color to be a scaled version of
one of the <code>bled_codes</code>. So we are trying to find out, once a spot color has been normalised such that its strength
in <code>av_round</code> is 1, what is the corresponding strength in the other rounds. We do this normalisation
relative to the average round so that half the <code>gene_efficiency</code> values will be more than 1 and half less than 1
for each gene. For gene <span class="arithmatex">\(g\)</span>, one value of <code>gene_efficiency[g]</code> will be 1, corresponding to <code>av_round</code>
but this round will be different for each gene.</p>
<details class="question">
<summary>Why do we need <code>gene_efficiency</code>?</summary>
<p>We need <code>gene_efficiency</code> because there is a high variance in the strength with which each gene appears in
each round.
For example, in the the <code>bled_code</code> plot below, we see that the effect of incorporating gene_efficiency
is to reduce the strength of rounds 0, 5 and 6 while boosting rounds 2 and 3.</p>
<details class="note">
<summary>Note</summary>
<p>In the example below, it seems that rounds corresponding to the same dye (0 and 5; 1 and 4; 2 and 3) 
have similar strengths, so it may be that different dyes (instead of rounds) 
have different strengths for different genes.</p>
</details>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1"><code>bled_code</code></label><label for="__tabbed_8_2">histogram</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/ge/serpini1_bled_code.png" width="600" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/ge/serpini1_hist.png" width="600" /></p>
</div>
</div>
</div>
<p>The <a href="#histogram_score">histogram</a> plot above then shows that when gene efficiency is included (blue line), 
the score distribution is shifted considerably. 
This indicates that gene efficiency is required to truly capture what
spot colors corresponding to <code>Serpini1</code> look like.</p>
<p>The <a href="#histogram_score"><code>histogram_score</code></a> plot combining all genes, also shows a shift in the peak 
of the distribution towards higher scores when gene efficiency is included:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/ge/hist_ge.png" width="600" /></p>
</details>
<h3 id="spots-used">Spots used</h3>
<p>Because we use the <code>gene_efficiency</code> to update the <code>bled_codes</code>, we only want to use spots, which we
are fairly certain have been assigned to the correct gene. Thus, only spots which satisfy all the following
are used in the <code>gene_efficiency</code> calculation:</p>
<ul>
<li>Like with the <a href="#bleed-matrix"><code>scaled_k_means</code></a> calculation, only spots identified as <a href="../find_spots/#isolated-spots">isolated</a> 
in the <em>find spots</em> step of the pipeline are used.</li>
<li>The dot product score to the best gene, <span class="arithmatex">\(g_0\)</span>, <span class="arithmatex">\(\Delta_{s0g_0}\)</span> must exceed <code>config['gene_efficiency_score_thresh']</code>.</li>
<li>The difference between the dot product score to the best gene, <span class="arithmatex">\(g_0\)</span>, and the second best gene, <span class="arithmatex">\(g_1\)</span>:
<span class="arithmatex">\(\Delta_{s0g_0}-\Delta_{s0g_1}\)</span> must exceed <code>config['gene_efficiency_score_diff_thresh']</code>.</li>
<li>The <a href="#intensity">intensity</a>, <span class="arithmatex">\(\chi_s\)</span>, must exceed <code>config['gene_efficiency_intensity_thresh']</code>.</li>
</ul>
<details class="note">
<summary>Value of <code>config['gene_efficiency_intensity_thresh']</code></summary>
<p>If <code>config['gene_efficiency_intensity_thresh']</code> is not specified, 
it is set to the percentile indicated by <code>config['gene_efficiency_intensity_thresh_percentile']</code> 
of the <a href="#intensity"><code>intensity</code></a> 
computed from the colors of all pixels in the middle z-plane 
(<code>nb.call_spots.norm_shift_tile</code>) of the central tile (<code>nb.call_spots.norm_shift_z</code>).</p>
<p>It is then clipped to be between <code>config[gene_efficiency_intensity_thresh_min]</code> and 
<code>config[gene_efficiency_intensity_thresh_max]</code>.</p>
<p>The idea is that this is quite a low threshold (default percentile is 37), 
just ensuring that the intensity is not amongst the weakest background pixels. If the intensity
threshold was too high, we would end up losing spots which look a lot like genes just
because they are weak. But if it was too low, we would identify some background pixels as genes.</p>
</details>
<h3 id="updating-bled_codes">Updating <code>bled_codes</code></h3>
<p>Once the <code>gene_efficiency</code> has been computed, the <code>bled_codes</code> can be updated:</p>
<div class="highlight"><pre><span></span><code>bled_codes: Those computed from the bleed_matrix
    [n_genes x n_rounds x n_channels].
gene_efficiency: [n_genes x n_rounds]

for g in range (n_genes):
    for r in use_rounds:
        for c in use_channels:
            bled_codes[g, r, c] = bled_codes[g, r, c] * gene_efficiency[g, r]
    Normalise bled_codes[g] so it has an L2 norm of 1.
</code></pre></div>
<p>We then re-compute the <a href="#dot-product-score">dot product score</a> and gene assignment 
for each spot with the new <code>bled_codes</code>. We continue this process of computing the gene efficiency, 
updating the <a href="#dot-product-score">dot product score</a> until the same spots
have been used to compute the gene efficiency in two subsequent iterations or until
<code>config[gene_efficiency_n_iter]</code> iterations have been run.</p>
<p>The <code>bled_codes</code> computed from the final iteration will be saved as <code>nb.call_spots.bled_codes_ge</code>. This will
be the same as <code>nb.call_spots.bled_codes</code> if <code>config[gene_efficiency_n_iter] = 0</code>.
These are the ones used to compute dot product score to the best gene, <span class="arithmatex">\(g_0\)</span>, <span class="arithmatex">\(\Delta_{s0g_0}\)</span>.
These are saved as <code>nb.ref_spots.gene_no</code> and <code>nb.ref_spots.score</code> respectively.
The difference between the dot product score to the best gene, <span class="arithmatex">\(g_0\)</span>, and the second best gene, <span class="arithmatex">\(g_1\)</span>:
<span class="arithmatex">\(\Delta_{s0g_0}-\Delta_{s0g_1}\)</span> is saved as <code>nb.ref_spots.score_diff</code>.</p>
<h2 id="intensity">Intensity</h2>
<p>As well as a variable indicating how closely a spot matches a gene (<code>nb.ref_spots.score</code>), we also save 
a variable indicating the overall fluorescence of a spot, independent of which gene it belongs to. This intensity,
<span class="arithmatex">\(\chi\)</span>, is saved as <code>nb.ref_spots.intensity</code> and for a spot <span class="arithmatex">\(s\)</span>, it is 
<a href="../../code/call_spots/qual_check/#coppafish.call_spots.qual_check.get_spot_intensity">defined</a> by:</p>
<div class="arithmatex">\[
\chi_s = \underset{r}{\mathrm{median}}(\max_c\zeta_{s_{rc}})
\]</div>
<p>I.e. for each round, we take the max color across channels to give a set of <span class="arithmatex">\(n_{rounds}\)</span> values.
We then take the median of these. </p>
<p>The logic behind this is that if the spot is actually a gene, then
there should be at least one channel in every round which is intense, because the relevant dye shows up in it.
If the spot was not actually a gene though, you would expect all channels in any given round 
to be similarly weakly intense and thus the max over channels would give a low value.</p>
<h3 id="view_intensity"><a href="../../code/plot/call_spots/#view_intensity"><code>view_intensity</code></a></h3>
<p>The intensity calculation can be visualised with the <a href="../../code/plot/call_spots/#view_intensity"><code>view_intensity</code></a>
function:</p>
<p><img alt="image" src="../../images/pipeline/call_spots/view_intensity.png" width="600" /></p>
<p><span class="arithmatex">\(\chi_s = 0.542\)</span> for this example spot, which is the median of all the values shown with a green border.</p>
<h2 id="diagnostics">Diagnostics</h2>
<p>As well as <a href="#view_background"><code>view_background</code></a>, <a href="#view_scaled_k_means"><code>view_scaled_k_means</code></a>, 
<a href="#view_score"><code>view_score</code></a> and <a href="#view_intensity"><code>view_intensity</code></a>, 
there are a few other functions using matplotlib which may help to debug this section of the pipeline.</p>
<h3 id="histogram_score"><a href="../../code/plot/omp/#histogram_score"><code>histogram_score</code></a></h3>
<p>This shows the histogram of the <a href="#dot-product-score">dot product score</a>, <span class="arithmatex">\(\Delta_s\)</span>, 
assigned to every reference spot:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:2"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">Dot Product Score</label><label for="__tabbed_9_2">All Plots</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/hist.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/hist_all.png" width="800" /></p>
</div>
</div>
</div>
<p>This is useful for checking how well the gene assignment worked. The higher the score where the distribution 
peaks, the better. Certainly, if the peak is around 0.8, as with this example, then it probably worked well.</p>
<p>The <em>Dot Product Score</em> image above is showing the histogram of <code>nb.ref_spots.score</code>, but there are 4 other plots 
which can be selected, as shown in the <em>All Plots</em> image above:</p>
<ul>
<li><em>No Weighting</em>: This is the score that would be computed if <span class="arithmatex">\(\alpha=0\)</span> in the 
<a href="#dot-product-score">dot product score calculation</a>. The max possible score in this case is 1.</li>
<li><em>No Background</em>: This is the score that would be computed if the <a href="#background">background</a> <em>genes</em> were not removed
before determining the score. This also has no weighting because in the dot product calculation, 
<span class="arithmatex">\(\omega^2_{si_{rc}} = 1\)</span> if no background has been fitted. Hence, the max score is 1 as with <em>No Weighting</em>.</li>
<li><em>No Gene Efficiency</em>: This is the score that would be computed if the <code>nb.call_spots.bled_codes</code>
were used instead of <code>nb.call_spots.bled_codes_ge</code>. <span class="arithmatex">\(\omega^2_{si_{rc}} \neq 1\)</span> here so the max score is over 1.</li>
<li><em>No Background / No Gene Efficiency</em>: This is the score that would be computed if the <a href="#background">background</a> 
<em>genes</em> were not removed before determining the score and if <code>nb.call_spots.bled_codes</code>
were used instead of <code>nb.call_spots.bled_codes_ge</code>. The max score is 1 in this case.</li>
</ul>
<p>The <em>Gene</em> textbox can also be used to view the histogram of a single gene. Either the index of the gene
or the gene name can be entered. To go back to viewing all genes, type in <em>all</em> into the textbox.</p>
<p>The Histogram Spacing textbox can be used to change the bin size of the histogram.</p>
<h3 id="gene_counts"><a href="../../code/plot/call_spots/#gene_counts"><code>gene_counts</code></a></h3>
<p>This plot indicates the number of spots assigned to each gene which also have <code>nb.ref_spots.score &gt; score_thresh</code>
and <code>nb.ref_spots.intensity &gt; intensity_thresh</code>. The default <code>score_thresh</code> and <code>intensity_thresh</code> 
are <code>config['thresholds']['score_ref']</code> and <code>config['thresholds']['intensity']</code> respectively. They can be changed
with the textboxes though. This 
<a href="../../code/call_spots/qual_check/#coppafish.call_spots.qual_check.quality_threshold">thresholding</a> 
is the same that is done in the <a href="../../view_results/#score-range">results <code>Viewer</code></a> 
and when <a href="../../code/utils/pciseq/">exporting to <em>pciSeq</em></a>. </p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:2"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">Gene Counts</label><label for="__tabbed_10_2">Gene Counts with Fake Genes</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/gene_counts/gene_count.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/gene_counts/gene_count_fake.png" width="800" /></p>
</div>
</div>
</div>
<p>There is also a second <em>Ref Spots - Fake Genes</em> plot which can be shown in yellow. This shows the results 
of the gene assignment if we added some fake <code>bled_codes</code> as well as the ones corresponding to genes.
The idea is to choose fake <code>bled_codes</code> which are well separated from the actual <code>bled_codes</code>. If spots then match to
these fake genes, then it probably means the initial gene assignment is not reliable.</p>
<p>The fake <code>bled_codes</code> can be specified, but by default there is one fake <code>bled_code</code> added for each round, <span class="arithmatex">\(r\)</span>, and
channel <span class="arithmatex">\(c\)</span>, which is 1 in round <span class="arithmatex">\(r\)</span>, channel <span class="arithmatex">\(c\)</span> and 0 everywhere else. In the second image above, we see that 
there is not much change in the gene counts when we add the fake genes, indicating the initial assignment is probably
reliable.</p>
<details class="example">
<summary>Example Dataset with lots of <em>Fake Genes</em></summary>
<p>The example below indicates a case where the fake genes functionality may be useful.</p>
<p>When we open <code>coppafish.Viewer</code>, we see that there seems to be too many spots assigned to <em>Penk</em> and 
<em>Vip</em>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:4"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><input id="__tabbed_11_2" name="__tabbed_11" type="radio" /><input id="__tabbed_11_3" name="__tabbed_11" type="radio" /><input id="__tabbed_11_4" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1"><code>coppafish.Viewer</code></label><label for="__tabbed_11_2"><code>gene_counts</code></label><label for="__tabbed_11_3"><em>Penk</em></label><label for="__tabbed_11_4"><em>Vip</em></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/gene_counts/fake_iss_plot.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/gene_counts/fake_gene_counts.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/gene_counts/fake_penk.png" width="800" /></p>
</div>
<div class="tabbed-block">
<p><img alt="image" src="../../images/pipeline/call_spots/gene_counts/fake_vip.png" width="800" /></p>
</div>
</div>
</div>
<p>If we then look at the <code>gene_counts</code>, we see that when we include fake genes, the number of spots
assigned to <em>Penk</em> and <em>Vip</em> decreases drastically because they have been assigned to the <span class="arithmatex">\(r0c18\)</span> fake gene.</p>
<p>When we look at the <em>Penk</em> and <em>Vip</em> <code>bled_codes</code>, we see that they are very intense in round 0, channel 18.
So most spots seem to only have been assigned to these genes on the basis of this one round and channel.</p>
</details>
<h3 id="view_bleed_matrix"><a href="../../code/plot/call_spots/#view_bleed_matrix"><code>view_bleed_matrix</code></a></h3>
<p><a href="../../view_results/#b-view_bleed_matrix">This function</a> is useful for seeing if the dye vectors in the 
<code>bleed_matrix</code> are easily distinguished.</p>
<h3 id="view_bled_codes"><a href="../../code/plot/call_spots/#view_bled_codes"><code>view_bled_codes</code></a></h3>
<p><a href="../../view_results/#g-view_bled_codes">This function</a> is useful for seeing how the <code>gene_efficiency</code> 
affected the <code>bled_codes</code>.</p>
<h3 id="view_codes"><a href="../../code/plot/call_spots/#view_codes"><code>view_codes</code></a></h3>
<p><a href="../../view_results/#c-view_codes">This function</a> is useful for seeing how a particular spot matches
the gene it was assigned to.</p>
<h3 id="view_spot"><a href="../../code/plot/call_spots/#view_spot"><code>view_spot</code></a></h3>
<p><a href="../../view_results/#s-view_spot">This function</a> is useful for seeing if the neighbourhood of a  particular spot 
has high intensity in all rounds/channels where the gene it was assigned, expects it to.</p>
<h2 id="psuedocode">Psuedocode</h2>
<p>This is the pseudocode outlining the basics of this <a href="../../code/pipeline/call_reference_spots/">step of the pipeline</a>.
There is more detailed pseudocode about how the <a href="#scaled-k-means"><code>bleed_matrix</code></a> and 
<a href="#gene-efficiency"><code>gene_efficiency</code></a> are found.</p>
<div class="highlight"><pre><span></span><code>Determine color_norm_factor from nb.extract.hist_counts
    [n_rounds x n_channels]

Load in pixel colors of all pixel of middle z-plane of
    central tile. Use these to determine the following
    if not provided in the config file:
    - nb.call_spots.background_weight_shift    
    - nb.call_spots.dp_norm_shift
    - nb.call_spots.gene_efficiency_intensity_thresh
    - nb.call_spots.abs_intensity_percentile

Normalise reference spot colors
    spot_colors = nb.ref_spots.colors / color_norm_factor
    [n_spots x n_rounds x n_channels]

Compute Spot Intensity  (nb.ref_spots.intensity)
Remove Background from spot_colors
Compute Bleed Matrix    (nb.call_spots.bleed_matrix)
Compute Bled Codes      (nb.call_spots.bled_codes)

use_ge_last = array of length n_spots where all values are False.
i = 0
while i &lt; gene_efficiency_n_iter:
    Determine all_scores, the dot product score of each spot to 
        each bled_code.
        [n_spots x n_genes]
    Determine gene_no, the gene for which all_scores is the greatest
        for each spot.
        [n_spots]
    Determine score, the score in all_scores, corresponding to gene_no
        for each spot.
        [n_spots]
    Determine score_diff, the difference between score and the second 
        largest value in all_scores for each spot.
        [n_spots]
    Determine whether each spot was used for gene efficiency calculation.
        use_ge = score &gt; ge_score_thresh            and 
                 score_diff &gt; ge_score_diff_thresh  and 
                 intensity &gt; ge_intensity_thresh    and 
                 nb.ref_spots.isolated.
        [n_spots]
    Compute gene_efficiency with spots indicated by use_ge
    Update bled_codes based on gene_efficiency   
    If use_ge == use_ge_last:
        End iteration i.e. i = gene_efficiency_n_iter
    use_ge_last = use_ge
    i += 1

Save final bled_codes as        nb.call_spots.bled_codes_ge
Save final gene_efficiency as   nb.call_spots.gene_efficiency
Save final gene_no as           nb.ref_spots.gene_no
Save final score as             nb.ref_spots.score
Save final score_diff as        nb.ref_spots.score_diff              
</code></pre></div>




              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../get_reference_spots/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Get Reference Spots" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Get Reference Spots
            </div>
          </div>
        </a>
      
      
        
        <a href="../omp/" class="md-footer__link md-footer__link--next" aria-label="Next: OMP" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              OMP
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://github.com/jduffield65/coppafish" target="_blank" rel="noopener" title="Github Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.expand", "content.tabs.link", "navigation.sections", "navigation.top"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>